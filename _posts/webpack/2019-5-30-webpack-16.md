---
layout: post
title: webpack 浏览器缓存(16)
tagline: webpack教程
category: webpack      #分类
author: wali    #作者
tag: webpack     #标签
ghurl:      #github url
ghurl_zip:  #github zip下载
comments: true
post_nav: []
group_tag: webpack4.x 教程
---

小菜之前写过关于浏览器是如何缓存的[nginx 缓存](/nginx/2018/12/14/nginx-11.html "/nginx/2018/12/14/nginx-11.html"){:target="_blank"},感兴趣的小伙伴们可以看看。在前面小菜写的配置都是如何去缓存

```javascript
//build/output.js

const srcPath = require('./base/path');
const config = require('./base/config');

let output = {
	path: srcPath.dist,
	filename: '[name].[hash].js',
	publicPath: config.publicPath
}

module.exports = output;
```

如果`output.js`中这样写`filename:'[name].[hash].js'`，每次打包都会重新生成js文件(文件名不重名)，上传到服务器，用户在客户端上刷新都会重新从服务器上拉取js文件，这样就会造成请求资源浪费。


# 1.演示

#### 安装loadsh

之前没有安装过loadsh库伙伴需要安装一下

```
yarn add loadsh
```


#### index.js

```javascript
import _ from 'loadsh';

let arr = ['hello','world'];

let str = _.join(arr,'--');
console.log(str)
```

#### 编译webpack

```
yarn run prod
```

![ssl](http://walidream.com:9999/blogImage/webpack/webpack_36.png)

#### 修改index.js

```diff
import _ from 'loadsh';

+  let arr = ['hello','wali'];

let str = _.join(arr,'--');
console.log(str)
```

#### 编译webpack

```
yarn run prod
```
![ssl](http://walidream.com:9999/blogImage/webpack/webpack_37.png)

从上面两个截图可以发现，当我们修改index.js文件的代码后，重新打包生成`main.js`和`vendors~main`后面的hash值变了。因为我们修改`index.js`文件的代码，在`index.js`中引用的第三方库文件，`loadsh`是不需修改的,所以打包后我们希望`mian.js`的hash值变，而`vendors~main`的hash值不变。


# 2.配置webpack

为了实现上面的功能，我们需要对webpack配置做一些改变

#### build/output.js

```diff
const dirPath = require('./base/path');
const config = require('./base/config');

let output = {
	path:dirPath.dist,
+	filename: config.NODE_ENV == 'development'?'[name].js':'[name].[contenthash].js',
+	chunkFilename: config.NODE_ENV == 'development'?'[name].js':'[name].[contenthash].js',
	publicPath: config.publicPath
}

module.exports = output
```

#### build/optimization.js

```diff
let optimization = {
	usedExports: true,
	splitChunks: {
		chunks: 'all',
		minSize: 30000,
		maxSize: 0,
		minChunks: 1,
		maxAsyncRequests: 5,
		maxInitialRequests: 3,
		automaticNameDelimiter: '~',
		name: true,
		cacheGroups: {
			vendors: {
				test: /[\\/]node_modules[\\/]/,
				priority: -10
			},
			default: {
				minChunks: 2,
				priority: -20,
				reuseExistingChunk: true
			}
		}
	},
+	runtimeChunk:{
+		name: entrypoint => `runtimechunk~${entrypoint.name}`
+	}
}

module.exports = optimization
```

#### build/plugins.js

```diff
const dirpath = require('./base/path');
const config = require('./base/config');

const webpack = require('webpack');
const HtmlWebpackPlugin = require('html-webpack-plugin');    //生成html文件
const { CleanWebpackPlugin } = require('clean-webpack-plugin');  //清除
const MiniCssExtractPlugin = require("mini-css-extract-plugin");  //css样式提取


let plugins = [
	new HtmlWebpackPlugin({
		title: '瓦力博客',
		template: dirpath.src + '/index.html'   //以src/index.html为编译模板
	}),
	new  MiniCssExtractPlugin({
		filename: config.NODE_ENV == 'development'?'[name.css]': `${dirpath.css}/[name].[hash].css`,
		chunkFilename: config.NODE_ENV == 'development'?'[id].css': `${dirpath.css}/[id].[hash].css`
	}),   //css提取
	new CleanWebpackPlugin(),
-	new webpack.HotModuleReplacementPlugin()	
]

+ if('development' == config.NODE_ENV){
+	plugins.push(new webpack.HotModuleReplacementPlugin());
+ }

module.exports = plugins;
```

#### index.js

```javascript
import _ from 'loadsh';

let arr = ['hello','world'];

let str = _.join(arr,'--');
console.log(str)
```

#### 运行webpack

```
yarn run prod
```

![ssl](http://walidream.com:9999/blogImage/webpack/webpack_38.png)

#### 修改index.js

```diff
import _ from 'loadsh';

+ let arr = ['hello','wali'];

let str = _.join(arr,'--');
console.log(str)
```

#### 运行webpack

```
yarn run prod
```

![ssl](http://walidream.com:9999/blogImage/webpack/webpack_39.png)

从上面两张截图中可以看出来，当我们修改index.js文件内容。





