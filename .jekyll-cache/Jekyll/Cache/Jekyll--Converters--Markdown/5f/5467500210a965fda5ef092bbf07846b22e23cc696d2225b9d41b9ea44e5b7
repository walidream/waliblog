I"%<p>æœ¬å¸–ä¸»è¦è®°å½•å°èœåœ¨çˆ¬è™«å­¦ä¹ è¿‡ç¨‹ä¸­å¸¸ç”¨çš„æŠ€å·§ã€‚</p>

<h1 id="1apiæ•°æ®è§£æ">1.APIæ•°æ®è§£æ</h1>
<p>scrapyçˆ¬è™«ä¸€èˆ¬çˆ¬å–çš„æ˜¯ç½‘é¡µï¼Œè¿”å›çš„æ˜¯<code class="language-plaintext highlighter-rouge">html</code>ã€‚ä½†æœ‰æ—¶å€™éœ€è¦è°ƒ<code class="language-plaintext highlighter-rouge">API</code>,APIæ¥å£è¿”å›çš„æ˜¯<code class="language-plaintext highlighter-rouge">json</code>ã€‚éœ€è¦å¯¹è¿”å›æ¥çš„æ•°æ®è§£æ</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">res</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">body_as_unicode</span><span class="p">())</span>
</code></pre></div></div>

<h1 id="2chromedirveræŸ¥æ‰¾å…ƒç´ ">2.chromeDirveræŸ¥æ‰¾å…ƒç´ </h1>

<p>å½“æˆ‘ä»¬çˆ¬å–çš„é¡µé¢æ—¶åŠ¨æ€é¡µé¢æ—¶ï¼Œéœ€è¦è¿è¡Œ<code class="language-plaintext highlighter-rouge">js</code>ã€‚ä¸€èˆ¬æˆ‘ä»¬ä½¿ç”¨<code class="language-plaintext highlighter-rouge">selenium</code>æ¥æ§åˆ¶<code class="language-plaintext highlighter-rouge">chromeDirver</code>ã€‚åœ¨è·å–é¡µé¢å…ƒç´ æ—¶æ¯”è¾ƒéº»çƒ¦ï¼Œä¸å¦‚<code class="language-plaintext highlighter-rouge">scrapy</code>ä¸­çš„<code class="language-plaintext highlighter-rouge">é€‰æ‹©å™¨</code>é‚£ä¹ˆæ–¹ä¾¿ã€‚</p>

<ul>
  <li><a href="https://selenium-python-zh.readthedocs.io/en/latest/locating-elements.html" title="https://selenium-python-zh.readthedocs.io/en/latest/locating-elements.html">selenium æŸ¥æ‰¾å…ƒç´ </a></li>
  <li><a href="https://huilansame.github.io/huilansame.github.io/archivers/father-brother-locate" title="https://huilansame.github.io/huilansame.github.io/archivers/father-brother-locate">selenium â€”â€” çˆ¶å­ã€å…„å¼Ÿã€ç›¸é‚»èŠ‚ç‚¹å®šä½æ–¹å¼è¯¦è§£</a></li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">urls</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">browser</span><span class="p">.</span><span class="n">find_elements_by_css_selector</span><span class="p">(</span><span class="s">'.shop_list.shop_list_4 dd h4 a'</span><span class="p">)</span>
<span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">urls</span><span class="p">:</span>
    <span class="n">href</span> <span class="o">=</span> <span class="n">url</span><span class="p">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s">'href'</span><span class="p">)</span>
    <span class="n">unitprice</span> <span class="o">=</span> <span class="n">url</span><span class="p">.</span><span class="n">find_element_by_xpath</span><span class="p">(</span><span class="s">'../../../dd[2]/span[2]'</span><span class="p">).</span><span class="n">text</span>
    <span class="n">address</span> <span class="o">=</span> <span class="n">url</span><span class="p">.</span><span class="n">find_element_by_xpath</span><span class="p">(</span><span class="s">'../../p[@class="add_shop"]/a'</span><span class="p">).</span><span class="n">get_attribute</span><span class="p">(</span><span class="s">'title'</span><span class="p">)</span>
</code></pre></div></div>

<h1 id="3scrapyçŠ¶æ€é”™è¯¯ç ">3.scrapyçŠ¶æ€é”™è¯¯ç </h1>
<p>scrapy é»˜è®¤åªæœ‰<code class="language-plaintext highlighter-rouge">200</code>çŠ¶æ€ç æ‰ä¼šè¿›å…¥<code class="language-plaintext highlighter-rouge">parse</code>æ–¹æ³•è§£æï¼Œæƒ³è¦æŒ‡å®šé”™è¯¯ç ä¹Ÿè¿›å…¥<code class="language-plaintext highlighter-rouge">parse</code>æ–¹æ³•ï¼Œåœ¨<code class="language-plaintext highlighter-rouge">spider</code>ä¸­è®¾ç½®</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">handle_httpstatus_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">404</span><span class="p">,</span> <span class="mi">500</span><span class="p">]</span>
</code></pre></div></div>

<h1 id="4itemä¸€æ¬¡è¿”å›å¤šæ¡æ•°æ®">4.itemä¸€æ¬¡è¿”å›å¤šæ¡æ•°æ®</h1>

<p>æœ‰æ—¶ä¸€ä¸ªé¡µé¢æœ‰æˆ‘ä»¬è¦çš„æ‰€æœ‰æ•°æ®ï¼Œç»“æ„éœ€è¦æˆ‘ä»¬æ•´ç†, æ•°æ®æ•´ç†åï¼Œæ¯ä¸ª<code class="language-plaintext highlighter-rouge">it</code>åœ¨æµåˆ°<code class="language-plaintext highlighter-rouge">pipeline</code>ä¸­å¤„ç†ã€‚</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>

    <span class="n">city</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">css</span><span class="p">(</span><span class="s">"#logo-input a.city.J-city span:nth-child(2)::text"</span><span class="p">).</span><span class="n">get</span><span class="p">()</span>
    <span class="n">quxians</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">xpath</span><span class="p">(</span><span class="s">'//div[@class="content_b"]/div[@class="box shopallCate"][2]/dl[@class="list"]'</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">quxians</span><span class="p">:</span>
        <span class="n">quxian</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="n">css</span><span class="p">(</span><span class="s">"dt .Bravia::text"</span><span class="p">).</span><span class="n">get</span><span class="p">()</span>
        <span class="n">subtanames</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="n">css</span><span class="p">(</span><span class="s">"dd li a::text"</span><span class="p">).</span><span class="n">getall</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">subtanames</span><span class="p">:</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">WzItemLoader</span><span class="p">(</span><span class="n">item</span> <span class="o">=</span> <span class="n">WzSubtanameItem</span><span class="p">(),</span> <span class="n">response</span><span class="o">=</span><span class="n">response</span><span class="p">)</span>
            <span class="n">l</span><span class="p">.</span><span class="n">add_value</span><span class="p">(</span><span class="s">'city'</span><span class="p">,</span> <span class="n">city</span><span class="p">)</span>
            <span class="n">l</span><span class="p">.</span><span class="n">add_value</span><span class="p">(</span><span class="s">'quxian'</span><span class="p">,</span> <span class="n">quxian</span><span class="p">)</span>
            <span class="n">l</span><span class="p">.</span><span class="n">add_value</span><span class="p">(</span><span class="s">'subtaname'</span><span class="p">,</span> <span class="n">sub</span><span class="p">)</span>
            <span class="n">it</span> <span class="o">=</span> <span class="n">l</span><span class="p">.</span><span class="n">load_item</span><span class="p">()</span>
            <span class="k">yield</span> <span class="n">it</span>
</code></pre></div></div>

<h1 id="5scrapy-getä¼ å‚">5.scrapy Getä¼ å‚</h1>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">city</span> <span class="o">=</span> <span class="s">'æ¸©å·'</span><span class="p">,</span>
    <span class="n">citylimit</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
    <span class="n">keywords</span> <span class="o">=</span> <span class="n">brand</span><span class="p">,</span>
    <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">settings</span><span class="p">[</span><span class="s">"GD_KEY"</span><span class="p">],</span>
    <span class="n">page</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">offset</span>
<span class="p">)</span>
<span class="n">encodedParams</span> <span class="o">=</span> <span class="n">urllib</span><span class="p">.</span><span class="n">parse</span><span class="p">.</span><span class="n">urlencode</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
<span class="k">yield</span> <span class="n">scrapy</span><span class="p">.</span><span class="n">Request</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">start_urls</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s">'?'</span> <span class="o">+</span> <span class="n">encodedParams</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span> <span class="n">params</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">parse_detail</span><span class="p">)</span>
</code></pre></div></div>

:ET