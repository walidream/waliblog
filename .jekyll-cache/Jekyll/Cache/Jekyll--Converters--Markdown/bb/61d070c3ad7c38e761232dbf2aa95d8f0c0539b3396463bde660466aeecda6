I">c<p>在之前代的demo中看到<code class="language-plaintext highlighter-rouge">app.run()</code>，然后启动一个应用程序，通过<code class="language-plaintext highlighter-rouge">localhost:5000</code>就能访问我们的视图函数。我们每次更改代码就需要手动重启，还有就是外网不能访问，或者同局域网其他机器不能访问，这些原因都藏在<code class="language-plaintext highlighter-rouge">app.run()</code>方法参数中。</p>

<h4 id="apprun源码">app.run源码</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">load_dotenv</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
    <span class="s">"""Runs the application on a local development server.

    Do not use ``run()`` in a production setting. It is not intended to
    meet security and performance requirements for a production server.
    Instead, see :ref:`deployment` for WSGI server recommendations.

    If the :attr:`debug` flag is set the server will automatically reload
    for code changes and show a debugger in case an exception happened.

    If you want to run the application in debug mode, but disable the
    code execution on the interactive debugger, you can pass
    ``use_evalex=False`` as parameter.  This will keep the debugger's
    traceback screen active, but disable code execution.

    It is not recommended to use this function for development with
    automatic reloading as this is badly supported.  Instead you should
    be using the :command:`flask` command line script's ``run`` support.

    .. admonition:: Keep in Mind

        Flask will suppress any server error with a generic error page
        unless it is in debug mode.  As such to enable just the
        interactive debugger without the code reloading, you have to
        invoke :meth:`run` with ``debug=True`` and ``use_reloader=False``.
        Setting ``use_debugger`` to ``True`` without being in debug mode
        won't catch any exceptions because there won't be any to
        catch.

    :param host: the hostname to listen on. Set this to ``'0.0.0.0'`` to
        have the server available externally as well. Defaults to
        ``'127.0.0.1'`` or the host in the ``SERVER_NAME`` config variable
        if present.
    :param port: the port of the webserver. Defaults to ``5000`` or the
        port defined in the ``SERVER_NAME`` config variable if present.
    :param debug: if given, enable or disable debug mode. See
        :attr:`debug`.
    :param load_dotenv: Load the nearest :file:`.env` and :file:`.flaskenv`
        files to set environment variables. Will also change the working
        directory to the directory containing the first file found.
    :param options: the options to be forwarded to the underlying Werkzeug
        server. See :func:`werkzeug.serving.run_simple` for more
        information.

    .. versionchanged:: 1.0
        If installed, python-dotenv will be used to load environment
        variables from :file:`.env` and :file:`.flaskenv` files.

        If set, the :envvar:`FLASK_ENV` and :envvar:`FLASK_DEBUG`
        environment variables will override :attr:`env` and
        :attr:`debug`.

        Threaded mode is enabled by default.

    .. versionchanged:: 0.10
        The default port is now picked from the ``SERVER_NAME``
        variable.
    """</span>
    <span class="c1"># Change this into a no-op if the server is invoked from the
</span>    <span class="c1"># command line. Have a look at cli.py for more information.
</span>    <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"FLASK_RUN_FROM_CLI"</span><span class="p">)</span> <span class="o">==</span> <span class="s">"true"</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">.debughelpers</span> <span class="kn">import</span> <span class="n">explain_ignored_app_run</span>

        <span class="n">explain_ignored_app_run</span><span class="p">()</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="n">get_load_dotenv</span><span class="p">(</span><span class="n">load_dotenv</span><span class="p">):</span>
        <span class="n">cli</span><span class="p">.</span><span class="n">load_dotenv</span><span class="p">()</span>

        <span class="c1"># if set, let env vars override previous values
</span>        <span class="k">if</span> <span class="s">"FLASK_ENV"</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">get_env</span><span class="p">()</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">get_debug_flag</span><span class="p">()</span>
        <span class="k">elif</span> <span class="s">"FLASK_DEBUG"</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">get_debug_flag</span><span class="p">()</span>

    <span class="c1"># debug passed to method overrides all other sources
</span>    <span class="k">if</span> <span class="n">debug</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">debug</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">debug</span><span class="p">)</span>

    <span class="n">_host</span> <span class="o">=</span> <span class="s">"127.0.0.1"</span>
    <span class="n">_port</span> <span class="o">=</span> <span class="mi">5000</span>
    <span class="n">server_name</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"SERVER_NAME"</span><span class="p">)</span>
    <span class="n">sn_host</span><span class="p">,</span> <span class="n">sn_port</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>

    <span class="k">if</span> <span class="n">server_name</span><span class="p">:</span>
        <span class="n">sn_host</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">sn_port</span> <span class="o">=</span> <span class="n">server_name</span><span class="p">.</span><span class="n">partition</span><span class="p">(</span><span class="s">":"</span><span class="p">)</span>

    <span class="n">host</span> <span class="o">=</span> <span class="n">host</span> <span class="ow">or</span> <span class="n">sn_host</span> <span class="ow">or</span> <span class="n">_host</span>
    <span class="c1"># pick the first value that's not None (0 is allowed)
</span>    <span class="n">port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">next</span><span class="p">((</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">sn_port</span><span class="p">)</span> <span class="k">if</span> <span class="n">p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">),</span> <span class="n">_port</span><span class="p">))</span>

    <span class="n">options</span><span class="p">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">"use_reloader"</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">debug</span><span class="p">)</span>
    <span class="n">options</span><span class="p">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">"use_debugger"</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">debug</span><span class="p">)</span>
    <span class="n">options</span><span class="p">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">"threaded"</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>

    <span class="n">cli</span><span class="p">.</span><span class="n">show_server_banner</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">env</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">debug</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>

    <span class="kn">from</span> <span class="nn">werkzeug.serving</span> <span class="kn">import</span> <span class="n">run_simple</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">run_simple</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># reset the first request information if the development server
</span>        <span class="c1"># reset normally.  This makes it possible to restart the server
</span>        <span class="c1"># without reloader and that stuff from an interactive shell.
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">_got_first_request</span> <span class="o">=</span> <span class="bp">False</span>

</code></pre></div></div>

<p>在app.run方法中传递这么几个参数：<code class="language-plaintext highlighter-rouge">host=None, port=None, debug=None, load_dotenv=True</code></p>

<h1 id="1run参数">1.run参数</h1>

<h4 id="host参数">host参数</h4>

<p>host参数：要监听的主机名。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">app</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">'192.168.0.9'</span><span class="p">)</span>
</code></pre></div></div>

<p>上面示例代码将host设置<code class="language-plaintext highlighter-rouge">192.168.0.9</code>，所以启动服务后就只能通过<code class="language-plaintext highlighter-rouge">192.168.0.9:500</code>来访问视图视图函数。一般host设置<code class="language-plaintext highlighter-rouge">0.0.0.0</code>，设置成’0.0.0.0’如果在本机启动服务，通过局域网访问本机ip + port就可以访问视图函数，如果部署到服务器上，任何机器都可以通过服务器域名 + port来访问视图函数。建议设置<code class="language-plaintext highlighter-rouge">0.0.0.0</code></p>

<h4 id="port端口号">port端口号</h4>

<p>port：要监听主机的端口号，默认是<code class="language-plaintext highlighter-rouge">5000</code>,</p>

<p><code class="language-plaintext highlighter-rouge">注意</code>：设置一般端口号时不要一些常用服务的端口号一样。如网页的端口号是<code class="language-plaintext highlighter-rouge">8080</code>,mysql的端口号是<code class="language-plaintext highlighter-rouge">3036</code>,pgsql的端口<code class="language-plaintext highlighter-rouge">5432</code>。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="n">__name</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">app</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">'0.0.0.0'</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="s">'5000'</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="debug参数">debug参数</h4>

<p>debug: 如果是True开启调试模式，如果Flase关闭调试模式。一般在本地开发时，需要打开调试模式。</p>

<p>打开调试模式的好处就是：</p>
<ul>
  <li>在更改代码后，不需要重新启动服务器</li>
  <li>如果代码运行出错，在网页上会具体抛出代码错误的原因，方便代码快速地位</li>
</ul>

<h4 id="load_dotenv参数">load_dotenv参数</h4>

<p>load_dotenv: 加载最近的<code class="language-plaintext highlighter-rouge">.env</code>和<code class="language-plaintext highlighter-rouge">.flaskenv</code>文件来设置环境变量，一般不需要设置。</p>

<h1 id="2配置文件">2.配置文件</h1>

<p>开发项目中，都会创建一个配置文件，配置文件有什么好处？需要小伙伴们自行百度下。</p>

<h4 id="文件结构">文件结构</h4>

<pre><code class="language-txt">fisher
|-config.py
|-fisher.py
</code></pre>

<h4 id="configpy">config.py</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">DEBUG</span> <span class="o">=</span> <span class="bp">True</span>
</code></pre></div></div>

<h4 id="flask读取配置">Flask读取配置</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#要注意这里config文件路径，是相对入口文件的位置路径
</span><span class="n">app</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">from_object</span><span class="p">(</span><span class="s">'config'</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">app</span><span class="p">.</span><span class="n">config</span><span class="p">[</span><span class="s">'DEBUG'</span><span class="p">])</span>
</code></pre></div></div>

<h4 id="fisherpy">fisher.py</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="c1">#读取config中配置
</span><span class="n">app</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">from_object</span><span class="p">(</span><span class="s">'config'</span><span class="p">)</span>

<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">return</span> <span class="s">'index'</span>

<span class="c1">#设置debug配置
</span><span class="n">app</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">'0.0.0.0'</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="s">'5000'</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span> <span class="n">app</span><span class="p">.</span><span class="n">config</span><span class="p">[</span><span class="s">'DEBUG'</span><span class="p">])</span>
</code></pre></div></div>

<h1 id="3from_boject">3.from_boject</h1>

<p>使用app.config.from_object来装置配置，配置文件中的配置必须是<code class="language-plaintext highlighter-rouge">大写</code>,否则会被忽略</p>

<h4 id="configpy-1">config.py</h4>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">DEBUG = True
</span>
+ Host = '127.0.0.1'
</code></pre></div></div>

<h4 id="fisherpy-1">fisher.py</h4>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">from flask import Flask
</span>
app = Flask(__name__)

#读取config中配置
<span class="p">app.config.from_object('config')
</span>
+ print(app.config['Host'])

@app.route('/')
<span class="p">def index():
</span>    return 'index'

#设置debug配置
<span class="p">app.run(host='0.0.0.0', port='5000', debug= app.config['DEBUG'])
</span></code></pre></div></div>

<p>运行<code class="language-plaintext highlighter-rouge">fisher.py</code>文件，发现会抛出一个错误，<code class="language-plaintext highlighter-rouge">KeyError: 'Host'</code>意思是<code class="language-plaintext highlighter-rouge">app.config['Host']</code>没有Host变量，可是我们明明在config.py中定义<code class="language-plaintext highlighter-rouge">Host=127.0.0.1</code>变量，原因就是使用app.config.from_object来加载配置时，配置文件变量必须是<code class="language-plaintext highlighter-rouge">大写</code>。</p>

<p>将config.py中的<code class="language-plaintext highlighter-rouge">Host</code>修改为大写<code class="language-plaintext highlighter-rouge">HOST</code>，然后修改<code class="language-plaintext highlighter-rouge">fisher.py</code>中</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">print</span><span class="p">(</span><span class="n">app</span><span class="p">.</span><span class="n">config</span><span class="p">[</span><span class="s">'HOST'</span><span class="p">])</span>
</code></pre></div></div>
<p>然后重启<code class="language-plaintext highlighter-rouge">fisher.py</code>文件，发现在控制台输出：</p>

<pre><code class="language-txt">127.0.0.1
</code></pre>

<h1 id="4app中config默认参数">4.app中config默认参数</h1>

<p>我们使用app.config来加载配置文件，那么app.config默认参数是什么,下面是源码</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#: Default configuration parameters.
</span><span class="n">default_config</span> <span class="o">=</span> <span class="n">ImmutableDict</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="s">"ENV"</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
        <span class="s">"DEBUG"</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
        <span class="s">"TESTING"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="s">"PROPAGATE_EXCEPTIONS"</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
        <span class="s">"PRESERVE_CONTEXT_ON_EXCEPTION"</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
        <span class="s">"SECRET_KEY"</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
        <span class="s">"PERMANENT_SESSION_LIFETIME"</span><span class="p">:</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">31</span><span class="p">),</span>
        <span class="s">"USE_X_SENDFILE"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="s">"SERVER_NAME"</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
        <span class="s">"APPLICATION_ROOT"</span><span class="p">:</span> <span class="s">"/"</span><span class="p">,</span>
        <span class="s">"SESSION_COOKIE_NAME"</span><span class="p">:</span> <span class="s">"session"</span><span class="p">,</span>
        <span class="s">"SESSION_COOKIE_DOMAIN"</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
        <span class="s">"SESSION_COOKIE_PATH"</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
        <span class="s">"SESSION_COOKIE_HTTPONLY"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
        <span class="s">"SESSION_COOKIE_SECURE"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="s">"SESSION_COOKIE_SAMESITE"</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
        <span class="s">"SESSION_REFRESH_EACH_REQUEST"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
        <span class="s">"MAX_CONTENT_LENGTH"</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
        <span class="s">"SEND_FILE_MAX_AGE_DEFAULT"</span><span class="p">:</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">12</span><span class="p">),</span>
        <span class="s">"TRAP_BAD_REQUEST_ERRORS"</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
        <span class="s">"TRAP_HTTP_EXCEPTIONS"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="s">"EXPLAIN_TEMPLATE_LOADING"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="s">"PREFERRED_URL_SCHEME"</span><span class="p">:</span> <span class="s">"http"</span><span class="p">,</span>
        <span class="s">"JSON_AS_ASCII"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
        <span class="s">"JSON_SORT_KEYS"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
        <span class="s">"JSONIFY_PRETTYPRINT_REGULAR"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="s">"JSONIFY_MIMETYPE"</span><span class="p">:</span> <span class="s">"application/json"</span><span class="p">,</span>
        <span class="s">"TEMPLATES_AUTO_RELOAD"</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
        <span class="s">"MAX_COOKIE_SIZE"</span><span class="p">:</span> <span class="mi">4093</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">)</span>
</code></pre></div></div>
<p>在源码中我们可以找到config[‘DEBUG’]默认参数<code class="language-plaintext highlighter-rouge">None</code></p>

<h1 id="5入口文件if__name__作用">5.入口文件if__name__作用</h1>

<p>大家看到过别人python代码中，入口文件代码经常会有下面一段代码</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">app</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">'0.0.0.0'</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="s">'5000'</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">app</span><span class="p">.</span><span class="n">config</span><span class="p">[</span><span class="s">'DEBUG'</span><span class="p">])</span>

</code></pre></div></div>
<p>我们来讨论下为什么添加这么一段代码，在python中如果别人导入你这个模块，如果不加判断，那么也会执行这段代码，这是我们不希望的。还有一个原因，在生产环境下，我们部署代码到服务器上，通常是使用<code class="language-plaintext highlighter-rouge">nginx + uwsgi</code>方式，uwsgi会加载<code class="language-plaintext highlighter-rouge">入口文件</code>来启动一个服务，而不在使用flask自带的app.run启动服务。如果没有这个判断，那么在服务器上就会启动两个服务，这个是不允许的。</p>

:ET