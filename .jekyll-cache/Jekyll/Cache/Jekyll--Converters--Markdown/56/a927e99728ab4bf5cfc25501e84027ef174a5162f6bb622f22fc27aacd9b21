I")<p>在搭建 LAMP/LNMP 服务器时，会经常遇到 PHP-FPM、FastCGI和CGI 这几个概念。</p>

<ul>
  <li>歪麦博主<a href="https://www.awaimai.com/371.html#FastCGI" title="https://www.awaimai.com/371.html#FastCGI" target="_blank">CGI、FastCGI和PHP-FPM关系图解</a></li>
</ul>

<h1 id="1cgi">1.CGI</h1>

<p>CGI（Common Gateway Interface）全称是“通用网关接口”，WEB 服务器与PHP应用进行“交谈”的一种工具，其程序须运行在网络服务器上。CGI可以用任何一种语言编写，只要这种语言具有标准输入、输出和环境变量。如php、perl、tcl等。</p>

<p>WEB服务器会传哪些数据给PHP解析器呢？URL、查询字符串、POST数据、HTTP header都会有。所以，CGI就是规定要传哪些数据，以什么样的格式传递给后方处理这个请求的协议。仔细想想，你在PHP代码中使用的用户从哪里来的。</p>

<p>也就是说，CGI就是专门用来和 web 服务器打交道的。web服务器收到用户请求，就会把请求提交给cgi程序（如php-cgi），cgi程序根据请求提交的参数作应处理（解析php），然后输出标准的html语句，返回给web服服务器，WEB服务器再返回给客户端，这就是普通cgi的工作原理。</p>

<p>但是CGI有个蛋疼的地方，就是每一次web请求都会有启动和退出过程，也就是最为人诟病的fork-and-execute模式，这样一在大规模并发下，就死翘翘了。</p>

<h4 id="cgi工作流程">CGI工作流程</h4>

<p><img src="http://walidream.com:9999/blogImage/nginx/nginx_31.jpg" alt="ssl" /></p>

<h1 id="2fastcgi">2.FastCGI</h1>

<p>从根本上来说，FastCGI是用来提高CGI程序性能的。类似于CGI，FastCGI也可以说是一种协议。fastCGI基于CGI协议之上做了一些性能优化。</p>

<p>FastCGI像是一个常驻(long-live)型的CGI，它可以一直执行着，只要激活后，不会每次都要花费时间去fork一次。它还支持分布式的运算, 即 FastCGI 程序可以在网站服务器以外的主机上执行，并且接受来自其它网站服务器来的请求。</p>

<p>FastCGI是语言无关的、可伸缩架构的CGI开放扩展，其主要行为是将CGI解释器进程保持在内存中，并因此获得较高的性能。众所周知，CGI解释器的反复加载是CGI性能低下的主要原因，如果CGI解释器保持在内存中，并接受FastCGI进程管理器调度，则可以提供良好的性能、伸缩性、Fail- Over特性等等</p>

<h4 id="lnmp架构linux-nginx-mysql-php">LNMP架构(linux Nginx Mysql PHP)</h4>

<p><img src="http://walidream.com:9999/blogImage/nginx/nginx_32.jpg" alt="ssl" /></p>

<h1 id="3fastcgi模块">3.FastCGI模块</h1>

<p>下面的这些配置项都是属于fastCGI模块<a href="http://nginx.org/en/docs/http/ngx_http_fastcgi_module.html" title="http://nginx.org/en/docs/http/ngx_http_fastcgi_module.html" target="_blank">传送门</a></p>

<h3 id="fastcgi_pass">fastcgi_pass</h3>

<p>设置FastCGI服务器的地址，地址可以指定为域名或IP地址，以及端口：</p>

<div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Syntax:</span>	<span class="s">fastcgi_pass</span> <span class="s">address</span><span class="p">;</span>
<span class="k">Default:</span> <span class="s">—</span>
<span class="s">Context:</span> <span class="s">location,</span> <span class="s">if</span> <span class="s">in</span> <span class="s">location</span>
</code></pre></div></div>

<ul>
  <li>fastcgi_pass localhost:9000</li>
  <li>fastcgi_pass unix:/tmp/fastcgi.socket (nginx 和 php在同一台机器，通过socket)</li>
</ul>

<h3 id="fastcgi_index">fastcgi_index</h3>

<p>设置默认首页，结合fastcgi_param一起设置</p>

<div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Syntax:</span>	<span class="s">fastcgi_index</span> <span class="s">name</span><span class="p">;</span>
<span class="k">Default:</span> <span class="s">—</span>
<span class="s">Context:</span> <span class="s">http,</span> <span class="s">server,</span> <span class="s">location</span>
</code></pre></div></div>

<h3 id="fastcgi_param">fastcgi_param</h3>

<p>通过fastcgi_param设置变量，并将设置的变量传递到后端的FastCGI server</p>

<div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Syntax:</span>	<span class="s">fastcgi_param</span> <span class="s">parameter</span> <span class="s">value</span> <span class="s">[if_not_empty]</span><span class="p">;</span>
<span class="k">Default:</span> <span class="s">—</span>
<span class="s">Context:</span> <span class="s">http,</span> <span class="s">server,</span> <span class="s">location</span>
</code></pre></div></div>

<h1 id="4基础环境安装">4.基础环境安装</h1>

<p>由于演示的环境是LNMP，需要安装php，mysql</p>

<h4 id="mysql搭建">mysql搭建</h4>

<p>MariaDB数据库管理系统是MySQL的一个分支，主要由开源社区在维护，采用GPL授权许可。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yum install mariadb -y

yum -y install mariadb-server

systemctl start mariadb.service  #启用数据库

ss -luntp | grep 3306  #查看mysql是否启动起来

mysql -uroot -p    #登录mysql
</code></pre></div></div>

<h4 id="php安装">php安装</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yum install http://rpms.remirepo.net/enterprise/remi-release-7.rpm

yum install yum-utils

yum-config-manager --enable remi-php72

yum search php72

yum install php72-php-fpm php72-php-common php72-php-mbstring php72-php-xmlrpc php72-php-soap php72-php-gd php72-php-xml php72-php-intl php72-php-mysql php72-php-cli php72-php-zip php72-php-curl
</code></pre></div></div>

<p>检测php安装成功</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php72 -version
</code></pre></div></div>

<p>启动fastcgi就是通过读取 <code class="language-plaintext highlighter-rouge">vim /etc/opt/remi/php72/php-fpm.conf</code></p>

<p><code class="language-plaintext highlighter-rouge">vim /etc/opt/remi/php72/php-fpm.d/www.conf</code>查看listen的端口<code class="language-plaintext highlighter-rouge">listen = 127.0.0.1:9000</code>表示监听的端口9000</p>

<h4 id="启动服务">启动服务</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl status php72-php-fpm.service

systemctl stop php72-php-fpm.service

systemctl start php72-php-fpm.service
</code></pre></div></div>

<p>检测fastcgi是否启动成功</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ss -luntp 或 netstat -luntp | grep php #查看9000端口是否在监听

ps -ef | grep php  #查看php-fpm进程是否启动
</code></pre></div></div>

<h1 id="5nginx配置">5.nginx配置</h1>

<p>服务目录</p>

<pre><code class="language-txt">/opt/app/code5
|--info.php
|--index.html

/etc/nginx/conf.d
|-lnmp.conf
</code></pre>

<h4 id="infophp">info.php</h4>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

  <span class="nb">phpinfo</span><span class="p">();</span>

<span class="cp">?&gt;</span>
</code></pre></div></div>

<h4 id="indexhtml">index.html</h4>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!doctype html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
	<span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"UTF-8"</span><span class="nt">&gt;</span>
	<span class="nt">&lt;title&gt;</span>Document<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
	<span class="nt">&lt;h1&gt;</span>瓦力博客首页<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<h4 id="lnmpconf">lnmp.conf</h4>

<div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">server</span> <span class="p">{</span>
    <span class="kn">listen</span>       <span class="mi">80</span><span class="p">;</span> 
    <span class="kn">server_name</span>  <span class="s">localhost</span><span class="p">;</span>

    <span class="c1">#charset koi8-r;</span>
    <span class="kn">access_log</span>  <span class="n">/var/log/nginx/host.access.log</span>  <span class="s">main</span><span class="p">;</span>

    <span class="kn">location</span> <span class="n">/</span> <span class="p">{</span> 
        <span class="kn">root</span>   <span class="n">/opt/app/code5</span><span class="p">;</span>
        <span class="kn">index</span>  <span class="s">index.html</span><span class="p">;</span>
    <span class="p">}</span>   

    <span class="kn">location</span> <span class="p">~</span> <span class="sr">\.php$</span> <span class="p">{</span>
        <span class="kn">root</span> <span class="n">/opt/app/code5</span><span class="p">;</span>
        <span class="kn">fastcgi_pass</span> <span class="nf">127.0.0.1</span><span class="p">:</span><span class="mi">9000</span><span class="p">;</span>
        <span class="kn">fastcgi_index</span> <span class="s">index.php</span><span class="p">;</span>
        <span class="kn">include</span> <span class="s">fastcgi_params</span><span class="p">;</span>
        <span class="kn">fastcgi_param</span> <span class="s">SCRIPT_FILENAME</span> <span class="nv">$document_root$fastcgi_script_name</span><span class="p">;</span>
    <span class="p">}</span>   
	
<span class="p">}</span>
</code></pre></div></div>

<p>检测语法并重启</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nginx -tc /etc/nginx/nginx.conf

nginx -s reload -c /etc/nginx/nginx.conf
</code></pre></div></div>

<p><img src="http://walidream.com:9999/blogImage/nginx/nginx_33.jpg" alt="ssl" /></p>

<p><img src="http://walidream.com:9999/blogImage/nginx/nginx_34.jpg" alt="ssl" /></p>

:ET