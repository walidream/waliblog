I";Í<p>Item Loaders æä¾›äº†ä¸€ç§ä¾¿æ·çš„æ–¹å¼å¡«å……æŠ“å–åˆ°çš„:<code class="language-plaintext highlighter-rouge">Items</code>ã€‚è™½ç„¶ <code class="language-plaintext highlighter-rouge">Items</code> å¯ä»¥ä½¿ç”¨è‡ªå¸¦çš„ç±»å­—å…¸å½¢å¼ <code class="language-plaintext highlighter-rouge">API</code> å¡«å……ï¼Œä½†æ˜¯ <code class="language-plaintext highlighter-rouge">Items Loaders</code> æä¾›äº†æ›´ä¾¿æ·çš„ APIï¼Œå¯ä»¥åˆ†æåŸå§‹æ•°æ®å¹¶å¯¹ <code class="language-plaintext highlighter-rouge">Item</code> è¿›è¡Œèµ‹å€¼ã€‚</p>

<p>ä»å¦ä¸€æ–¹é¢æ¥è¯´ï¼Œ<code class="language-plaintext highlighter-rouge">Items</code> æä¾›ä¿å­˜æŠ“å–æ•°æ®çš„å®¹å™¨ï¼Œè€Œ <code class="language-plaintext highlighter-rouge">Item Loaders</code> æä¾›çš„æ˜¯<code class="language-plaintext highlighter-rouge">å¡«å……å®¹å™¨</code>çš„æœºåˆ¶ã€‚</p>

<p><code class="language-plaintext highlighter-rouge">Item Loaders</code>æä¾›çš„æ˜¯ä¸€ç§çµæ´»ï¼Œé«˜æ•ˆçš„æœºåˆ¶ï¼Œå¯ä»¥æ›´æ–¹ä¾¿çš„è¢« <code class="language-plaintext highlighter-rouge">spider</code> æˆ– <code class="language-plaintext highlighter-rouge">source format</code> (HTMLï¼ŒXMLï¼Œetc)æ‰©å±•ï¼Œå¹¶ <code class="language-plaintext highlighter-rouge">override </code>æ›´æ˜“äºç»´æŠ¤çš„ã€ä¸åŒçš„å†…å®¹åˆ†æè§„åˆ™ã€‚</p>

<h1 id="1ä½¿ç”¨itemloaderså¡«å……item">1.ä½¿ç”¨itemLoaderså¡«å……item</h1>

<p>è¦ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">Item Loader</code>, ä½ å¿…é¡»å…ˆå°†å®ƒå®ä¾‹åŒ–ã€‚ä½ å¯ä»¥ä½¿ç”¨ç±»ä¼¼å­—å…¸çš„å¯¹è±¡(ä¾‹å¦‚: Item or dict)æ¥è¿›è¡Œå®ä¾‹åŒ–ï¼Œæˆ–è€…ä¸ä½¿ç”¨å¯¹è±¡ä¹Ÿå¯ä»¥ï¼Œå½“ä¸ç”¨å¯¹è±¡è¿›è¡Œå®ä¾‹åŒ–çš„æ—¶å€™ï¼ŒItem ä¼šè‡ªåŠ¨ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">ItemLoader.default._item_class</code> å±æ€§ä¸­æŒ‡å®šçš„ Item ç±»åœ¨ <code class="language-plaintext highlighter-rouge">Item Loader constructor</code> ä¸­å®ä¾‹åŒ–ã€‚</p>

<p>ç„¶å,ä½ å¼€å§‹æ”¶é›†æ•°å€¼åˆ° <code class="language-plaintext highlighter-rouge">Item Loader</code> æ—¶ï¼Œé€šå¸¸ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">Selectors</code>ã€‚ä½ å¯ä»¥åœ¨åŒä¸€ä¸ª <code class="language-plaintext highlighter-rouge">i</code>tem field<code class="language-plaintext highlighter-rouge"> é‡Œé¢æ·»åŠ å¤šä¸ªæ•°å€¼ï¼›</code>Item Loader` å°†çŸ¥é“å¦‚ä½•ç”¨åˆé€‚çš„å¤„ç†å‡½æ•°æ¥â€œæ·»åŠ â€è¿™äº›æ•°å€¼ã€‚</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">scrapy.loader</span> <span class="kn">import</span> <span class="n">ItemLoader</span>
<span class="kn">from</span> <span class="nn">myproject.items</span> <span class="kn">import</span> <span class="n">Product</span>

<span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">ItemLoader</span><span class="p">(</span><span class="n">item</span><span class="o">=</span><span class="n">Product</span><span class="p">(),</span> <span class="n">response</span><span class="o">=</span><span class="n">response</span><span class="p">)</span>
    <span class="n">l</span><span class="p">.</span><span class="n">add_xpath</span><span class="p">(</span><span class="s">'name'</span><span class="p">,</span> <span class="s">'//div[@class="product_name"]'</span><span class="p">)</span>
    <span class="n">l</span><span class="p">.</span><span class="n">add_xpath</span><span class="p">(</span><span class="s">'name'</span><span class="p">,</span> <span class="s">'//div[@class="product_title"]'</span><span class="p">)</span>
    <span class="n">l</span><span class="p">.</span><span class="n">add_xpath</span><span class="p">(</span><span class="s">'price'</span><span class="p">,</span> <span class="s">'//p[@id="price"]'</span><span class="p">)</span>
    <span class="n">l</span><span class="p">.</span><span class="n">add_css</span><span class="p">(</span><span class="s">'stock'</span><span class="p">,</span> <span class="s">'p#stock]'</span><span class="p">)</span>
    <span class="n">l</span><span class="p">.</span><span class="n">add_value</span><span class="p">(</span><span class="s">'last_updated'</span><span class="p">,</span> <span class="s">'today'</span><span class="p">)</span> <span class="c1"># you can also use literal values
</span>    <span class="k">return</span> <span class="n">l</span><span class="p">.</span><span class="n">load_item</span><span class="p">()</span>
</code></pre></div></div>

<p>å¿«é€ŸæŸ¥çœ‹è¿™äº›ä»£ç ä¹‹å,æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å‘ç° <code class="language-plaintext highlighter-rouge">name</code> å­—æ®µè¢«ä»é¡µé¢ä¸­ä¸¤ä¸ªä¸åŒçš„ <code class="language-plaintext highlighter-rouge">XPath</code> ä½ç½®æå–:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">//div[@class="product_name"]</code></li>
  <li><code class="language-plaintext highlighter-rouge">//div[@class="product_title"]</code></li>
</ul>

<p>æ¢è¨€ä¹‹,æ•°æ®é€šè¿‡ç”¨ <code class="language-plaintext highlighter-rouge">add_xpath()</code>çš„æ–¹æ³•,æŠŠä»ä¸¤ä¸ªä¸åŒçš„ <code class="language-plaintext highlighter-rouge">XPath</code> ä½ç½®æå–çš„æ•°æ®æ”¶é›†èµ·æ¥. è¿™æ˜¯å°†åœ¨ä»¥ååˆ†é…ç»™<code class="language-plaintext highlighter-rouge"> name</code> å­—æ®µä¸­çš„æ•°æ®ï½¡</p>

<p>ä¹‹å,ç±»ä¼¼çš„è¯·æ±‚è¢«ç”¨äº <code class="language-plaintext highlighter-rouge">price</code> å’Œ <code class="language-plaintext highlighter-rouge">stock</code> å­—æ®µ (åè€…ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">CSS selector</code> å’Œ <code class="language-plaintext highlighter-rouge">add_css()</code> æ–¹æ³•)ï¼Œ æœ€åä½¿ç”¨ä¸åŒçš„æ–¹æ³• <code class="language-plaintext highlighter-rouge">add_value()</code>å¯¹ <code class="language-plaintext highlighter-rouge">last_update</code> å¡«å……æ–‡æœ¬å€¼(today)ã€‚</p>

<p>æœ€ç»ˆï¼Œå½“æ‰€æœ‰æ•°æ®è¢«æ”¶é›†èµ·æ¥ä¹‹å, è°ƒç”¨ <code class="language-plaintext highlighter-rouge">ItemLoader.load_item()</code> æ–¹æ³•ï¼Œå®é™…ä¸Šå¡«å……å¹¶ä¸”è¿”å›äº†ä¹‹å‰é€šè¿‡è°ƒç”¨<code class="language-plaintext highlighter-rouge">add_xpath()</code>ï¼Œ<code class="language-plaintext highlighter-rouge">add_css()</code>ï¼Œ<code class="language-plaintext highlighter-rouge">and add_value()</code>æ‰€æå–å’Œæ”¶é›†åˆ°çš„æ•°æ®çš„<code class="language-plaintext highlighter-rouge"> Item</code>ã€‚</p>

<h1 id="2è¾“å…¥å’Œè¾“å‡ºå¤„ç†å™¨">2.è¾“å…¥å’Œè¾“å‡ºå¤„ç†å™¨</h1>

<h4 id="input-and-output-processors">Input and Output processors</h4>

<p><code class="language-plaintext highlighter-rouge">Item Loader</code> åœ¨æ¯ä¸ª(Item)å­—æ®µä¸­éƒ½åŒ…å«äº†<code class="language-plaintext highlighter-rouge">ä¸€ä¸ªè¾“å…¥å¤„ç†å™¨</code>å’Œ<code class="language-plaintext highlighter-rouge">ä¸€ä¸ªè¾“å‡ºå¤„ç†å™¨</code>ï½¡ è¾“å…¥å¤„ç†å™¨æ”¶åˆ°æ•°æ®æ—¶ç«‹åˆ»æå–æ•°æ® (é€šè¿‡ <code class="language-plaintext highlighter-rouge">add_xpath()</code>ï¼Œ<code class="language-plaintext highlighter-rouge">add_css()</code>æˆ–è€… <code class="language-plaintext highlighter-rouge">add_value()</code>æ–¹æ³•)ä¹‹åè¾“å…¥å¤„ç†å™¨çš„ç»“æœè¢«æ”¶é›†èµ·æ¥å¹¶ä¸”ä¿å­˜åœ¨ <code class="language-plaintext highlighter-rouge">ItemLoader</code> å†…. æ”¶é›†åˆ°æ‰€æœ‰çš„æ•°æ®å, è°ƒç”¨ <code class="language-plaintext highlighter-rouge">ItemLoader.load_item()</code>æ–¹æ³•æ¥å¡«å……,å¹¶å¾—åˆ°å¡«å……åçš„ <code class="language-plaintext highlighter-rouge">Item</code> å¯¹è±¡ã€‚è¿™æ˜¯å½“è¾“å‡ºå¤„ç†å™¨è¢«å’Œä¹‹å‰æ”¶é›†åˆ°çš„æ•°æ®(å’Œç”¨è¾“å…¥å¤„ç†å™¨å¤„ç†çš„)è¢«è°ƒç”¨.è¾“å‡ºå¤„ç†å™¨çš„ç»“æœæ˜¯è¢«åˆ†é…åˆ° <code class="language-plaintext highlighter-rouge">Item</code> çš„æœ€ç»ˆå€¼ï½¡</p>

<p>è®©æˆ‘ä»¬çœ‹ä¸€ä¸ªä¾‹å­æ¥è¯´æ˜å¦‚ä½•è¾“å…¥å’Œè¾“å‡ºå¤„ç†å™¨è¢«ä¸€ä¸ªç‰¹å®šçš„å­—æ®µè°ƒç”¨(åŒæ ·é€‚ç”¨äºå…¶ä»– field):</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">l</span> <span class="o">=</span> <span class="n">ItemLoader</span><span class="p">(</span><span class="n">Product</span><span class="p">(),</span> <span class="n">some_selector</span><span class="p">)</span>
<span class="n">l</span><span class="p">.</span><span class="n">add_xpath</span><span class="p">(</span><span class="s">'name'</span><span class="p">,</span> <span class="n">xpath1</span><span class="p">)</span> <span class="c1"># (1)
</span><span class="n">l</span><span class="p">.</span><span class="n">add_xpath</span><span class="p">(</span><span class="s">'name'</span><span class="p">,</span> <span class="n">xpath2</span><span class="p">)</span> <span class="c1"># (2)
</span><span class="n">l</span><span class="p">.</span><span class="n">add_css</span><span class="p">(</span><span class="s">'name'</span><span class="p">,</span> <span class="n">css</span><span class="p">)</span> <span class="c1"># (3)
</span><span class="n">l</span><span class="p">.</span><span class="n">add_value</span><span class="p">(</span><span class="s">'name'</span><span class="p">,</span> <span class="s">'test'</span><span class="p">)</span> <span class="c1"># (4)
</span><span class="k">return</span> <span class="n">l</span><span class="p">.</span><span class="n">load_item</span><span class="p">()</span> <span class="c1"># (5)
</span></code></pre></div></div>

<p>å‘ç”Ÿäº†è¿™äº›äº‹æƒ…:</p>

<ul>
  <li>1.<code class="language-plaintext highlighter-rouge">xpath1</code> æå–å‡ºçš„æ•°æ®,ä¼ é€’ç»™ <code class="language-plaintext highlighter-rouge">è¾“å…¥å¤„ç†å™¨</code> çš„ <code class="language-plaintext highlighter-rouge">name</code> å­—æ®µã€‚è¾“å…¥å¤„ç†å™¨çš„ç»“æœè¢«æ”¶é›†å’Œä¿å­˜åœ¨ <code class="language-plaintext highlighter-rouge">Item Loader</code> ä¸­(ä½†å°šæœªåˆ†é…ç»™è¯¥ Item)ï½¡</li>
  <li>2.ä»<code class="language-plaintext highlighter-rouge">xpath2</code>æå–å‡ºæ¥çš„æ•°æ®,ä¼ é€’ç»™<code class="language-plaintext highlighter-rouge">(1)</code>ä¸­ä½¿ç”¨çš„ç›¸åŒçš„ è¾“å…¥å¤„ç†å™¨ã€‚è¾“å…¥å¤„ç†å™¨çš„ç»“æœè¢«é™„åŠ åˆ°åœ¨(1)ä¸­æ”¶é›†çš„æ•°æ®(å¦‚æœæœ‰çš„è¯)ï½¡</li>
  <li>3.å’Œä¹‹å‰ç›¸ä¼¼ï¼Œåªä¸è¿‡è¿™é‡Œçš„æ•°æ®æ˜¯é€šè¿‡ <code class="language-plaintext highlighter-rouge">css</code> CSS selector æŠ½å–ï¼Œä¹‹åä¼ è¾“åˆ°åœ¨(1)å’Œ(2)ä½¿ç”¨ çš„ è¾“å…¥å¤„ç†å™¨ä¸­ã€‚æœ€ç»ˆè¾“å…¥å¤„ç†å™¨çš„ç»“æœè¢«é™„åŠ åˆ°åœ¨(1)å’Œ(2)ä¸­æ”¶é›†çš„æ•°æ®ä¹‹å (å¦‚æœå­˜åœ¨æ•°æ®çš„è¯)ã€‚</li>
  <li>4.è¿™é‡Œçš„å¤„ç†æ–¹å¼ä¹Ÿå’Œä¹‹å‰ç›¸ä¼¼ï¼Œä½†æ˜¯æ­¤å¤„çš„å€¼æ˜¯é€šè¿‡<code class="language-plaintext highlighter-rouge">add_value</code> ç›´æ¥èµ‹äºˆçš„ï¼Œ è€Œä¸æ˜¯åˆ©ç”¨<code class="language-plaintext highlighter-rouge"> XPath</code> è¡¨è¾¾å¼æˆ– <code class="language-plaintext highlighter-rouge">CSS selector</code> è·å–ã€‚å¾—åˆ°çš„å€¼ä»ç„¶æ˜¯è¢«ä¼ é€åˆ°è¾“å…¥å¤„ç†å™¨ã€‚ åœ¨è¿™é‡Œä¾‹ç¨‹ä¸­ï¼Œå› ä¸ºå¾—åˆ°çš„å€¼å¹¶éå¯è¿­ä»£ï¼Œæ‰€ä»¥åœ¨ä¼ è¾“åˆ°è¾“å…¥å¤„ç†å™¨ä¹‹å‰éœ€è¦å°†å…¶ è½¬åŒ–ä¸ºå¯è¿­ä»£çš„å•ä¸ªå…ƒç´ ï¼Œè¿™æ‰æ˜¯å®ƒæ‰€æ¥å—çš„å½¢å¼ã€‚</li>
  <li>5.åœ¨ä¹‹å‰æ­¥éª¤ä¸­æ‰€æ”¶é›†åˆ°çš„æ•°æ®è¢«ä¼ é€åˆ° è¾“å‡ºå¤„ç†å™¨ çš„ <code class="language-plaintext highlighter-rouge">name field</code> ä¸­ã€‚è¾“å‡ºå¤„ç†å™¨çš„ç»“æœå°±æ˜¯èµ‹åˆ° <code class="language-plaintext highlighter-rouge">item</code> ä¸­ <code class="language-plaintext highlighter-rouge">name field</code> çš„å€¼ã€‚</li>
</ul>

<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¾“å…¥å’Œè¾“å‡ºå¤„ç†å™¨éƒ½æ˜¯å¯è°ƒç”¨å¯¹è±¡ï¼Œè°ƒç”¨æ—¶ä¼ å…¥éœ€è¦è¢«åˆ†æçš„æ•°æ®ï¼Œ å¤„ç†åè¿”å›åˆ†æå¾—åˆ°çš„å€¼ã€‚å› æ­¤ä½ å¯ä»¥ä½¿ç”¨ä»»æ„å‡½æ•°ä½œä¸ºè¾“å…¥ã€è¾“å‡ºå¤„ç†å™¨ã€‚å”¯ä¸€éœ€æ³¨æ„çš„æ˜¯å®ƒä»¬<code class="language-plaintext highlighter-rouge">å¿…é¡»æ¥æ”¶ä¸€ä¸ªï¼ˆå¹¶ä¸”åªæ˜¯ä¸€ä¸ªï¼‰è¿­ä»£å™¨æ€§è´¨çš„ positional å‚æ•°</code>ã€‚</p>

<h1 id="3å£°æ˜itemloaders">3.å£°æ˜itemLoaders</h1>

<p>é€šè¿‡ä½¿ç”¨ç±»å®šä¹‰è¯­æ³•ï¼Œåƒ<code class="language-plaintext highlighter-rouge">item</code>ä¸€æ ·å£°æ˜<code class="language-plaintext highlighter-rouge">item loaders</code>ã€‚è¿™æ˜¯ä¸€ä¸ªä¾‹å­ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">scrapy.loader</span> <span class="kn">import</span> <span class="n">ItemLoader</span>
<span class="kn">from</span> <span class="nn">scrapy.loader.processors</span> <span class="kn">import</span> <span class="n">TakeFirst</span><span class="p">,</span> <span class="n">MapCompose</span><span class="p">,</span> <span class="n">Join</span>

<span class="k">class</span> <span class="nc">ProductLoader</span><span class="p">(</span><span class="n">ItemLoader</span><span class="p">):</span>

    <span class="n">default_output_processor</span> <span class="o">=</span> <span class="n">TakeFirst</span><span class="p">()</span>

    <span class="n">name_in</span> <span class="o">=</span> <span class="n">MapCompose</span><span class="p">(</span><span class="nb">unicode</span><span class="p">.</span><span class="n">title</span><span class="p">)</span>
    <span class="n">name_out</span> <span class="o">=</span> <span class="n">Join</span><span class="p">()</span>

    <span class="n">price_in</span> <span class="o">=</span> <span class="n">MapCompose</span><span class="p">(</span><span class="nb">unicode</span><span class="p">.</span><span class="n">strip</span><span class="p">)</span>

    <span class="c1"># ...
</span></code></pre></div></div>

<p>å¦‚æ‚¨æ‰€è§ï¼Œè¾“å…¥å¤„ç†å™¨ä½¿ç”¨<code class="language-plaintext highlighter-rouge">_in</code>åç¼€å£°æ˜ï¼Œè€Œè¾“å‡ºå¤„ç†å™¨ä½¿ç”¨<code class="language-plaintext highlighter-rouge">_out</code>åç¼€å£°æ˜ã€‚æ‚¨è¿˜å¯ä»¥ä½¿ç”¨<code class="language-plaintext highlighter-rouge">ItemLoader.default_input_processor</code>å’Œ<code class="language-plaintext highlighter-rouge">ItemLoader.default_output_processor</code>å±æ€§å£°æ˜é»˜è®¤çš„è¾“å…¥/è¾“å‡ºå¤„ç†å™¨ã€‚</p>

<h1 id="4å£°æ˜è¾“å…¥è¾“å‡ºå¤„ç†å™¨">4.å£°æ˜è¾“å…¥è¾“å‡ºå¤„ç†å™¨</h1>

<h4 id="declaring-input-and-output-processors">Declaring Input and Output Processors</h4>

<p>å¦‚ä¸Šä¸€èŠ‚æ‰€è¿°ï¼Œå¯ä»¥åœ¨<code class="language-plaintext highlighter-rouge">Item Loader</code>å®šä¹‰ä¸­å£°æ˜è¾“å…¥å’Œè¾“å‡ºå¤„ç†å™¨ï¼Œå¹¶ä¸”ä»¥è¿™ç§æ–¹å¼å£°æ˜è¾“å…¥å¤„ç†å™¨éå¸¸æ™®éã€‚ä½†æ˜¯ï¼Œè¿˜æœ‰ä¸€ä¸ªåœ°æ–¹å¯ä»¥æŒ‡å®šè¦ä½¿ç”¨çš„è¾“å…¥å’Œè¾“å‡ºå¤„ç†å™¨ï¼š<code class="language-plaintext highlighter-rouge">item field</code>å…ƒæ•°æ®ä¸­ã€‚è¿™æ˜¯ä¸€ä¸ªä¾‹å­ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">scrapy</span>
<span class="kn">from</span> <span class="nn">scrapy.loader.processors</span> <span class="kn">import</span> <span class="n">Join</span><span class="p">,</span> <span class="n">MapCompose</span><span class="p">,</span> <span class="n">TakeFirst</span>
<span class="kn">from</span> <span class="nn">w3lib.html</span> <span class="kn">import</span> <span class="n">remove_tags</span>

<span class="k">def</span> <span class="nf">filter_price</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">value</span><span class="p">.</span><span class="n">isdigit</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">value</span>

<span class="k">class</span> <span class="nc">Product</span><span class="p">(</span><span class="n">scrapy</span><span class="p">.</span><span class="n">Item</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">scrapy</span><span class="p">.</span><span class="n">Field</span><span class="p">(</span>
        <span class="n">input_processor</span><span class="o">=</span><span class="n">MapCompose</span><span class="p">(</span><span class="n">remove_tags</span><span class="p">),</span>
        <span class="n">output_processor</span><span class="o">=</span><span class="n">Join</span><span class="p">(),</span>
    <span class="p">)</span>
    <span class="n">price</span> <span class="o">=</span> <span class="n">scrapy</span><span class="p">.</span><span class="n">Field</span><span class="p">(</span>
        <span class="n">input_processor</span><span class="o">=</span><span class="n">MapCompose</span><span class="p">(</span><span class="n">remove_tags</span><span class="p">,</span> <span class="n">filter_price</span><span class="p">),</span>
        <span class="n">output_processor</span><span class="o">=</span><span class="n">TakeFirst</span><span class="p">(),</span>
    <span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">scrapy.loader</span> <span class="kn">import</span> <span class="n">ItemLoader</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">il</span> <span class="o">=</span> <span class="n">ItemLoader</span><span class="p">(</span><span class="n">item</span><span class="o">=</span><span class="n">Product</span><span class="p">())</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">il</span><span class="p">.</span><span class="n">add_value</span><span class="p">(</span><span class="s">'name'</span><span class="p">,</span> <span class="p">[</span><span class="sa">u</span><span class="s">'Welcome to my'</span><span class="p">,</span> <span class="sa">u</span><span class="s">'&lt;strong&gt;website&lt;/strong&gt;'</span><span class="p">])</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">il</span><span class="p">.</span><span class="n">add_value</span><span class="p">(</span><span class="s">'price'</span><span class="p">,</span> <span class="p">[</span><span class="sa">u</span><span class="s">'&amp;euro;'</span><span class="p">,</span> <span class="sa">u</span><span class="s">'&lt;span&gt;1000&lt;/span&gt;'</span><span class="p">])</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">il</span><span class="p">.</span><span class="n">load_item</span><span class="p">()</span>
<span class="p">{</span><span class="s">'name'</span><span class="p">:</span> <span class="sa">u</span><span class="s">'Welcome to my website'</span><span class="p">,</span> <span class="s">'price'</span><span class="p">:</span> <span class="sa">u</span><span class="s">'1000'</span><span class="p">}</span>
</code></pre></div></div>

<p>è¾“å…¥å’Œè¾“å‡ºå¤„ç†å™¨çš„ä¼˜å…ˆé¡ºåºå¦‚ä¸‹ï¼š</p>

<ul>
  <li>1.<code class="language-plaintext highlighter-rouge">Item Loader</code>ç‰¹å®šäºå­—æ®µçš„å±æ€§ï¼š<code class="language-plaintext highlighter-rouge">field_in</code>å’Œ<code class="language-plaintext highlighter-rouge">field_out</code>ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰</li>
  <li>2.å­—æ®µå…ƒæ•°æ®ï¼ˆ<code class="language-plaintext highlighter-rouge">input_processor</code>å’Œ<code class="language-plaintext highlighter-rouge">output_processor</code>é”®ï¼‰</li>
  <li>3.<code class="language-plaintext highlighter-rouge">Item Loader</code>çš„é»˜è®¤è®¾ç½®ï¼š<code class="language-plaintext highlighter-rouge">ItemLoader.default_input_processor()</code>å’Œ<code class="language-plaintext highlighter-rouge">ItemLoader.default_output_processor()</code>ï¼ˆæœ€ä½ä¼˜å…ˆçº§ï¼‰</li>
</ul>

<h1 id="5item-loader-context">5.Item Loader Context</h1>

<p>Item Loaderä¸Šä¸‹æ–‡æ˜¯åœ¨<code class="language-plaintext highlighter-rouge">Item Loader</code>ä¸­æ‰€æœ‰è¾“å…¥å’Œè¾“å‡ºå¤„ç†å™¨ä¹‹é—´å…±äº«çš„ä»»æ„<code class="language-plaintext highlighter-rouge">key/values</code>çš„å­—å…¸ã€‚å¯ä»¥åœ¨å£°æ˜ï¼Œå®ä¾‹åŒ–æˆ–ä½¿ç”¨Item Loaderæ—¶ä¼ é€’ã€‚å®ƒä»¬ç”¨äºä¿®æ”¹<code class="language-plaintext highlighter-rouge">input/output</code>å¤„ç†å™¨çš„è¡Œä¸ºã€‚</p>

<p>ä¾‹å¦‚ï¼Œå‡è®¾æ‚¨æœ‰ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">parse_length</code>å‡½æ•°ï¼Œè¯¥å‡½æ•°æ¥æ”¶æ–‡æœ¬å€¼å¹¶ä»ä¸­æå–ä¸€ä¸ªé•¿åº¦ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">parse_length</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">loader_context</span><span class="p">):</span>
    <span class="n">unit</span> <span class="o">=</span> <span class="n">loader_context</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'unit'</span><span class="p">,</span> <span class="s">'m'</span><span class="p">)</span>
    <span class="c1"># ... length parsing code goes here ...
</span>    <span class="k">return</span> <span class="n">parsed_length</span>
</code></pre></div></div>

<p>é€šè¿‡æ¥å—<code class="language-plaintext highlighter-rouge">loader_context</code>å‚æ•°ï¼Œè¯¥å‡½æ•°æ˜¾å¼åœ°å‘Šè¯‰<code class="language-plaintext highlighter-rouge">Item Loader</code>å®ƒå¯ä»¥æ¥æ”¶<code class="language-plaintext highlighter-rouge">Item Loader</code>ä¸Šä¸‹æ–‡ï¼Œ<code class="language-plaintext highlighter-rouge">Item Loader</code>åœ¨è°ƒç”¨å®ƒæ—¶ä¼ é€’å½“å‰æ´»åŠ¨çš„ä¸Šä¸‹æ–‡ï¼Œå› æ­¤å¤„ç†å™¨å‡½æ•°ï¼ˆåœ¨è¿™ç§æƒ…å†µä¸‹ä¸ºparse_lengthï¼‰å¯ä»¥ä½¿ç”¨å®ƒä»¬ã€‚</p>

<p>æœ‰å‡ ç§æ–¹æ³•å¯ä»¥ä¿®æ”¹<code class="language-plaintext highlighter-rouge">Item Loader</code>ä¸Šä¸‹æ–‡å€¼ï¼š</p>

<p>1.é€šè¿‡ä¿®æ”¹å½“å‰æ´»åŠ¨çš„<code class="language-plaintext highlighter-rouge">Item Loader</code>ä¸Šä¸‹æ–‡ï¼ˆ<code class="language-plaintext highlighter-rouge">context</code>å±æ€§ï¼‰ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">loader</span> <span class="o">=</span> <span class="n">ItemLoader</span><span class="p">(</span><span class="n">product</span><span class="p">)</span>
<span class="n">loader</span><span class="p">.</span><span class="n">context</span><span class="p">[</span><span class="s">'unit'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'cm'</span>
</code></pre></div></div>

<p>2.åœ¨<code class="language-plaintext highlighter-rouge">Item Loader</code>å®ä¾‹åŒ–ä¸Šï¼ˆItem Loaderæ„é€ å‡½æ•°çš„å…³é”®å­—å‚æ•°å­˜å‚¨åœ¨Item Loaderä¸Šä¸‹æ–‡ä¸­ï¼‰ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">loader</span> <span class="o">=</span> <span class="n">ItemLoader</span><span class="p">(</span><span class="n">product</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s">'cm'</span><span class="p">)</span>
</code></pre></div></div>

<p>3.åœ¨<code class="language-plaintext highlighter-rouge">Item Loader</code>å£°æ˜ä¸Šï¼Œå¯¹äºé‚£äº›æ”¯æŒä½¿ç”¨Item Loaderä¸Šä¸‹æ–‡å®ä¾‹åŒ–å®ƒä»¬çš„<code class="language-plaintext highlighter-rouge">input/output</code>å¤„ç†å™¨ã€‚<code class="language-plaintext highlighter-rouge">MapCompose</code>æ˜¯å…¶ä¸­ä¹‹ä¸€ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ProductLoader</span><span class="p">(</span><span class="n">ItemLoader</span><span class="p">):</span>
    <span class="n">length_out</span> <span class="o">=</span> <span class="n">MapCompose</span><span class="p">(</span><span class="n">parse_length</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s">'cm'</span><span class="p">)</span>
</code></pre></div></div>

<h1 id="6itemloader-objects">6.ItemLoader objects</h1>

<blockquote>
  <p>classscrapy.loader.ItemLoader([item, selector, response, ]**kwargs</p>
</blockquote>

<p>è¿”å›ä¸€ä¸ªæ–°çš„<code class="language-plaintext highlighter-rouge">item loader</code>ä»¥å¡«å……ç»™å®šçš„itemã€‚å¦‚æœæ²¡æœ‰ç»™å‡ºä»»ä½•<code class="language-plaintext highlighter-rouge">item</code>ï¼Œåˆ™ä½¿ç”¨<code class="language-plaintext highlighter-rouge">default_item_class</code>ä¸­çš„ç±»è‡ªåŠ¨å®ä¾‹åŒ–ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">itme</code></p>

<p>å½“ä½¿ç”¨<code class="language-plaintext highlighter-rouge">selector</code>æˆ–<code class="language-plaintext highlighter-rouge">response</code>å‚æ•°å®ä¾‹åŒ–æ—¶ï¼Œ<code class="language-plaintext highlighter-rouge">ItemLoader</code>ç±»æä¾›äº†ä½¿ç”¨<code class="language-plaintext highlighter-rouge">selectors</code>ä»ç½‘é¡µæå–æ•°æ®çš„ä¾¿æ·æœºåˆ¶ã€‚</p>

<h4 id="parameters">Parameters</h4>

<ul>
  <li>item(Item object) â€“ ä½¿ç”¨åç»­å¯¹<code class="language-plaintext highlighter-rouge">add_xpath()</code>ï¼Œ<code class="language-plaintext highlighter-rouge">add_css()</code>æˆ– <code class="language-plaintext highlighter-rouge">add_value()</code>çš„è°ƒç”¨æ¥å¡«å……çš„é¡¹ç›®å®ä¾‹ã€‚</li>
  <li>selector (Selector object) - å½“ä½¿ç”¨<code class="language-plaintext highlighter-rouge">add_xpath()</code>ï¼ˆ<code class="language-plaintext highlighter-rouge">resp.add_css()</code>ï¼‰æˆ–<code class="language-plaintext highlighter-rouge">replace_xpath()</code>ï¼ˆ<code class="language-plaintext highlighter-rouge">resp.replace_css()</code>ï¼‰æ–¹æ³•æ—¶ä»ä¸­æå–æ•°æ®çš„é€‰æ‹©å™¨ã€‚</li>
  <li>response(Response object) â€“ é™¤éæŒ‡å®šäº†é€‰æ‹©å™¨å‚æ•°ï¼Œå¦åˆ™ä½¿ç”¨<code class="language-plaintext highlighter-rouge">default_selector_class</code>æ„é€ é€‰æ‹©å™¨çš„å“åº”ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå°†å¿½ç•¥è¯¥å‚æ•°ã€‚</li>
</ul>

<p><code class="language-plaintext highlighter-rouge">item</code>, <code class="language-plaintext highlighter-rouge">selector</code>, <code class="language-plaintext highlighter-rouge">response</code>å’Œå…¶ä½™å…³é”®å­—å‚æ•°éƒ½åˆ†é…ç»™Loaderä¸Šä¸‹æ–‡ï¼ˆå¯é€šè¿‡contextå±æ€§è®¿é—®ï¼‰ã€‚</p>

<h4 id="itemloaderå®ä¾‹å…·æœ‰ä»¥ä¸‹æ–¹æ³•">ItemLoaderå®ä¾‹å…·æœ‰ä»¥ä¸‹æ–¹æ³•ï¼š</h4>

<table>
  <thead>
    <tr>
      <th>æ–¹æ³•</th>
      <th>æè¿°</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>get_value(value, *processors, **kwargs)</td>
      <td>é€šè¿‡ç»™å®šçš„å¤„ç†å™¨å’Œå…³é”®å­—å‚æ•°å¤„ç†ç»™å®šçš„å€¼ã€‚</td>
    </tr>
    <tr>
      <td>add_value(field_name, value, *processors, **kwargs)</td>
      <td>ä¸ºç»™å®šå­—æ®µæ·»åŠ ç»™å®šå€¼</td>
    </tr>
    <tr>
      <td>replace_value(field_name, value, *processors, **kwargs)</td>
      <td>ä¸<code class="language-plaintext highlighter-rouge">add_value()</code>ç±»ä¼¼ï¼Œä½†ç”¨æ–°å€¼æ›¿æ¢æ”¶é›†çš„æ•°æ®ï¼Œè€Œä¸æ˜¯æ·»åŠ æ–°å€¼</td>
    </tr>
    <tr>
      <td>get_xpath(xpath, *processors, **kwargs)</td>
      <td>ä¸<code class="language-plaintext highlighter-rouge">ItemLoader.get_value()</code>ç±»ä¼¼ï¼Œä½†æ¥æ”¶<code class="language-plaintext highlighter-rouge">XPath</code>è€Œä¸æ˜¯<code class="language-plaintext highlighter-rouge">å€¼</code>,è¯¥å€¼ç”¨äºä»ä¸æ­¤<code class="language-plaintext highlighter-rouge">ItemLoader</code>å…³è”çš„é€‰æ‹©å™¨ä¸­æå–Unicodeå­—ç¬¦ä¸²åˆ—è¡¨ã€‚</td>
    </tr>
    <tr>
      <td>add_xpath(field_name, xpath, *processors, **kwargs)</td>
      <td>ä¸<code class="language-plaintext highlighter-rouge">ItemLoader.add_value()</code>ç±»ä¼¼ï¼Œä½†æ¥æ”¶<code class="language-plaintext highlighter-rouge">XPath</code>è€Œä¸æ˜¯å€¼ï¼Œè¯¥å€¼ç”¨äºä»ä¸æ­¤<code class="language-plaintext highlighter-rouge">ItemLoader</code>å…³è”çš„é€‰æ‹©å™¨ä¸­æå–Unicodeå­—ç¬¦ä¸²åˆ—è¡¨ã€‚</td>
    </tr>
    <tr>
      <td>replace_xpath(field_name, xpath, *processors, **kwargs)</td>
      <td><code class="language-plaintext highlighter-rouge">ä¸add_xpath()</code>ç±»ä¼¼ï¼Œä½†æ˜¯æ›¿æ¢æ”¶é›†çš„æ•°æ®è€Œä¸æ˜¯æ·»åŠ æ•°æ®ã€‚</td>
    </tr>
    <tr>
      <td>get_css(css, *processors, **kwargs)</td>
      <td>ä¸<code class="language-plaintext highlighter-rouge">ItemLoader.get_value()</code>ç±»ä¼¼ï¼Œä½†æ˜¯æ¥æ”¶<code class="language-plaintext highlighter-rouge">CSSé€‰æ‹©å™¨</code>è€Œä¸æ˜¯å€¼ï¼Œè¯¥é€‰æ‹©å™¨ç”¨äºä»ä¸æ­¤<code class="language-plaintext highlighter-rouge">ItemLoader</code>å…³è”çš„é€‰æ‹©å™¨ä¸­æå–Unicodeå­—ç¬¦ä¸²åˆ—è¡¨</td>
    </tr>
    <tr>
      <td>add_css(field_name, css, *processors, **kwargs)</td>
      <td>ä¸<code class="language-plaintext highlighter-rouge">ItemLoader.add_value()</code>ç±»ä¼¼ï¼Œä½†æ¥æ”¶<code class="language-plaintext highlighter-rouge">CSSé€‰æ‹©å™¨</code>è€Œä¸æ˜¯å€¼ï¼Œè¯¥é€‰æ‹©å™¨ç”¨äºä»ä¸æ­¤<code class="language-plaintext highlighter-rouge">ItemLoader</code>å…³è”çš„é€‰æ‹©å™¨ä¸­æå–Unicodeå­—ç¬¦ä¸²åˆ—è¡¨ã€‚</td>
    </tr>
    <tr>
      <td>replace_css(field_name, css, *processors, **kwargs)</td>
      <td>ä¸<code class="language-plaintext highlighter-rouge">add_css()</code>ç±»ä¼¼ï¼Œä½†æ›¿æ¢æ”¶é›†çš„æ•°æ®è€Œä¸æ˜¯æ·»åŠ æ•°æ®ã€‚</td>
    </tr>
    <tr>
      <td>load_item()</td>
      <td>ä½¿ç”¨åˆ°ç›®å‰ä¸ºæ­¢æ”¶é›†çš„æ•°æ®å¡«å……é¡¹ç›®ï¼Œç„¶åå°†å…¶è¿”å›ã€‚æ”¶é›†çš„æ•°æ®é¦–å…ˆé€šè¿‡è¾“å‡ºå¤„ç†å™¨ä¼ é€’ï¼Œä»¥è·å–æœ€ç»ˆå€¼ä»¥åˆ†é…ç»™æ¯ä¸ªé¡¹ç›®å­—æ®µã€‚</td>
    </tr>
    <tr>
      <td>nested_xpath(xpath)</td>
      <td>ä½¿ç”¨xpathé€‰æ‹©å™¨åˆ›å»ºä¸€ä¸ªåµŒå¥—çš„åŠ è½½å™¨ã€‚æä¾›çš„é€‰æ‹©å™¨ç›¸å¯¹äºä¸æ­¤<code class="language-plaintext highlighter-rouge">ItemLoader</code>å…³è”çš„é€‰æ‹©å™¨åº”ç”¨ã€‚åµŒå¥—çš„åŠ è½½å™¨ä¸çˆ¶<code class="language-plaintext highlighter-rouge">ItemLoader</code>å…±äº«è¯¥Itemï¼Œå› æ­¤å¯¹<code class="language-plaintext highlighter-rouge">add_xpath()</code>ï¼Œ<code class="language-plaintext highlighter-rouge">add_value()</code>ï¼Œ<code class="language-plaintext highlighter-rouge">replace_value()</code>ç­‰çš„è°ƒç”¨å°†æŒ‰é¢„æœŸè¿›è¡Œã€‚</td>
    </tr>
    <tr>
      <td>get_collected_values(field_name)</td>
      <td>è¿”å›ç»™å®šå­—æ®µçš„æ”¶é›†å€¼</td>
    </tr>
    <tr>
      <td>get_output_value(field_name)</td>
      <td>å¯¹äºç»™å®šçš„å­—æ®µï¼Œè¿”å›ä½¿ç”¨è¾“å‡ºå¤„ç†å™¨è§£æçš„æ”¶é›†å€¼ã€‚æ­¤æ–¹æ³•å®Œå…¨ä¸ä¼šå¡«å……æˆ–ä¿®æ”¹é¡¹ç›®ã€‚</td>
    </tr>
    <tr>
      <td>get_input_processor(field_name)</td>
      <td>è¿”å›ç»™å®šå­—æ®µçš„è¾“å…¥å¤„ç†å™¨</td>
    </tr>
    <tr>
      <td>get_output_processor(field_name)</td>
      <td>è¿”å›ç»™å®šå­—æ®µçš„è¾“å‡ºå¤„ç†å™¨</td>
    </tr>
  </tbody>
</table>

<h4 id="itemloaderå®ä¾‹å…·æœ‰ä»¥ä¸‹å±æ€§">ItemLoaderå®ä¾‹å…·æœ‰ä»¥ä¸‹å±æ€§ï¼š</h4>

<table>
  <thead>
    <tr>
      <th>å±æ€§</th>
      <th>æè¿°</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>item</td>
      <td>æ­¤Item Loaderè§£æçš„Itemå¯¹è±¡</td>
    </tr>
    <tr>
      <td>context</td>
      <td>æ­¤é¡¹ç›®åŠ è½½å™¨çš„å½“å‰æ´»åŠ¨ä¸Šä¸‹æ–‡</td>
    </tr>
    <tr>
      <td>default_item_class</td>
      <td>Itemç±»ï¼ˆæˆ–å·¥å‚ï¼‰ï¼Œç”¨äºåœ¨æ„é€ å‡½æ•°ä¸­æœªæŒ‡å®šæ—¶å®ä¾‹åŒ–é¡¹ç›®</td>
    </tr>
    <tr>
      <td>default_input_processor</td>
      <td>ç”¨äºé‚£äº›æœªæŒ‡å®šä¸€ä¸ªå­—æ®µçš„é»˜è®¤è¾“å…¥å¤„ç†å™¨</td>
    </tr>
    <tr>
      <td>default_output_processor</td>
      <td>ç”¨äºæœªæŒ‡å®šä¸€ä¸ªå­—æ®µçš„é»˜è®¤è¾“å‡ºå¤„ç†å™¨</td>
    </tr>
    <tr>
      <td>default_selector_class</td>
      <td>å¦‚æœæ„é€ å‡½æ•°ä¸­ä»…ç»™å‡ºå“åº”ï¼Œåˆ™ç”¨äºæ„é€ æ­¤ItemLoaderçš„é€‰æ‹©å™¨çš„ç±»ã€‚å¦‚æœåœ¨æ„é€ å‡½æ•°ä¸­æŒ‡å®šäº†é€‰æ‹©å™¨ï¼Œåˆ™å¿½ç•¥æ­¤å±æ€§ã€‚æœ‰æ—¶åœ¨å­ç±»ä¸­è¦†ç›–æ­¤å±æ€§</td>
    </tr>
    <tr>
      <td>selector</td>
      <td>ä»ä¸­æå–æ•°æ®çš„Selectorå¯¹è±¡ã€‚å®ƒæ—¢å¯ä»¥æ˜¯æ„é€ å‡½æ•°ä¸­æŒ‡å®šçš„é€‰æ‹©å™¨ï¼Œä¹Ÿå¯ä»¥æ˜¯ä½¿ç”¨<code class="language-plaintext highlighter-rouge">default_selector_class</code>æ ¹æ®æ„é€ å‡½æ•°ä¸­æŒ‡å®šçš„å“åº”åˆ›å»ºçš„é€‰æ‹©å™¨ã€‚æ­¤å±æ€§åº”ä¸ºåªè¯»</td>
    </tr>
  </tbody>
</table>

<h1 id="7åµŒå¥—åŠ è½½å™¨">7.åµŒå¥—åŠ è½½å™¨</h1>

<h4 id="nested-loaders">Nested Loaders</h4>
<p>ä»æ–‡æ¡£çš„å­éƒ¨åˆ†è§£æç›¸å…³å€¼æ—¶ï¼Œåˆ›å»ºåµŒå¥—çš„åŠ è½½å™¨å¯èƒ½å¾ˆæœ‰ç”¨ã€‚å‡è®¾æ‚¨è¦ä»é¡µé¢çš„é¡µè„šä¸­æå–è¯¦ç»†ä¿¡æ¯ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;footer&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"social"</span> <span class="na">href=</span><span class="s">"https://facebook.com/whatever"</span><span class="nt">&gt;</span>Like Us<span class="nt">&lt;/a&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"social"</span> <span class="na">href=</span><span class="s">"https://twitter.com/whatever"</span><span class="nt">&gt;</span>Follow Us<span class="nt">&lt;/a&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"email"</span> <span class="na">href=</span><span class="s">"mailto:whatever@example.com"</span><span class="nt">&gt;</span>Email Us<span class="nt">&lt;/a&gt;</span>
<span class="nt">&lt;/footer&gt;</span>
</code></pre></div></div>

<p>å¦‚æœæ²¡æœ‰<code class="language-plaintext highlighter-rouge">nested loaders</code>ï¼Œåˆ™éœ€è¦ä¸ºè¦æå–çš„æ¯ä¸ªå€¼æŒ‡å®šå®Œæ•´çš„<code class="language-plaintext highlighter-rouge">xpathï¼ˆæˆ–cssï¼‰</code></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">loader</span> <span class="o">=</span> <span class="n">ItemLoader</span><span class="p">(</span><span class="n">item</span><span class="o">=</span><span class="n">Item</span><span class="p">())</span>
<span class="c1"># load stuff not in the footer
</span><span class="n">loader</span><span class="p">.</span><span class="n">add_xpath</span><span class="p">(</span><span class="s">'social'</span><span class="p">,</span> <span class="s">'//footer/a[@class = "social"]/@href'</span><span class="p">)</span>
<span class="n">loader</span><span class="p">.</span><span class="n">add_xpath</span><span class="p">(</span><span class="s">'email'</span><span class="p">,</span> <span class="s">'//footer/a[@class = "email"]/@href'</span><span class="p">)</span>
<span class="n">loader</span><span class="p">.</span><span class="n">load_item</span><span class="p">()</span>
</code></pre></div></div>
<p>ç›¸åï¼Œæ‚¨å¯ä»¥ä½¿ç”¨é¡µè„šé€‰æ‹©å™¨åˆ›å»ºä¸€ä¸ª<code class="language-plaintext highlighter-rouge">nested loaders</code>ï¼Œå¹¶æ·»åŠ ç›¸å¯¹äºé¡µè„šçš„å€¼ã€‚åŠŸèƒ½ç›¸åŒï¼Œä½†é¿å…é‡å¤é¡µè„šé€‰æ‹©å™¨ã€‚</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">loader</span> <span class="o">=</span> <span class="n">ItemLoader</span><span class="p">(</span><span class="n">item</span><span class="o">=</span><span class="n">Item</span><span class="p">())</span>
<span class="c1"># load stuff not in the footer
</span><span class="n">footer_loader</span> <span class="o">=</span> <span class="n">loader</span><span class="p">.</span><span class="n">nested_xpath</span><span class="p">(</span><span class="s">'//footer'</span><span class="p">)</span>
<span class="n">footer_loader</span><span class="p">.</span><span class="n">add_xpath</span><span class="p">(</span><span class="s">'social'</span><span class="p">,</span> <span class="s">'a[@class = "social"]/@href'</span><span class="p">)</span>
<span class="n">footer_loader</span><span class="p">.</span><span class="n">add_xpath</span><span class="p">(</span><span class="s">'email'</span><span class="p">,</span> <span class="s">'a[@class = "email"]/@href'</span><span class="p">)</span>
<span class="c1"># no need to call footer_loader.load_item()
</span><span class="n">loader</span><span class="p">.</span><span class="n">load_item</span><span class="p">()</span>
</code></pre></div></div>

<p>æ‚¨å¯ä»¥ä»»æ„åµŒå¥—è£…è½½ç¨‹åºï¼Œå®ƒä»¬å¯ä»¥ä¸xpathæˆ–cssé€‰æ‹©å™¨ä¸€èµ·ä½¿ç”¨ã€‚ä½œä¸ºä¸€èˆ¬å‡†åˆ™ï¼Œå½“åµŒå¥—åŠ è½½å™¨ä½¿æ‚¨çš„ä»£ç æ›´ç®€å•ä½†åˆä¸ä¼šè¿‡å¤šåµŒå¥—æ—¶ï¼Œè¯·ä½¿ç”¨åµŒå¥—åŠ è½½å™¨ï¼Œå¦åˆ™è§£æå™¨å¯èƒ½å˜å¾—éš¾ä»¥é˜…è¯»ã€‚</p>

<h1 id="8è¦†ç›–å’Œæ‰©å±•item-loaders">8.è¦†ç›–å’Œæ‰©å±•Item Loaders</h1>

<h4 id="reusing-and-extending-item-loaders">Reusing and extending Item Loaders</h4>

<p>éšç€æ‚¨çš„é¡¹ç›®å˜å¾—è¶Šæ¥è¶Šå¤§å¹¶è·å¾—è¶Šæ¥è¶Šå¤šçš„èœ˜è››ï¼Œç»´æŠ¤æˆä¸ºä¸€ä¸ªåŸºæœ¬é—®é¢˜ï¼Œå°¤å…¶æ˜¯å½“æ‚¨å¿…é¡»ä¸ºæ¯ä¸ªèœ˜è››å¤„ç†è®¸å¤šä¸åŒçš„è§£æè§„åˆ™ï¼Œæœ‰å¾ˆå¤šå¼‚å¸¸å¹¶ä¸”è¿˜æƒ³é‡ç”¨å…¬å…±å¤„ç†å™¨æ—¶ã€‚</p>

<p><code class="language-plaintext highlighter-rouge">Item Loader</code>æ—¨åœ¨å‡è½»è§£æè§„åˆ™çš„ç»´æŠ¤è´Ÿæ‹…ï¼Œè€Œåˆä¸å¤±å»çµæ´»æ€§ï¼ŒåŒæ—¶ï¼Œæä¾›äº†ä¸€ç§æ–¹ä¾¿çš„æœºåˆ¶æ¥æ‰©å±•å’Œ<code class="language-plaintext highlighter-rouge">è¦†ç›–</code>å®ƒä»¬ã€‚å› æ­¤ï¼ŒItem Loaderæ”¯æŒä¼ ç»Ÿçš„Pythonç±»ç»§æ‰¿æ¥å¤„ç†ç‰¹å®šèœ˜è››ï¼ˆæˆ–èœ˜è››ç»„ï¼‰çš„å·®å¼‚ã€‚</p>

<p>ä¾‹å¦‚ï¼Œå‡è®¾æŸä¸ªç‰¹å®šçš„ç½‘ç«™å°†å…¶äº§å“åç§°æ‹¬åœ¨ä¸‰ä¸ªç ´æŠ˜å·ä¸­ï¼ˆä¾‹å¦‚â€” Plasma TV â€”ï¼‰ï¼Œè€Œæ‚¨æœ€ç»ˆä¸æƒ³å°†è¿™äº›ç ´æŠ˜å·åˆ®åˆ°æœ€ç»ˆäº§å“åç§°ä¸­ã€‚</p>

<p>é€šè¿‡<code class="language-plaintext highlighter-rouge">é‡æ–°</code>ä½¿ç”¨å’Œ<code class="language-plaintext highlighter-rouge">æ‰©å±•é»˜</code>è®¤çš„Product Item Loaderï¼ˆProductLoaderï¼‰ï¼Œæ‚¨å¯ä»¥æŒ‰ç…§ä»¥ä¸‹æ–¹æ³•åˆ é™¤è¿™äº›ç ´æŠ˜å·ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">scrapy.loader.processors</span> <span class="kn">import</span> <span class="n">MapCompose</span>
<span class="kn">from</span> <span class="nn">myproject.ItemLoaders</span> <span class="kn">import</span> <span class="n">ProductLoader</span>

<span class="k">def</span> <span class="nf">strip_dashes</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">.</span><span class="n">strip</span><span class="p">(</span><span class="s">'-'</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">SiteSpecificLoader</span><span class="p">(</span><span class="n">ProductLoader</span><span class="p">):</span>
    <span class="n">name_in</span> <span class="o">=</span> <span class="n">MapCompose</span><span class="p">(</span><span class="n">strip_dashes</span><span class="p">,</span> <span class="n">ProductLoader</span><span class="p">.</span><span class="n">name_in</span><span class="p">)</span>
</code></pre></div></div>

<p>æ‰©å±•é¡¹ç›®åŠ è½½å™¨å¯èƒ½éå¸¸æœ‰ç”¨çš„å¦ä¸€ç§æƒ…å†µæ˜¯ï¼Œå½“æ‚¨å…·æœ‰å¤šç§æºæ ¼å¼æ—¶ï¼Œä¾‹å¦‚XMLå’ŒHTMLã€‚åœ¨XMLç‰ˆæœ¬ä¸­ï¼Œæ‚¨å¯èƒ½è¦åˆ é™¤CDATAå‡ºç°çš„åœ°æ–¹ã€‚è¿™æ˜¯æ“ä½œæ–¹æ³•ç¤ºä¾‹ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">scrapy.loader.processors</span> <span class="kn">import</span> <span class="n">MapCompose</span>
<span class="kn">from</span> <span class="nn">myproject.ItemLoaders</span> <span class="kn">import</span> <span class="n">ProductLoader</span>
<span class="kn">from</span> <span class="nn">myproject.utils.xml</span> <span class="kn">import</span> <span class="n">remove_cdata</span>

<span class="k">class</span> <span class="nc">XmlProductLoader</span><span class="p">(</span><span class="n">ProductLoader</span><span class="p">):</span>
    <span class="n">name_in</span> <span class="o">=</span> <span class="n">MapCompose</span><span class="p">(</span><span class="n">remove_cdata</span><span class="p">,</span> <span class="n">ProductLoader</span><span class="p">.</span><span class="n">name_in</span><span class="p">)</span>
</code></pre></div></div>

<p>è¿™å°±æ˜¯é€šå¸¸æ‰©å±•è¾“å…¥å¤„ç†å™¨çš„æ–¹å¼ã€‚</p>

<p>å¯¹äºè¾“å‡ºå¤„ç†å™¨ï¼Œæ›´å¸¸è§çš„æ˜¯åœ¨å­—æ®µå…ƒæ•°æ®ä¸­å£°æ˜å®ƒä»¬ï¼Œå› ä¸ºå®ƒä»¬é€šå¸¸ä»…å–å†³äºå­—æ®µï¼Œè€Œä¸å–å†³äºæ¯ä¸ªç‰¹å®šçš„ç«™ç‚¹è§£æè§„åˆ™ï¼ˆå°±åƒè¾“å…¥å¤„ç†å™¨ä¸€æ ·ï¼‰</p>

<p>è¿˜æœ‰è®¸å¤šå…¶ä»–å¯èƒ½çš„æ–¹å¼æ¥æ‰©å±•ï¼Œç»§æ‰¿å’Œè¦†ç›–é¡¹ç›®åŠ è½½ç¨‹åºï¼Œå¹¶ä¸”ä¸åŒçš„é¡¹ç›®åŠ è½½ç¨‹åºå±‚æ¬¡ç»“æ„å¯èƒ½æ›´é€‚åˆä¸åŒçš„é¡¹ç›®ã€‚Scrapyä»…æä¾›æœºåˆ¶ã€‚å®ƒä¸ä¼šå¼ºåŠ æ‚¨çš„Loadersé›†åˆçš„ä»»ä½•ç‰¹å®šç»„ç»‡-å–å†³äºæ‚¨å’Œæ‚¨é¡¹ç›®çš„éœ€æ±‚</p>

<h1 id="9å†…ç½®å¤„ç†å™¨">9.å†…ç½®å¤„ç†å™¨</h1>

<h4 id="available-built-in-processors">Available built-in processors</h4>

<p>å³ä½¿æ‚¨å¯ä»¥ä½¿ç”¨ä»»ä½•å¯è°ƒç”¨å‡½æ•°ä½œä¸ºè¾“å…¥å’Œè¾“å‡ºå¤„ç†å™¨ï¼ŒScrapyä»æä¾›äº†ä¸€äº›å¸¸ç”¨çš„å¤„ç†å™¨ï¼Œå¦‚ä¸‹æ‰€è¿°ã€‚å…¶ä¸­ä¸€äº›å‡½æ•°ï¼Œä¾‹å¦‚<code class="language-plaintext highlighter-rouge">MapCompose</code>ï¼ˆé€šå¸¸ç”¨ä½œè¾“å…¥å¤„ç†å™¨ï¼‰ç»„æˆäº†æŒ‰é¡ºåºæ‰§è¡Œçš„å¤šä¸ªå‡½æ•°çš„è¾“å‡ºï¼Œä»¥ç”Ÿæˆæœ€ç»ˆçš„è§£æå€¼</p>

<h3 id="class-scrapyloaderprocessorsidentity">class scrapy.loader.processors.Identity</h3>

<p>æœ€ç®€å•çš„å¤„ç†å™¨ï¼Œä»€ä¹ˆéƒ½ä¸åšã€‚å®ƒè¿”å›åŸå§‹å€¼ä¸å˜ã€‚å®ƒä¸æ¥æ”¶ä»»ä½•æ„é€ å‡½æ•°å‚æ•°ï¼Œä¹Ÿä¸æ¥å—Loaderä¸Šä¸‹æ–‡ã€‚</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">scrapy.loader.processors</span> <span class="kn">import</span> <span class="n">Identity</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">proc</span> <span class="o">=</span> <span class="n">Identity</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">proc</span><span class="p">([</span><span class="s">'one'</span><span class="p">,</span> <span class="s">'two'</span><span class="p">,</span> <span class="s">'three'</span><span class="p">])</span>
<span class="p">[</span><span class="s">'one'</span><span class="p">,</span> <span class="s">'two'</span><span class="p">,</span> <span class="s">'three'</span><span class="p">]</span>
</code></pre></div></div>

<h3 id="class-scrapyloaderprocessorstakefirst">class scrapy.loader.processors.TakeFirst</h3>

<p>ä»æ¥æ”¶åˆ°çš„å€¼ä¸­è¿”å›ç¬¬ä¸€ä¸ªéç©º/éç©ºå€¼ï¼Œå› æ­¤å®ƒé€šå¸¸ç”¨ä½œå•å€¼å­—æ®µçš„è¾“å‡ºå¤„ç†å™¨ã€‚å®ƒä¸æ¥æ”¶ä»»ä½•æ„é€ å‡½æ•°å‚æ•°ï¼Œä¹Ÿä¸æ¥å—Loaderä¸Šä¸‹æ–‡ã€‚</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">scrapy.loader.processors</span> <span class="kn">import</span> <span class="n">TakeFirst</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">proc</span> <span class="o">=</span> <span class="n">TakeFirst</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">proc</span><span class="p">([</span><span class="s">''</span><span class="p">,</span> <span class="s">'one'</span><span class="p">,</span> <span class="s">'two'</span><span class="p">,</span> <span class="s">'three'</span><span class="p">])</span>
<span class="s">'one'</span>
</code></pre></div></div>

<h3 id="class-scrapyloaderprocessorsjoinseparatoru">class scrapy.loader.processors.Join(separator=uâ€™â€™)</h3>

<p>è¿”å›ä¸æ„é€ å‡½æ•°ä¸­ç»™å®šçš„åˆ†éš”ç¬¦ç›¸è¿çš„å€¼ï¼Œé»˜è®¤ä¸º<code class="language-plaintext highlighter-rouge">u''</code>ã€‚å®ƒä¸æ¥å—Loaderä¸Šä¸‹æ–‡ã€‚</p>

<p>ä½¿ç”¨é»˜è®¤åˆ†éš”ç¬¦æ—¶ï¼Œæ­¤å¤„ç†å™¨ç­‰æ•ˆäºä»¥ä¸‹åŠŸèƒ½ï¼š<code class="language-plaintext highlighter-rouge">u''.join</code></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">scrapy.loader.processors</span> <span class="kn">import</span> <span class="n">Join</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">proc</span> <span class="o">=</span> <span class="n">Join</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">proc</span><span class="p">([</span><span class="s">'one'</span><span class="p">,</span> <span class="s">'two'</span><span class="p">,</span> <span class="s">'three'</span><span class="p">])</span>
<span class="s">'one two three'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">proc</span> <span class="o">=</span> <span class="n">Join</span><span class="p">(</span><span class="s">'&lt;br&gt;'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">proc</span><span class="p">([</span><span class="s">'one'</span><span class="p">,</span> <span class="s">'two'</span><span class="p">,</span> <span class="s">'three'</span><span class="p">])</span>
<span class="s">'one&lt;br&gt;two&lt;br&gt;three'</span>
</code></pre></div></div>

<h3 id="class-scrapyloaderprocessorscomposefunctions-default_loader_context">class scrapy.loader.processors.Compose(*functions, **default_loader_context)</h3>

<p>æ ¹æ®ç»™å®šåŠŸèƒ½çš„ç»„æˆæ„é€ çš„å¤„ç†å™¨ã€‚è¿™æ„å‘³ç€è¯¥å¤„ç†å™¨çš„æ¯ä¸ªè¾“å…¥å€¼å°†ä¼ é€’ç»™ç¬¬ä¸€ä¸ªå‡½æ•°ï¼Œè¯¥å‡½æ•°çš„ç»“æœå°†ä¼ é€’ç»™ç¬¬äºŒä¸ªå‡½æ•°ï¼Œä¾æ­¤ç±»æ¨ï¼Œç›´åˆ°æœ€åä¸€ä¸ªå‡½æ•°è¿”å›è¯¥å¤„ç†å™¨çš„è¾“å‡ºå€¼ä¸ºæ­¢ã€‚</p>

<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œåœ¨<code class="language-plaintext highlighter-rouge">None</code>å€¼ä¸Šåœæ­¢è¿›ç¨‹ã€‚å¯ä»¥é€šè¿‡ä¼ é€’å…³é”®å­—å‚æ•°<code class="language-plaintext highlighter-rouge">stop_on_none = False</code>æ¥æ›´æ”¹æ­¤è¡Œä¸ºã€‚</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">scrapy.loader.processors</span> <span class="kn">import</span> <span class="n">Compose</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">proc</span> <span class="o">=</span> <span class="n">Compose</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">.</span><span class="n">upper</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">proc</span><span class="p">([</span><span class="s">'hello'</span><span class="p">,</span> <span class="s">'world'</span><span class="p">])</span>
<span class="s">'HELLO'</span>
</code></pre></div></div>
<p>æ¯ä¸ªå‡½æ•°å¯ä»¥é€‰æ‹©æ¥æ”¶<code class="language-plaintext highlighter-rouge">loader_context</code>å‚æ•°ã€‚å¯¹äºé‚£äº›è¿™æ ·åšçš„å¤„ç†å™¨ï¼Œæ­¤å¤„ç†å™¨å°†é€šè¿‡è¯¥å‚æ•°ä¼ é€’å½“å‰æ´»åŠ¨çš„Loaderä¸Šä¸‹æ–‡ã€‚</p>

<p>æ„é€ å‡½æ•°ä¸­ä¼ é€’çš„å…³é”®å­—å‚æ•°ç”¨ä½œä¼ é€’ç»™æ¯ä¸ªå‡½æ•°è°ƒç”¨çš„é»˜è®¤Loaderä¸Šä¸‹æ–‡å€¼ã€‚ä½†æ˜¯ï¼Œä¼ é€’ç»™å‡½æ•°çš„æœ€ç»ˆLoaderä¸Šä¸‹æ–‡å€¼å°†è¢«å¯é€šè¿‡<code class="language-plaintext highlighter-rouge">ItemLoader.context()</code>å±æ€§è®¿é—®çš„å½“å‰æ´»åŠ¨Loaderä¸Šä¸‹æ–‡è¦†ç›–ã€‚</p>

<h3 id="class-scrapyloaderprocessorsmapcomposefunctions-default_loader_context">class scrapy.loader.processors.MapCompose(*functions, **default_loader_context)</h3>

<p>ç”±ç»™å®šåŠŸèƒ½çš„ç»„æˆæ„é€ çš„å¤„ç†å™¨ï¼Œç±»ä¼¼äº<code class="language-plaintext highlighter-rouge">Compose</code>å¤„ç†å™¨ã€‚ä¸è¯¥å¤„ç†å™¨çš„åŒºåˆ«åœ¨äºå†…éƒ¨ç»“æœåœ¨å‡½æ•°ä¹‹é—´ä¼ é€’çš„æ–¹å¼å¦‚ä¸‹ï¼š</p>

<p>è¿­ä»£æ­¤å¤„ç†å™¨çš„è¾“å…¥å€¼ï¼Œå¹¶å°†ç¬¬ä¸€ä¸ªåŠŸèƒ½åº”ç”¨äºæ¯ä¸ªå…ƒç´ ã€‚è¿™äº›å‡½æ•°è°ƒç”¨çš„ç»“æœï¼ˆæ¯ä¸ªå…ƒç´ ä¸€ä¸ªï¼‰è¢«ä¸²è”ä»¥æ„é€ ä¸€ä¸ªæ–°çš„Iterableï¼Œç„¶åå°†å…¶åº”ç”¨äºç¬¬äºŒä¸ªå‡½æ•°ï¼Œä¾æ­¤ç±»æ¨ï¼Œç›´åˆ°æœ€åä¸€ä¸ªå‡½æ•°åº”ç”¨äºæ‰€æ”¶é›†çš„å€¼åˆ—è¡¨ä¸­çš„æ¯ä¸ªå€¼ï¼Œè¿™æ ·è¿œã€‚æœ€åä¸€ä¸ªå‡½æ•°çš„è¾“å‡ºå€¼è¿æ¥åœ¨ä¸€èµ·ä»¥äº§ç”Ÿæ­¤å¤„ç†å™¨çš„è¾“å‡º</p>

<p>æ¯ä¸ªç‰¹å®šçš„å‡½æ•°éƒ½å¯ä»¥è¿”å›ä¸€ä¸ªå€¼æˆ–ä¸€ä¸ªå€¼åˆ—è¡¨ï¼Œè¯¥å€¼æˆ–å€¼åˆ—è¡¨å°†ç”±åº”ç”¨åˆ°å…¶ä»–è¾“å…¥å€¼çš„åŒä¸€å‡½æ•°è¿”å›çš„å€¼åˆ—è¡¨å±•å¹³ã€‚è¿™äº›å‡½æ•°è¿˜å¯ä»¥è¿”å›<code class="language-plaintext highlighter-rouge">None</code>ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¯¥å‡½æ•°çš„è¾“å‡ºå°†è¢«å¿½ç•¥ï¼Œä»¥è¿›è¡Œé“¾ä¸Šçš„è¿›ä¸€æ­¥å¤„ç†ã€‚</p>

<p>è¯¥å¤„ç†å™¨æä¾›äº†ä¸€ç§ç®€ä¾¿çš„æ–¹æ³•æ¥ç»„åˆä»…ä½¿ç”¨å•ä¸ªå€¼ï¼ˆè€Œä¸æ˜¯å¯è¿­ä»£å€¼ï¼‰çš„å‡½æ•°ã€‚ç”±äºè¿™ä¸ªåŸå› ï¼Œ<code class="language-plaintext highlighter-rouge">MapCompose</code>å¤„ç†å™¨é€šå¸¸ç”¨ä½œè¾“å…¥å¤„ç†å™¨ï¼Œå› ä¸ºæ•°æ®é€šå¸¸æ˜¯ä½¿ç”¨é€‰æ‹©å™¨çš„<code class="language-plaintext highlighter-rouge">extract()</code>æ–¹æ³•æå–çš„ï¼Œè¯¥æ–¹æ³•è¿”å›ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">Unicode</code>å­—ç¬¦ä¸²åˆ—è¡¨</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">filter_world</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="p">...</span>     <span class="k">return</span> <span class="bp">None</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s">'world'</span> <span class="k">else</span> <span class="n">x</span>
<span class="p">...</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">scrapy.loader.processors</span> <span class="kn">import</span> <span class="n">MapCompose</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">proc</span> <span class="o">=</span> <span class="n">MapCompose</span><span class="p">(</span><span class="n">filter_world</span><span class="p">,</span> <span class="nb">str</span><span class="p">.</span><span class="n">upper</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">proc</span><span class="p">([</span><span class="s">'hello'</span><span class="p">,</span> <span class="s">'world'</span><span class="p">,</span> <span class="s">'this'</span><span class="p">,</span> <span class="s">'is'</span><span class="p">,</span> <span class="s">'scrapy'</span><span class="p">])</span>
<span class="p">[</span><span class="s">'HELLO, '</span><span class="n">THIS</span><span class="s">', '</span><span class="n">IS</span><span class="s">', '</span><span class="n">SCRAPY</span><span class="s">']
</span></code></pre></div></div>

<h3 id="class-scrapyloaderprocessorsselectjmesjson_path">class scrapy.loader.processors.SelectJmes(json_path)</h3>

<p>ä½¿ç”¨æä¾›ç»™æ„é€ å‡½æ•°çš„jsonè·¯å¾„æŸ¥è¯¢å€¼å¹¶è¿”å›è¾“å‡ºã€‚éœ€è¦jmespath<a href="https://github.com/jmespath/jmespath.py" title="https://github.com/jmespath/jmespath.py">https://github.com/jmespath/jmespath.py</a>æ‰èƒ½è¿è¡Œã€‚è¯¥å¤„ç†å™¨ä¸€æ¬¡ä»…æ¥å—ä¸€ä¸ªè¾“å…¥ã€‚</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">scrapy.loader.processors</span> <span class="kn">import</span> <span class="n">SelectJmes</span><span class="p">,</span> <span class="n">Compose</span><span class="p">,</span> <span class="n">MapCompose</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">proc</span> <span class="o">=</span> <span class="n">SelectJmes</span><span class="p">(</span><span class="s">"foo"</span><span class="p">)</span> <span class="c1">#for direct use on lists and dictionaries
</span><span class="o">&gt;&gt;&gt;</span> <span class="n">proc</span><span class="p">({</span><span class="s">'foo'</span><span class="p">:</span> <span class="s">'bar'</span><span class="p">})</span>
<span class="s">'bar'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">proc</span><span class="p">({</span><span class="s">'foo'</span><span class="p">:</span> <span class="p">{</span><span class="s">'bar'</span><span class="p">:</span> <span class="s">'baz'</span><span class="p">}})</span>
<span class="p">{</span><span class="s">'bar'</span><span class="p">:</span> <span class="s">'baz'</span><span class="p">}</span>
</code></pre></div></div>

<p>ä½¿ç”¨Jsonï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">json</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">proc_single_json_str</span> <span class="o">=</span> <span class="n">Compose</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">,</span> <span class="n">SelectJmes</span><span class="p">(</span><span class="s">"foo"</span><span class="p">))</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">proc_single_json_str</span><span class="p">(</span><span class="s">'{"foo": "bar"}'</span><span class="p">)</span>
<span class="s">'bar'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">proc_json_list</span> <span class="o">=</span> <span class="n">Compose</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">,</span> <span class="n">MapCompose</span><span class="p">(</span><span class="n">SelectJmes</span><span class="p">(</span><span class="s">'foo'</span><span class="p">)))</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">proc_json_list</span><span class="p">(</span><span class="s">'[{"foo":"bar"}, {"baz":"tar"}]'</span><span class="p">)</span>
<span class="p">[</span><span class="s">'bar'</span><span class="p">]</span>
</code></pre></div></div>

:ET