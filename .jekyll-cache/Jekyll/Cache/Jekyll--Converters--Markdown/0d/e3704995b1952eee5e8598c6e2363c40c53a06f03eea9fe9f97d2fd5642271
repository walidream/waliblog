I"ãG<p>åœ¨å°èœåˆå­¦<code class="language-plaintext highlighter-rouge">scrapy</code>æ—¶ï¼Œä»googleä¸Šå‘ç°äº†å‡ ç¯‡éå¸¸ä¸é”™çš„æ–‡ç« ï¼Œæœªç»åšä¸»åŒæ„æ“…è‡ªå°†åšä¸»çš„æ–‡ç« æ”¶è—ï¼Œä¸»è¦æ€•æ—¥åçœ‹æ—¶ï¼Œæ‰¾ä¸åˆ°æ­¤æ–‡ç« ã€‚å°èœåœ¨è¿™é‡Œå‘åšä¸»è‡´æ•¬ï¼Œå¸Œæœ›çœ‹åˆ°è¿™ç¯‡å¸–å­çš„å°ä¼™ä¼´èƒ½å¤Ÿé˜…è¯»åŸè´´ã€‚</p>

<ul>
  <li><a href="http://kaito-kidd.com/2016/11/01/scrapy-code-analyze-architecture/" title="http://kaito-kidd.com/2016/11/01/scrapy-code-analyze-architecture/">Kaito åšä¸»</a></li>
</ul>

<p>ä¸Šä¸€ç¯‡æ–‡ç« ï¼š<a href="http://kaito-kidd.com/2016/11/21/scrapy-code-analyze-component-initialization/" title="http://kaito-kidd.com/2016/11/21/scrapy-code-analyze-component-initialization/">Scrapyæºç åˆ†æï¼ˆä¸‰ï¼‰æ ¸å¿ƒç»„ä»¶åˆå§‹åŒ–</a>å·²ç»åˆ†æäº†Scrapyæ ¸å¿ƒç»„ä»¶çš„ä¸»è¦èŒè´£ï¼Œä»¥åŠå®ƒä»¬åœ¨åˆå§‹åŒ–æ—¶éƒ½å®Œæˆäº†å“ªäº›å·¥ä½œã€‚</p>

<p>è¿™ç¯‡æ–‡ç« å°±è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ï¼ŒScrapyçš„æ ¸å¿ƒæµç¨‹æ˜¯å¦‚ä½•è¿è¡Œçš„ï¼Œå®ƒæ˜¯å¦‚ä½•è°ƒåº¦å„ä¸ªç»„ä»¶ï¼Œå®ŒæˆæŠ“å–å·¥ä½œçš„ã€‚</p>

<h1 id="1è¿è¡Œå…¥å£">1.è¿è¡Œå…¥å£</h1>

<p>è¿˜æ˜¯å›åˆ°æœ€åˆçš„å…¥å£ï¼Œåœ¨Scrapyæºç åˆ†æï¼ˆäºŒï¼‰è¿è¡Œå…¥å£è¿™ç¯‡æ–‡ç« ä¸­å·²ç»è®²è§£åˆ°ï¼Œåœ¨æ‰§è¡Œscrapyå‘½ä»¤æ—¶ï¼Œè°ƒç”¨æµç¨‹å¦‚ä¸‹ï¼š</p>
<ul>
  <li>è°ƒç”¨<code class="language-plaintext highlighter-rouge">cmdline.py</code>çš„<code class="language-plaintext highlighter-rouge">execute</code>æ–¹æ³•</li>
  <li>è°ƒç”¨<code class="language-plaintext highlighter-rouge">å‘½ä»¤å®ä¾‹</code>è§£æå‘½ä»¤è¡Œ</li>
  <li>æ„å»º<code class="language-plaintext highlighter-rouge">CrawlerProcess</code>å®ä¾‹ï¼Œè°ƒç”¨<code class="language-plaintext highlighter-rouge">crawl</code>å’Œ<code class="language-plaintext highlighter-rouge">start</code>æ–¹æ³•</li>
</ul>

<p>è€Œ<code class="language-plaintext highlighter-rouge">crawl</code>æ–¹æ³•æœ€ç»ˆæ˜¯è°ƒç”¨äº†<code class="language-plaintext highlighter-rouge">Cralwer</code>å®ä¾‹çš„<code class="language-plaintext highlighter-rouge">crawl</code>ï¼Œè¿™ä¸ªæ–¹æ³•æœ€ç»ˆæŠŠæ§åˆ¶æƒäº¤ç”±<code class="language-plaintext highlighter-rouge">Engine</code>ï¼Œè€Œ<code class="language-plaintext highlighter-rouge">start</code>æ–¹æ³•æ³¨å†Œå¥½åç¨‹æ± ï¼Œå¼€å§‹å¼‚æ­¥è°ƒåº¦ã€‚</p>

<p>æˆ‘ä»¬æ¥çœ‹<code class="language-plaintext highlighter-rouge">Cralwer</code>çš„<code class="language-plaintext highlighter-rouge">crawl</code>æ–¹æ³•ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">defer</span><span class="p">.</span><span class="n">inlineCallbacks</span>
<span class="k">def</span> <span class="nf">crawl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">crawling</span><span class="p">,</span> <span class="s">"Crawling already taking place"</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">crawling</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># åˆ›å»ºçˆ¬è™«å®ä¾‹
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">spider</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_create_spider</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># åˆ›å»ºå¼•æ“
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">engine</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_create_engine</span><span class="p">()</span>
        <span class="c1"># è°ƒç”¨spiderçš„start_requestsï¼Œè·å–ç§å­URL
</span>        <span class="n">start_requests</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">spider</span><span class="p">.</span><span class="n">start_requests</span><span class="p">())</span>
        <span class="c1"># è°ƒç”¨engineçš„open_spiderï¼Œäº¤ç”±å¼•æ“è°ƒåº¦
</span>        <span class="k">yield</span> <span class="bp">self</span><span class="p">.</span><span class="n">engine</span><span class="p">.</span><span class="n">open_spider</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">spider</span><span class="p">,</span> <span class="n">start_requests</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">defer</span><span class="p">.</span><span class="n">maybeDeferred</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">engine</span><span class="p">.</span><span class="n">start</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">six</span><span class="p">.</span><span class="n">PY2</span><span class="p">:</span>
            <span class="n">exc_info</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">exc_info</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">crawling</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">engine</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="p">.</span><span class="n">engine</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">six</span><span class="p">.</span><span class="n">PY2</span><span class="p">:</span>
            <span class="n">six</span><span class="p">.</span><span class="n">reraise</span><span class="p">(</span><span class="o">*</span><span class="n">exc_info</span><span class="p">)</span>
        <span class="k">raise</span>

</code></pre></div></div>

<p>åœ¨æŠŠæ§åˆ¶æƒäº¤ç»™å¼•æ“è°ƒåº¦ä¹‹å‰ï¼Œå…ˆåˆ›å»ºå‡ºçˆ¬è™«å®ä¾‹ï¼Œç„¶ååˆ›å»ºå¼•æ“å®ä¾‹ï¼ˆæ­¤è¿‡ç¨‹è§<a href="http://kaito-kidd.com/2016/11/21/scrapy-code-analyze-component-initialization/" title="http://kaito-kidd.com/2016/11/21/scrapy-code-analyze-component-initialization/">Scrapyæºç åˆ†æï¼ˆä¸‰ï¼‰æ ¸å¿ƒç»„ä»¶åˆå§‹åŒ–</a>ï¼‰ï¼Œç„¶åè°ƒç”¨äº†<code class="language-plaintext highlighter-rouge">spider</code>çš„start_requestsæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å°±æ˜¯æˆ‘ä»¬å¹³æ—¶å†™çš„æœ€å¤šçˆ¬è™«ç±»çš„çˆ¶ç±»ï¼Œå®ƒåœ¨<code class="language-plaintext highlighter-rouge">spiders/__init__.py</code>ä¸­ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">start_requests</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># æ ¹æ®å®šä¹‰å¥½çš„start_urlså±æ€§ï¼Œç”Ÿæˆç§å­URLå¯¹è±¡
</span>    <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">start_urls</span><span class="p">:</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="p">.</span><span class="n">make_requests_from_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">make_requests_from_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
    <span class="c1"># æ„å»ºRequestå¯¹è±¡
</span>    <span class="k">return</span> <span class="n">Request</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">dont_filter</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre></div></div>

<h1 id="2æ„å»ºè¯·æ±‚">2.æ„å»ºè¯·æ±‚</h1>

<p>åœ¨è¿™é‡Œæˆ‘ä»¬èƒ½çœ‹åˆ°ï¼Œå¹³æ—¶æˆ‘ä»¬å¿…é¡»è¦å®šä¹‰çš„<code class="language-plaintext highlighter-rouge">start_urls</code>ï¼ŒåŸæ¥æ˜¯åœ¨è¿™é‡Œæ‹¿æ¥æ„å»ºRequestçš„ï¼Œæ¥çœ‹Requestçš„æ˜¯å¦‚ä½•æ„å»ºçš„ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Request</span><span class="p">(</span><span class="n">object_ref</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s">'GET'</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">cookies</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">'utf-8'</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">dont_filter</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">errback</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="c1"># ç¼–ç 
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">_encoding</span> <span class="o">=</span> <span class="n">encoding</span>
        <span class="c1"># è¯·æ±‚æ–¹æ³•
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">method</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">method</span><span class="p">).</span><span class="n">upper</span><span class="p">()</span>
        <span class="c1"># è®¾ç½®url
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">_set_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="c1"># è®¾ç½®body
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">_set_body</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">priority</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span> <span class="s">"Request priority not an integer: %r"</span> <span class="o">%</span> <span class="n">priority</span>
        <span class="c1"># ä¼˜å…ˆçº§
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">priority</span> <span class="o">=</span> <span class="n">priority</span>
        <span class="k">assert</span> <span class="n">callback</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">errback</span><span class="p">,</span> <span class="s">"Cannot use errback without a callback"</span>
        <span class="c1"># å›è°ƒå‡½æ•°
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">callback</span>
        <span class="c1"># å¼‚å¸¸å›è°ƒå‡½æ•°
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">errback</span> <span class="o">=</span> <span class="n">errback</span>
        <span class="c1"># cookies
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">cookies</span> <span class="o">=</span> <span class="n">cookies</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="c1"># æ„å»ºHeader
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">headers</span> <span class="o">=</span> <span class="n">Headers</span><span class="p">(</span><span class="n">headers</span> <span class="ow">or</span> <span class="p">{},</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span>
        <span class="c1"># æ˜¯å¦éœ€è¦è¿‡æ»¤
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">dont_filter</span> <span class="o">=</span> <span class="n">dont_filter</span>
		<span class="c1"># é™„åŠ ä¿¡æ¯
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">_meta</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">meta</span><span class="p">)</span> <span class="k">if</span> <span class="n">meta</span> <span class="k">else</span> <span class="bp">None</span>
    <span class="o">@</span><span class="nb">property</span>
    <span class="k">def</span> <span class="nf">meta</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">_meta</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">_meta</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">_meta</span>
    <span class="k">def</span> <span class="nf">_get_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">_url</span>
    <span class="k">def</span> <span class="nf">_set_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">six</span><span class="p">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="k">raise</span> <span class="nb">TypeError</span><span class="p">(</span><span class="s">'Request url must be str or unicode, got %s:'</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">url</span><span class="p">).</span><span class="n">__name__</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">safe_url_string</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">encoding</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_url</span> <span class="o">=</span> <span class="n">escape_ajax</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">':'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">_url</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="s">'Missing scheme in request url: %s'</span> <span class="o">%</span> <span class="bp">self</span><span class="p">.</span><span class="n">_url</span><span class="p">)</span>
    <span class="n">url</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_url</span><span class="p">,</span> <span class="n">obsolete_setter</span><span class="p">(</span><span class="n">_set_url</span><span class="p">,</span> <span class="s">'url'</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">_get_body</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">_body</span>
    <span class="k">def</span> <span class="nf">_set_body</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">body</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">body</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">_body</span> <span class="o">=</span> <span class="s">b''</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">_body</span> <span class="o">=</span> <span class="n">to_bytes</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">encoding</span><span class="p">)</span>
    <span class="n">body</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_body</span><span class="p">,</span> <span class="n">obsolete_setter</span><span class="p">(</span><span class="n">_set_body</span><span class="p">,</span> <span class="s">'body'</span><span class="p">)</span>
</code></pre></div></div>

<p>Requestå¯¹è±¡æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯ç®€å•å°è£…äº†è¯·æ±‚å‚æ•°ã€æ–¹å¼ã€å›è°ƒä»¥åŠå¯é™„åŠ çš„å±æ€§ä¿¡æ¯ã€‚</p>

<p>å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥åœ¨å­ç±»é‡å†™<code class="language-plaintext highlighter-rouge">start_requests</code>ä»¥åŠ<code class="language-plaintext highlighter-rouge">make_requests_from_url</code>è¿™2ä¸ªæ–¹æ³•ï¼Œæ¥æ„å»ºç§å­è¯·æ±‚ã€‚</p>

<h1 id="3å¼•æ“è°ƒåº¦">3.å¼•æ“è°ƒåº¦</h1>

<p>å›åˆ°crawlæ–¹æ³•ï¼Œæ„å»ºå¥½ç§å­è¯·æ±‚å¯¹è±¡åï¼Œè°ƒç”¨äº†<code class="language-plaintext highlighter-rouge">engine</code>çš„<code class="language-plaintext highlighter-rouge">open_spider</code>æ–¹æ³•ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">defer</span><span class="p">.</span><span class="n">inlineCallbacks</span>
 <span class="k">def</span> <span class="nf">open_spider</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spider</span><span class="p">,</span> <span class="n">start_requests</span><span class="o">=</span><span class="p">(),</span> <span class="n">close_if_idle</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
     <span class="k">assert</span> <span class="bp">self</span><span class="p">.</span><span class="n">has_capacity</span><span class="p">(),</span> <span class="s">"No free spider slot when opening %r"</span> <span class="o">%</span> \
         <span class="n">spider</span><span class="p">.</span><span class="n">name</span>
     <span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Spider opened"</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s">'spider'</span><span class="p">:</span> <span class="n">spider</span><span class="p">})</span>
     <span class="c1"># æ³¨å†Œ_next_requestè°ƒåº¦æ–¹æ³•ï¼Œå¾ªç¯è°ƒåº¦
</span>     <span class="n">nextcall</span> <span class="o">=</span> <span class="n">CallLaterOnce</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">_next_request</span><span class="p">,</span> <span class="n">spider</span><span class="p">)</span>
     <span class="c1"># åˆå§‹åŒ–scheduler
</span>     <span class="n">scheduler</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">scheduler_cls</span><span class="p">.</span><span class="n">from_crawler</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">crawler</span><span class="p">)</span>
     <span class="c1"># è°ƒç”¨çˆ¬è™«ä¸­é—´ä»¶ï¼Œå¤„ç†ç§å­è¯·æ±‚
</span>     <span class="n">start_requests</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="p">.</span><span class="n">scraper</span><span class="p">.</span><span class="n">spidermw</span><span class="p">.</span><span class="n">process_start_requests</span><span class="p">(</span><span class="n">start_requests</span><span class="p">,</span> <span class="n">spider</span><span class="p">)</span>
     <span class="c1"># å°è£…Slotå¯¹è±¡
</span>     <span class="n">slot</span> <span class="o">=</span> <span class="n">Slot</span><span class="p">(</span><span class="n">start_requests</span><span class="p">,</span> <span class="n">close_if_idle</span><span class="p">,</span> <span class="n">nextcall</span><span class="p">,</span> <span class="n">scheduler</span><span class="p">)</span>
     <span class="bp">self</span><span class="p">.</span><span class="n">slot</span> <span class="o">=</span> <span class="n">slot</span>
     <span class="bp">self</span><span class="p">.</span><span class="n">spider</span> <span class="o">=</span> <span class="n">spider</span>
     <span class="c1"># è°ƒç”¨schedulerçš„open
</span>     <span class="k">yield</span> <span class="n">scheduler</span><span class="p">.</span><span class="nb">open</span><span class="p">(</span><span class="n">spider</span><span class="p">)</span>
     <span class="c1"># è°ƒç”¨scrapyerçš„open
</span>     <span class="k">yield</span> <span class="bp">self</span><span class="p">.</span><span class="n">scraper</span><span class="p">.</span><span class="n">open_spider</span><span class="p">(</span><span class="n">spider</span><span class="p">)</span>
     <span class="c1"># è°ƒç”¨statsçš„open
</span>     <span class="bp">self</span><span class="p">.</span><span class="n">crawler</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">open_spider</span><span class="p">(</span><span class="n">spider</span><span class="p">)</span>
     <span class="k">yield</span> <span class="bp">self</span><span class="p">.</span><span class="n">signals</span><span class="p">.</span><span class="n">send_catch_log_deferred</span><span class="p">(</span><span class="n">signals</span><span class="p">.</span><span class="n">spider_opened</span><span class="p">,</span> <span class="n">spider</span><span class="o">=</span><span class="n">spider</span><span class="p">)</span>
     <span class="c1"># å‘èµ·è°ƒåº¦
</span>     <span class="n">slot</span><span class="p">.</span><span class="n">nextcall</span><span class="p">.</span><span class="n">schedule</span><span class="p">()</span>
     <span class="n">slot</span><span class="p">.</span><span class="n">heartbeat</span><span class="p">.</span><span class="n">start</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</code></pre></div></div>

<p>åˆå§‹åŒ–çš„è¿‡ç¨‹ä¹‹å‰çš„æ–‡ç« å·²è®²åˆ°ï¼Œè¿™é‡Œä¸å†å¤šè¯´ã€‚ä¸»è¦è¯´ä¸€ä¸‹å¤„ç†æµç¨‹ï¼Œè¿™é‡Œç¬¬ä¸€æ­¥æ˜¯æ„å»ºäº†<code class="language-plaintext highlighter-rouge">CallLaterOnce</code>ï¼ŒæŠŠ<code class="language-plaintext highlighter-rouge">_next_request</code>æ³¨å†Œè¿›å»ï¼Œçœ‹æ­¤ç±»çš„å®ç°ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">CallLaterOnce</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="c1"># åœ¨twistedçš„reactorä¸­å¾ªç¯è°ƒåº¦ä¸€ä¸ªæ–¹æ³•
</span>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_func</span> <span class="o">=</span> <span class="n">func</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_a</span> <span class="o">=</span> <span class="n">a</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_kw</span> <span class="o">=</span> <span class="n">kw</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_call</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">def</span> <span class="nf">schedule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="c1"># ä¸Šæ¬¡å‘èµ·è°ƒåº¦ï¼Œæ‰å¯å†æ¬¡ç»§ç»­è°ƒåº¦
</span>        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">_call</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c1"># æ³¨å†Œselfåˆ°callLaterä¸­
</span>            <span class="bp">self</span><span class="p">.</span><span class="n">_call</span> <span class="o">=</span> <span class="n">reactor</span><span class="p">.</span><span class="n">callLater</span><span class="p">(</span><span class="n">delay</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">cancel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">_call</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">_call</span><span class="p">.</span><span class="n">cancel</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># ä¸Šé¢æ³¨å†Œçš„æ˜¯self,æ‰€ä»¥ä¼šæ‰§è¡Œ__call__
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">_call</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">_func</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="p">.</span><span class="n">_a</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="p">.</span><span class="n">_kw</span><span class="p">)</span>
</code></pre></div></div>

<p>è¿™é‡Œå°è£…äº†å¾ªç¯æ‰§è¡Œçš„æ–¹æ³•ç±»ï¼Œå¹¶ä¸”æ³¨å†Œçš„æ–¹æ³•ä¼šåœ¨<code class="language-plaintext highlighter-rouge">twisted</code>çš„<code class="language-plaintext highlighter-rouge">reactor</code>ä¸­å¼‚æ­¥æ‰§è¡Œï¼Œä»¥åæ‰§è¡Œåªéœ€è°ƒç”¨<code class="language-plaintext highlighter-rouge">schedule</code>æ–¹æ³•ï¼Œå°±ä¼šæ³¨å†Œselfåˆ°<code class="language-plaintext highlighter-rouge">reactor</code>çš„<code class="language-plaintext highlighter-rouge">callLater</code>ä¸­ï¼Œç„¶åå®ƒä¼šæ‰§è¡Œ<code class="language-plaintext highlighter-rouge">__call__</code>æ–¹æ³•ï¼Œè¿›è€Œæ‰§è¡Œæˆ‘ä»¬æ³¨å†Œçš„æ–¹æ³•ã€‚è€Œè¿™é‡Œæˆ‘ä»¬æ³¨å†Œçš„æ–¹æ³•æ˜¯å¼•æ“çš„<code class="language-plaintext highlighter-rouge">_next_request</code>ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ­¤æ–¹æ³•ä¼šå¾ªç¯è°ƒåº¦ï¼Œç›´åˆ°ç¨‹åºé€€å‡ºã€‚</p>

<p>ç„¶åè°ƒç”¨äº†<code class="language-plaintext highlighter-rouge">çˆ¬è™«ä¸­é—´ä»¶</code>çš„<code class="language-plaintext highlighter-rouge">process_start_requests</code>æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä½ å¯ä»¥å®šä¹‰å¤šä¸ªè‡ªå·±çš„çˆ¬è™«ä¸­é—´ä»¶ï¼Œæ¯ä¸ªç±»éƒ½é‡å†™æ­¤æ–¹æ³•ï¼Œçˆ¬è™«åœ¨è°ƒåº¦ä¹‹å‰ä¼šåˆ†åˆ«è°ƒç”¨ä½ å®šä¹‰å¥½çš„çˆ¬è™«ä¸­é—´ä»¶ï¼Œæ¥åˆ†åˆ«å¤„ç†åˆå§‹åŒ–è¯·æ±‚ï¼Œä½ å¯ä»¥è¿›è¡Œè¿‡æ»¤ã€åŠ å·¥ã€ç­›é€‰ä»¥åŠä½ æƒ³åšçš„ä»»ä½•é€»è¾‘ã€‚è¿™æ ·åšçš„å¥½å¤„å°±æ˜¯ï¼ŒæŠŠæƒ³åšçš„é€»è¾‘æ‹†åˆ†æˆåšä¸ªä¸­é—´ä»¶ï¼ŒåŠŸèƒ½ç‹¬ç«‹è€Œä¸”ç»´æŠ¤èµ·æ¥æ›´åŠ æ¸…æ™°ã€‚</p>

<h1 id="4è°ƒåº¦å™¨">4.è°ƒåº¦å™¨</h1>

<p>æ¥ç€è°ƒç”¨äº†<code class="language-plaintext highlighter-rouge">Scheduler</code>çš„<code class="language-plaintext highlighter-rouge">open</code></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spider</span><span class="p">):</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">spider</span> <span class="o">=</span> <span class="n">spider</span>
    <span class="c1"># å®ä¾‹åŒ–ä¼˜å…ˆçº§é˜Ÿåˆ—
</span>    <span class="bp">self</span><span class="p">.</span><span class="n">mqs</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">pqclass</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">_newmq</span><span class="p">)</span>
    <span class="c1"># å¦‚æœå®šä¹‰äº†dqdiråˆ™å®ä¾‹åŒ–åŸºäºç£ç›˜çš„é˜Ÿåˆ—
</span>    <span class="bp">self</span><span class="p">.</span><span class="n">dqs</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_dq</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">dqdir</span> <span class="k">else</span> <span class="bp">None</span>
    <span class="c1"># è°ƒç”¨è¯·æ±‚æŒ‡çº¹è¿‡æ»¤å™¨çš„openæ–¹æ³•
</span>    <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">df</span><span class="p">.</span><span class="nb">open</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">_dq</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># å®ä¾‹åŒ–ç£ç›˜é˜Ÿåˆ—
</span>    <span class="n">activef</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">dqdir</span><span class="p">,</span> <span class="s">'active.json'</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">activef</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">activef</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">prios</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">prios</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">pqclass</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">_newdq</span><span class="p">,</span> <span class="n">startprios</span><span class="o">=</span><span class="n">prios</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">q</span><span class="p">:</span>
        <span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Resuming crawl (%(queuesize)d requests scheduled)"</span><span class="p">,</span>
                    <span class="p">{</span><span class="s">'queuesize'</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">)},</span> <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s">'spider'</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">spider</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">q</span>
</code></pre></div></div>

<p>åœ¨<code class="language-plaintext highlighter-rouge">open</code>æ–¹æ³•ä¸­ï¼Œå®ä¾‹åŒ–å‡ºä¼˜å…ˆçº§é˜Ÿåˆ—ä»¥åŠæ ¹æ®<code class="language-plaintext highlighter-rouge">dqdir</code>å†³å®šæ˜¯å¦ä½¿ç”¨ç£ç›˜é˜Ÿåˆ—ï¼Œç„¶åè°ƒç”¨äº†<code class="language-plaintext highlighter-rouge">è¯·æ±‚æŒ‡çº¹è¿‡æ»¤å™¨çš„open</code>ï¼Œåœ¨çˆ¶ç±»<code class="language-plaintext highlighter-rouge">BaseDupeFilter</code>ä¸­å®šä¹‰ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">BaseDupeFilter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
	<span class="c1"># è¿‡æ»¤å™¨åŸºç±»,å­ç±»å¯é‡å†™ä»¥ä¸‹æ–¹æ³•
</span>    <span class="o">@</span><span class="nb">classmethod</span>
    <span class="k">def</span> <span class="nf">from_settings</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">cls</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">request_seen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="c1"># è¯·æ±‚è¿‡æ»¤
</span>        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># å¯é‡å†™,å®Œæˆè¿‡æ»¤å™¨çš„åˆå§‹åŒ–å·¥ä½œ
</span>        <span class="k">pass</span>
    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reason</span><span class="p">):</span>
        <span class="c1"># å¯é‡å†™,å®Œæˆå…³é—­è¿‡æ»¤å™¨å·¥ä½œ
</span>        <span class="k">pass</span>
    <span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">spider</span><span class="p">):</span>
        <span class="n">pas</span>

</code></pre></div></div>

<p>è¯·æ±‚è¿‡æ»¤å™¨æä¾›äº†è¯·æ±‚è¿‡æ»¤çš„å…·ä½“å®ç°æ–¹å¼ï¼ŒScrapyé»˜è®¤æä¾›äº†<code class="language-plaintext highlighter-rouge">RFPDupeFilter</code>è¿‡æ»¤å™¨å®ç°è¿‡æ»¤é‡å¤è¯·æ±‚çš„é€»è¾‘ï¼Œåé¢è®²å…·ä½“æ˜¯å¦‚ä½•è¿‡æ»¤é‡å¤è¯·æ±‚çš„ã€‚</p>

<h1 id="5scraper">5.Scraper</h1>

<p>å†æ¥çœ‹Scraperçš„<code class="language-plaintext highlighter-rouge">open_spider</code>ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">defer</span><span class="p">.</span><span class="n">inlineCallbacks</span>
<span class="k">def</span> <span class="nf">open_spider</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spider</span><span class="p">):</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">slot</span> <span class="o">=</span> <span class="n">Slot</span><span class="p">()</span>
    <span class="c1"># è°ƒç”¨æ‰€æœ‰pipelineçš„open_spider
</span>    <span class="k">yield</span> <span class="bp">self</span><span class="p">.</span><span class="n">itemproc</span><span class="p">.</span><span class="n">open_spider</span><span class="p">(</span><span class="n">spider</span><span class="p">)</span>
</code></pre></div></div>

<p>è¿™é‡Œçš„å·¥ä½œä¸»è¦æ˜¯<code class="language-plaintext highlighter-rouge">Scraper</code>è°ƒç”¨æ‰€æœ‰<code class="language-plaintext highlighter-rouge">Pipeline</code>çš„<code class="language-plaintext highlighter-rouge">open_spider</code>æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœæˆ‘ä»¬å®šä¹‰äº†å¤šä¸ªPipelineè¾“å‡ºç±»ï¼Œå¯é‡å†™<code class="language-plaintext highlighter-rouge">open_spider</code>å®Œæˆæ¯ä¸ª<code class="language-plaintext highlighter-rouge">Pipeline</code>å¤„ç†è¾“å‡ºå¼€å§‹çš„åˆå§‹åŒ–å·¥ä½œã€‚</p>

<h1 id="6å¾ªç¯è°ƒåº¦">6.å¾ªç¯è°ƒåº¦</h1>

<p>è°ƒç”¨äº†ä¸€äº›åˆ—çš„ç»„ä»¶çš„openæ–¹æ³•åï¼Œæœ€åè°ƒç”¨äº†<code class="language-plaintext highlighter-rouge">nextcall.schedule()</code>å¼€å§‹è°ƒåº¦ï¼Œä¹Ÿå°±æ˜¯å¾ªç¯æ‰§è¡Œåœ¨ä¸Šé¢æ³¨å†Œçš„<code class="language-plaintext highlighter-rouge">_next_request</code>æ–¹æ³•ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_next_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spider</span><span class="p">):</span>
    <span class="c1"># æ­¤æ–¹æ³•ä¼šå¾ªç¯è°ƒåº¦
</span>    <span class="n">slot</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">slot</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">slot</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="c1"># æš‚åœ
</span>    <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">paused</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="c1"># æ˜¯å¦ç­‰å¾…
</span>    <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">_needs_backout</span><span class="p">(</span><span class="n">spider</span><span class="p">):</span>
        <span class="c1"># ä»schedulerä¸­è·å–request
</span>        <span class="c1"># æ³¨æ„ï¼šç¬¬ä¸€æ¬¡è·å–æ—¶ï¼Œæ˜¯æ²¡æœ‰çš„ï¼Œä¹Ÿå°±æ˜¯ä¼šbreakå‡ºæ¥
</span>        <span class="c1"># ä»è€Œæ‰§è¡Œä¸‹é¢çš„é€»è¾‘
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">_next_request_from_scheduler</span><span class="p">(</span><span class="n">spider</span><span class="p">):</span>
            <span class="k">break</span>
    <span class="c1"># å¦‚æœstart_requestsæœ‰æ•°æ®ä¸”ä¸éœ€è¦ç­‰å¾…
</span>    <span class="k">if</span> <span class="n">slot</span><span class="p">.</span><span class="n">start_requests</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">_needs_backout</span><span class="p">(</span><span class="n">spider</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># è·å–ä¸‹ä¸€ä¸ªç§å­è¯·æ±‚
</span>            <span class="n">request</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">slot</span><span class="p">.</span><span class="n">start_requests</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">StopIteration</span><span class="p">:</span>
            <span class="n">slot</span><span class="p">.</span><span class="n">start_requests</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="n">slot</span><span class="p">.</span><span class="n">start_requests</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">logger</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="s">'Error while obtaining start requests'</span><span class="p">,</span>
                         <span class="n">exc_info</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s">'spider'</span><span class="p">:</span> <span class="n">spider</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># è°ƒç”¨crawl,å®é™…æ˜¯æŠŠrequestæ”¾å…¥schedulerçš„é˜Ÿåˆ—ä¸­
</span>            <span class="bp">self</span><span class="p">.</span><span class="n">crawl</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">spider</span><span class="p">)</span>
    <span class="c1"># ç©ºé—²åˆ™å…³é—­spider
</span>    <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">spider_is_idle</span><span class="p">(</span><span class="n">spider</span><span class="p">)</span> <span class="ow">and</span> <span class="n">slot</span><span class="p">.</span><span class="n">close_if_idle</span><span class="p">:</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_spider_idle</span><span class="p">(</span><span class="n">spider</span><span class="p">)</span>
        
<span class="k">def</span> <span class="nf">_needs_backout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spider</span><span class="p">):</span>
    <span class="c1"># æ˜¯å¦éœ€è¦ç­‰å¾…ï¼Œå–å†³4ä¸ªæ¡ä»¶
</span>    <span class="c1"># 1. Engineæ˜¯å¦stop
</span>    <span class="c1"># 2. slotæ˜¯å¦close
</span>    <span class="c1"># 3. downloaderä¸‹è½½è¶…è¿‡é¢„è®¾
</span>    <span class="c1"># 4. scraperå¤„ç†responseè¶…è¿‡é¢„è®¾
</span>    <span class="n">slot</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">slot</span>
    <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">running</span> \
        <span class="ow">or</span> <span class="n">slot</span><span class="p">.</span><span class="n">closing</span> \
        <span class="ow">or</span> <span class="bp">self</span><span class="p">.</span><span class="n">downloader</span><span class="p">.</span><span class="n">needs_backout</span><span class="p">()</span> \
        <span class="ow">or</span> <span class="bp">self</span><span class="p">.</span><span class="n">scraper</span><span class="p">.</span><span class="n">slot</span><span class="p">.</span><span class="n">needs_backout</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">_next_request_from_scheduler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spider</span><span class="p">):</span>
    <span class="n">slot</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">slot</span>
    <span class="c1"># ä»scheduleræ‹¿å‡ºä¸‹ä¸ªrequest
</span>    <span class="n">request</span> <span class="o">=</span> <span class="n">slot</span><span class="p">.</span><span class="n">scheduler</span><span class="p">.</span><span class="n">next_request</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="c1"># ä¸‹è½½
</span>    <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_download</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">spider</span><span class="p">)</span>
    <span class="c1"># æ³¨å†ŒæˆåŠŸã€å¤±è´¥ã€å‡ºå£å›è°ƒæ–¹æ³•
</span>    <span class="n">d</span><span class="p">.</span><span class="n">addBoth</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">_handle_downloader_output</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">spider</span><span class="p">)</span>
    <span class="n">d</span><span class="p">.</span><span class="n">addErrback</span><span class="p">(</span><span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">'Error while handling downloader output'</span><span class="p">,</span>
                                       <span class="n">exc_info</span><span class="o">=</span><span class="n">failure_to_exc_info</span><span class="p">(</span><span class="n">f</span><span class="p">),</span>
                                       <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s">'spider'</span><span class="p">:</span> <span class="n">spider</span><span class="p">}))</span>
    <span class="n">d</span><span class="p">.</span><span class="n">addBoth</span><span class="p">(</span><span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="n">slot</span><span class="p">.</span><span class="n">remove_request</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
    <span class="n">d</span><span class="p">.</span><span class="n">addErrback</span><span class="p">(</span><span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">'Error while removing request from slot'</span><span class="p">,</span>
                                       <span class="n">exc_info</span><span class="o">=</span><span class="n">failure_to_exc_info</span><span class="p">(</span><span class="n">f</span><span class="p">),</span>
                                       <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s">'spider'</span><span class="p">:</span> <span class="n">spider</span><span class="p">}))</span>
    <span class="n">d</span><span class="p">.</span><span class="n">addBoth</span><span class="p">(</span><span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="n">slot</span><span class="p">.</span><span class="n">nextcall</span><span class="p">.</span><span class="n">schedule</span><span class="p">())</span>
    <span class="n">d</span><span class="p">.</span><span class="n">addErrback</span><span class="p">(</span><span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">'Error while scheduling new request'</span><span class="p">,</span>
                                       <span class="n">exc_info</span><span class="o">=</span><span class="n">failure_to_exc_info</span><span class="p">(</span><span class="n">f</span><span class="p">),</span>
                                       <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s">'spider'</span><span class="p">:</span> <span class="n">spider</span><span class="p">}))</span>
    <span class="k">return</span> <span class="n">d</span>
<span class="k">def</span> <span class="nf">crawl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">spider</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">spider</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">open_spiders</span><span class="p">,</span> \
        <span class="s">"Spider %r not opened when crawling: %s"</span> <span class="o">%</span> <span class="p">(</span><span class="n">spider</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
    <span class="c1"># requestæ”¾å…¥scheduleré˜Ÿåˆ—ï¼Œè°ƒç”¨nextcallçš„schedule
</span>    <span class="bp">self</span><span class="p">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">spider</span><span class="p">)</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">slot</span><span class="p">.</span><span class="n">nextcall</span><span class="p">.</span><span class="n">schedule</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">schedule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">spider</span><span class="p">):</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">signals</span><span class="p">.</span><span class="n">send_catch_log</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="p">.</span><span class="n">request_scheduled</span><span class="p">,</span>
            <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">,</span> <span class="n">spider</span><span class="o">=</span><span class="n">spider</span><span class="p">)</span>
    <span class="c1"># è°ƒç”¨schedulerçš„enqueue_requestï¼ŒæŠŠrequestæ”¾å…¥scheduleré˜Ÿåˆ—
</span>    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">slot</span><span class="p">.</span><span class="n">scheduler</span><span class="p">.</span><span class="n">enqueue_request</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">signals</span><span class="p">.</span><span class="n">send_catch_log</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="p">.</span><span class="n">request_dropped</span><span class="p">,</span>
                                    <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">,</span> <span class="n">spider</span><span class="o">=</span><span class="n">spider</span><span class="p">)</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">_next_request</code>æ–¹æ³•é¦–å…ˆè°ƒç”¨<code class="language-plaintext highlighter-rouge">_needs_backout</code>æ–¹æ³•æ£€æŸ¥æ˜¯å¦éœ€è¦ç­‰å¾…ï¼Œç­‰å¾…çš„æ¡ä»¶æœ‰ï¼š</p>
<ul>
  <li>å¼•æ“æ˜¯å¦ä¸»åŠ¨å…³é—­</li>
  <li>Slotæ˜¯å¦å…³é—­</li>
  <li>ä¸‹è½½å™¨ç½‘ç»œä¸‹è½½è¶…è¿‡é¢„è®¾å‚æ•°</li>
  <li>Scraperå¤„ç†è¾“å‡ºè¶…è¿‡é¢„è®¾å‚æ•°</li>
</ul>

<p>å¦‚æœä¸éœ€è¦ç­‰å¾…ï¼Œåˆ™è°ƒç”¨<code class="language-plaintext highlighter-rouge">_next_request_from_scheduler</code>ï¼Œæ­¤æ–¹æ³•ä»åå­—ä¸Šå°±èƒ½çœ‹å‡ºï¼Œä¸»è¦æ˜¯ä»Schdulerä¸­è·å–Requestã€‚</p>

<p>è¿™é‡Œè¦æ³¨æ„ï¼Œåœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨æ­¤æ–¹æ³•æ—¶ï¼Œ<code class="language-plaintext highlighter-rouge">Scheduler</code>ä¸­æ˜¯æ²¡æœ‰æ”¾å…¥ä»»ä½•<code class="language-plaintext highlighter-rouge">Request</code>çš„ï¼Œè¿™é‡Œä¼šç›´æ¥<code class="language-plaintext highlighter-rouge">break</code>å‡ºæ¥ï¼Œæ‰§è¡Œä¸‹é¢çš„é€»è¾‘ï¼Œè€Œä¸‹é¢å°±ä¼šè°ƒç”¨crawlæ–¹æ³•ï¼Œå®é™…æ˜¯æŠŠè¯·æ±‚æ”¾åˆ°<code class="language-plaintext highlighter-rouge">Scheduler</code>çš„è¯·æ±‚é˜Ÿåˆ—ï¼Œæ”¾å…¥é˜Ÿåˆ—çš„è¿‡ç¨‹ä¼šç»è¿‡è¯·æ±‚è¿‡æ»¤å™¨æ ¡éªŒæ˜¯å¦é‡å¤ã€‚</p>

<p>ä¸‹æ¬¡å†è°ƒç”¨<code class="language-plaintext highlighter-rouge">_next_request_from_scheduler</code>æ—¶ï¼Œå°±èƒ½ä»<code class="language-plaintext highlighter-rouge">Scheduler</code>ä¸­è·å–åˆ°ä¸‹è½½è¯·æ±‚ï¼Œç„¶åæ‰§è¡Œä¸‹è½½åŠ¨ä½œã€‚</p>

<p>å…ˆæ¥çœ‹ç¬¬ä¸€æ¬¡è°ƒåº¦ï¼Œæ‰§è¡Œ<code class="language-plaintext highlighter-rouge">crawl</code>ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">crawl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">spider</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">spider</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">open_spiders</span><span class="p">,</span> \
        <span class="s">"Spider %r not opened when crawling: %s"</span> <span class="o">%</span> <span class="p">(</span><span class="n">spider</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
    <span class="c1"># æ”¾å…¥Scheduleré˜Ÿåˆ—
</span>    <span class="bp">self</span><span class="p">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">spider</span><span class="p">)</span>
    <span class="c1"># è¿›è¡Œä¸‹ä¸€æ¬¡è°ƒåº¦
</span>    <span class="bp">self</span><span class="p">.</span><span class="n">slot</span><span class="p">.</span><span class="n">nextcall</span><span class="p">.</span><span class="n">schedule</span><span class="p">()</span>
    
<span class="k">def</span> <span class="nf">schedule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">spider</span><span class="p">):</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">signals</span><span class="p">.</span><span class="n">send_catch_log</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="p">.</span><span class="n">request_scheduled</span><span class="p">,</span>
            <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">,</span> <span class="n">spider</span><span class="o">=</span><span class="n">spider</span><span class="p">)</span>
    <span class="c1"># æ”¾å…¥Scheduleré˜Ÿåˆ—
</span>    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">slot</span><span class="p">.</span><span class="n">scheduler</span><span class="p">.</span><span class="n">enqueue_request</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">signals</span><span class="p">.</span><span class="n">send_catch_log</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="p">.</span><span class="n">request_dropped</span><span class="p">,</span>
                                    <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">,</span> <span class="n">spider</span><span class="o">=</span><span class="n">spider</span><span class="p">)</span>

</code></pre></div></div>

<p>è°ƒç”¨å¼•æ“çš„<code class="language-plaintext highlighter-rouge">crawl</code>å®é™…å°±æ˜¯æŠŠè¯·æ±‚æ”¾å…¥<code class="language-plaintext highlighter-rouge">Scheduler</code>çš„é˜Ÿåˆ—ä¸­ï¼Œä¸‹é¢çœ‹è¯·æ±‚æ˜¯å¦‚ä½•å…¥é˜Ÿåˆ—çš„ã€‚</p>

<h1 id="7è¯·æ±‚å…¥é˜Ÿ">7.è¯·æ±‚å…¥é˜Ÿ</h1>

<p>Schedulerè¯·æ±‚å…¥é˜Ÿæ–¹æ³•ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">enqueue_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="c1"># è¯·æ±‚å…¥é˜Ÿ,è‹¥è¯·æ±‚è¿‡æ»¤å™¨éªŒè¯é‡å¤,è¿”å›False
</span>    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="p">.</span><span class="n">dont_filter</span> <span class="ow">and</span> <span class="bp">self</span><span class="p">.</span><span class="n">df</span><span class="p">.</span><span class="n">request_seen</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">df</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">spider</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="c1"># ç£ç›˜é˜Ÿåˆ—æ˜¯å¦å…¥é˜ŸæˆåŠŸ
</span>    <span class="n">dqok</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_dqpush</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dqok</span><span class="p">:</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">inc_value</span><span class="p">(</span><span class="s">'scheduler/enqueued/disk'</span><span class="p">,</span> <span class="n">spider</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">spider</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># æ²¡æœ‰å®šä¹‰ç£ç›˜é˜Ÿåˆ—ï¼Œåˆ™ä½¿ç”¨å†…å­˜é˜Ÿåˆ—
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">_mqpush</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">inc_value</span><span class="p">(</span><span class="s">'scheduler/enqueued/memory'</span><span class="p">,</span> <span class="n">spider</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">spider</span><span class="p">)</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">inc_value</span><span class="p">(</span><span class="s">'scheduler/enqueued'</span><span class="p">,</span> <span class="n">spider</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">spider</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">True</span>
<span class="k">def</span> <span class="nf">_dqpush</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="c1"># æ˜¯å¦å®šä¹‰ç£ç›˜é˜Ÿåˆ—
</span>    <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">dqs</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Requestå¯¹è±¡è½¬dict
</span>        <span class="n">reqd</span> <span class="o">=</span> <span class="n">request_to_dict</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">spider</span><span class="p">)</span>
        <span class="c1"># æ”¾å…¥ç£ç›˜é˜Ÿåˆ—
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">dqs</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">reqd</span><span class="p">,</span> <span class="o">-</span><span class="n">request</span><span class="p">.</span><span class="n">priority</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># non serializable request
</span>        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">logunser</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">"Unable to serialize request: %(request)s - reason:"</span>
                   <span class="s">" %(reason)s - no more unserializable requests will be"</span>
                   <span class="s">" logged (stats being collected)"</span><span class="p">)</span>
            <span class="n">logger</span><span class="p">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="p">{</span><span class="s">'request'</span><span class="p">:</span> <span class="n">request</span><span class="p">,</span> <span class="s">'reason'</span><span class="p">:</span> <span class="n">e</span><span class="p">},</span>
                           <span class="n">exc_info</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s">'spider'</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">spider</span><span class="p">})</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">logunser</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">inc_value</span><span class="p">(</span><span class="s">'scheduler/unserializable'</span><span class="p">,</span>
                             <span class="n">spider</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">spider</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">True</span>
    
<span class="k">def</span> <span class="nf">_mqpush</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="c1"># å…¥å†…å­˜é˜Ÿåˆ—
</span>    <span class="bp">self</span><span class="p">.</span><span class="n">mqs</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">-</span><span class="n">request</span><span class="p">.</span><span class="n">priority</span><span class="p">)</span>
</code></pre></div></div>

<p>åœ¨ä¹‹å‰å°†æ ¸å¿ƒç»„ä»¶å®ä¾‹åŒ–æ—¶æœ‰è¯´åˆ°ï¼Œè°ƒåº¦å™¨ä¸»è¦å®šä¹‰äº†2ç§é˜Ÿåˆ—ï¼šåŸºäºç£ç›˜é˜Ÿåˆ—ã€åŸºäºå†…å­˜é˜Ÿåˆ—ã€‚</p>

<p>å¦‚æœåœ¨å®ä¾‹åŒ–<code class="language-plaintext highlighter-rouge">Scheduler</code>æ—¶å€™ä¼ å…¥<code class="language-plaintext highlighter-rouge">jobdir</code>ï¼Œåˆ™ä½¿ç”¨ç£ç›˜é˜Ÿåˆ—ï¼Œå¦åˆ™ä½¿ç”¨å†…å­˜é˜Ÿåˆ—ï¼Œé»˜è®¤ä½¿ç”¨å†…å­˜é˜Ÿåˆ—ã€‚</p>

<h1 id="8æŒ‡çº¹è¿‡æ»¤">8.æŒ‡çº¹è¿‡æ»¤</h1>

<p>åœ¨å…¥é˜Ÿä¹‹å‰ï¼Œé¦–å…ˆé€šè¿‡è¯·æ±‚æŒ‡çº¹è¿‡æ»¤å™¨æ£€æŸ¥è¯·æ±‚æ˜¯å¦é‡å¤ï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨äº†è¿‡æ»¤å™¨çš„<code class="language-plaintext highlighter-rouge">request_seen</code>ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">request_seen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="c1"># ç”Ÿæˆè¯·æ±‚æŒ‡çº¹
</span>    <span class="n">fp</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">request_fingerprint</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="c1"># è¯·æ±‚æŒ‡çº¹å¦‚æœåœ¨æŒ‡çº¹é›†åˆä¸­,åˆ™è®¤ä¸ºé‡å¤
</span>    <span class="k">if</span> <span class="n">fp</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">fingerprints</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="c1"># ä¸é‡å¤åˆ™è®°å½•æ­¤æŒ‡çº¹
</span>    <span class="bp">self</span><span class="p">.</span><span class="n">fingerprints</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
    <span class="c1"># å®ä¾‹åŒ–å¦‚æœæœ‰pathåˆ™æŠŠæŒ‡çº¹å†™å…¥æ–‡ä»¶
</span>    <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="nb">file</span><span class="p">:</span>
        <span class="bp">self</span><span class="p">.</span><span class="nb">file</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">fp</span> <span class="o">+</span> <span class="n">os</span><span class="p">.</span><span class="n">linesep</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">request_fingerprint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="c1"># è°ƒç”¨utils.requestçš„request_fingerprint
</span>    <span class="k">return</span> <span class="n">request_fingerprint</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">utils.request</code>çš„<code class="language-plaintext highlighter-rouge">request_fingerprint</code>ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">request_fingerprint</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">include_headers</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="s">"""ç”Ÿæˆè¯·æ±‚æŒ‡çº¹"""</span>
    <span class="c1"># æŒ‡çº¹ç”Ÿæˆæ˜¯å¦åŒ…å«headers
</span>    <span class="k">if</span> <span class="n">include_headers</span><span class="p">:</span>
        <span class="n">include_headers</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">to_bytes</span><span class="p">(</span><span class="n">h</span><span class="p">.</span><span class="n">lower</span><span class="p">())</span>
                                 <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">include_headers</span><span class="p">))</span>
    <span class="n">cache</span> <span class="o">=</span> <span class="n">_fingerprint_cache</span><span class="p">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="p">{})</span>
    <span class="k">if</span> <span class="n">include_headers</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cache</span><span class="p">:</span>
        <span class="c1"># ä½¿ç”¨sha1ç®—æ³•ç”ŸæˆæŒ‡çº¹
</span>        <span class="n">fp</span> <span class="o">=</span> <span class="n">hashlib</span><span class="p">.</span><span class="n">sha1</span><span class="p">()</span>
        <span class="n">fp</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">to_bytes</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">method</span><span class="p">))</span>
        <span class="n">fp</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">to_bytes</span><span class="p">(</span><span class="n">canonicalize_url</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">url</span><span class="p">)))</span>
        <span class="n">fp</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">body</span> <span class="ow">or</span> <span class="s">b''</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">include_headers</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">hdr</span> <span class="ow">in</span> <span class="n">include_headers</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">hdr</span> <span class="ow">in</span> <span class="n">request</span><span class="p">.</span><span class="n">headers</span><span class="p">:</span>
                    <span class="n">fp</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">hdr</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">request</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="n">getlist</span><span class="p">(</span><span class="n">hdr</span><span class="p">):</span>
                        <span class="n">fp</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">cache</span><span class="p">[</span><span class="n">include_headers</span><span class="p">]</span> <span class="o">=</span> <span class="n">fp</span><span class="p">.</span><span class="n">hexdigest</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">cache</span><span class="p">[</span><span class="n">include_headers</span><span class="p">]</span>
</code></pre></div></div>

<p>è¿™ä¸ªè¿‡æ»¤å™¨å…ˆæ˜¯é€šè¿‡<code class="language-plaintext highlighter-rouge">Request</code>å¯¹è±¡ç”Ÿæˆä¸€ä¸ªè¯·æ±‚æŒ‡çº¹ï¼Œåœ¨è¿™é‡Œä½¿ç”¨<code class="language-plaintext highlighter-rouge">sha1</code>ç®—æ³•ï¼Œå¹¶è®°å½•åˆ°æŒ‡çº¹é›†åˆï¼Œæ¯æ¬¡è¯·æ±‚å…¥é˜Ÿå‰å…ˆåˆ°è¿™é‡ŒéªŒè¯ä¸€ä¸‹æŒ‡çº¹é›†åˆï¼Œå¦‚æœå·²å­˜åœ¨ï¼Œåˆ™è®¤ä¸ºè¯·æ±‚é‡å¤ï¼Œåˆ™ä¸ä¼šé‡å¤å…¥é˜Ÿåˆ—ã€‚</p>

<p>ä¸è¿‡å¦‚æœæˆ‘æƒ³ä¸æ ¡éªŒé‡å¤ï¼Œä¹Ÿæƒ³é‡å¤çˆ¬å–æ€ä¹ˆåŠï¼Ÿçœ‹<code class="language-plaintext highlighter-rouge">enqueue_request</code>çš„ç¬¬ä¸€è¡Œåˆ¤æ–­ï¼Œä»…éœ€å°†Requestå®ä¾‹çš„<code class="language-plaintext highlighter-rouge">dont_filter</code>å®šä¹‰ä¸ºTrueå°±å¯ä»¥é‡å¤çˆ¬å–æ­¤è¯·æ±‚ï¼Œéå¸¸çµæ´»ã€‚</p>

<p>Scrapyå°±æ˜¯é€šè¿‡æ­¤é€»è¾‘å®ç°é‡å¤è¯·æ±‚çš„è¿‡æ»¤é€»è¾‘ï¼Œé»˜è®¤é‡å¤è¯·æ±‚æ˜¯ä¸ä¼šè¿›è¡Œé‡å¤æŠ“å–çš„ã€‚</p>

<h1 id="9ä¸‹è½½è¯·æ±‚">9.ä¸‹è½½è¯·æ±‚</h1>

<p>ç¬¬ä¸€æ¬¡è¯·æ±‚è¿›æ¥åï¼Œè‚¯å®šæ˜¯ä¸é‡å¤çš„ï¼Œé‚£ä¹ˆåˆ™ä¼šæ­£å¸¸è¿›å…¥è°ƒåº¦å™¨é˜Ÿåˆ—ã€‚ç„¶åå†è¿›è¡Œä¸‹ä¸€æ¬¡è°ƒåº¦ï¼Œå†æ¬¡è°ƒç”¨<code class="language-plaintext highlighter-rouge">_next_request_from_scheduler</code>æ–¹æ³•ï¼Œæ­¤æ—¶è°ƒç”¨è°ƒåº¦å™¨çš„<code class="language-plaintext highlighter-rouge">next_request</code>æ–¹æ³•ï¼Œå°±æ˜¯ä»è°ƒåº¦å™¨é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ªè¯·æ±‚ï¼Œè¿™æ¬¡å°±è¦å¼€å§‹è¿›è¡Œç½‘ç»œä¸‹è½½äº†ï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨<code class="language-plaintext highlighter-rouge">_download</code>ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_download</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">spider</span><span class="p">):</span>
    <span class="c1"># ä¸‹è½½è¯·æ±‚
</span>    <span class="n">slot</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">slot</span>
    <span class="n">slot</span><span class="p">.</span><span class="n">add_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_on_success</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
        <span class="c1"># æˆåŠŸå›è°ƒ,ç»“æœå¿…é¡»æ˜¯Requestæˆ–Response
</span>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="p">(</span><span class="n">Response</span><span class="p">,</span> <span class="n">Request</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">Response</span><span class="p">):</span>
            <span class="c1"># å¦‚æœä¸‹è½½åç»“æœä¸ºResponse,è¿”å›Response
</span>            <span class="n">response</span><span class="p">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">request</span>
            <span class="n">logkws</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">logformatter</span><span class="p">.</span><span class="n">crawled</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">spider</span><span class="p">)</span>
            <span class="n">logger</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="o">*</span><span class="n">logformatter_adapter</span><span class="p">(</span><span class="n">logkws</span><span class="p">),</span> <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s">'spider'</span><span class="p">:</span> <span class="n">spider</span><span class="p">})</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">signals</span><span class="p">.</span><span class="n">send_catch_log</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="p">.</span><span class="n">response_received</span><span class="p">,</span> \
                <span class="n">response</span><span class="o">=</span><span class="n">response</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">,</span> <span class="n">spider</span><span class="o">=</span><span class="n">spider</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span>
    <span class="k">def</span> <span class="nf">_on_complete</span><span class="p">(</span><span class="n">_</span><span class="p">):</span>
        <span class="c1"># æ­¤æ¬¡ä¸‹è½½å®Œæˆåï¼Œç»§ç»­è¿›è¡Œä¸‹ä¸€æ¬¡è°ƒåº¦
</span>        <span class="n">slot</span><span class="p">.</span><span class="n">nextcall</span><span class="p">.</span><span class="n">schedule</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">_</span>
    <span class="c1"># è°ƒç”¨Downloaderè¿›è¡Œä¸‹è½½
</span>    <span class="n">dwld</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">downloader</span><span class="p">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">spider</span><span class="p">)</span>
    <span class="c1"># æ³¨å†ŒæˆåŠŸå›è°ƒ
</span>    <span class="n">dwld</span><span class="p">.</span><span class="n">addCallbacks</span><span class="p">(</span><span class="n">_on_success</span><span class="p">)</span>
    <span class="c1"># ç»“æŸå›è°ƒ
</span>    <span class="n">dwld</span><span class="p">.</span><span class="n">addBoth</span><span class="p">(</span><span class="n">_on_complete</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dwld</span>
</code></pre></div></div>

<p>åœ¨è¿›è¡Œç½‘ç»œä¸‹è½½æ—¶ï¼Œè°ƒç”¨äº†<code class="language-plaintext highlighter-rouge">Downloader</code>çš„<code class="language-plaintext highlighter-rouge">fetch</code>ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">fetch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">spider</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_deactivate</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
        <span class="c1"># ä¸‹è½½ç»“æŸååˆ é™¤æ­¤è®°å½•
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">active</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span>
    <span class="c1"># ä¸‹è½½å‰è®°å½•å¤„ç†ä¸­çš„è¯·æ±‚
</span>    <span class="bp">self</span><span class="p">.</span><span class="n">active</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="c1"># è°ƒç”¨ä¸‹è½½å™¨ä¸­é—´ä»¶downloadï¼Œå¹¶æ³¨å†Œä¸‹è½½æˆåŠŸçš„å›è°ƒæ–¹æ³•æ˜¯self._enqueue_request
</span>    <span class="n">dfd</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">middleware</span><span class="p">.</span><span class="n">download</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">_enqueue_request</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">spider</span><span class="p">)</span>
    <span class="c1"># æ³¨å†Œç»“æŸå›è°ƒ
</span>    <span class="k">return</span> <span class="n">dfd</span><span class="p">.</span><span class="n">addBoth</span><span class="p">(</span><span class="n">_deactivate</span><span class="p">)</span>
</code></pre></div></div>

<p>è¿™é‡Œè°ƒç”¨ä¸‹è½½å™¨ä¸­é—´ä»¶çš„<code class="language-plaintext highlighter-rouge">download</code>æ–¹æ³•ï¼Œå¹¶æ³¨å†Œä¸‹è½½æˆåŠŸçš„å›è°ƒæ–¹æ³•æ˜¯<code class="language-plaintext highlighter-rouge">_enqueue_request</code>ï¼Œæ¥çœ‹ä¸‹è½½æ–¹æ³•ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">download</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">download_func</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">spider</span><span class="p">):</span>
    <span class="o">@</span><span class="n">defer</span><span class="p">.</span><span class="n">inlineCallbacks</span>
    <span class="k">def</span> <span class="nf">process_request</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
        <span class="c1"># å¦‚æœä¸‹è½½å™¨ä¸­é—´ä»¶æœ‰å®šä¹‰process_requestï¼Œåˆ™ä¾æ¬¡æ‰§è¡Œ
</span>        <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">methods</span><span class="p">[</span><span class="s">'process_request'</span><span class="p">]:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">method</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">,</span> <span class="n">spider</span><span class="o">=</span><span class="n">spider</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">response</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="p">(</span><span class="n">Response</span><span class="p">,</span> <span class="n">Request</span><span class="p">)),</span> \
                    <span class="s">'Middleware %s.process_request must return None, Response or Request, got %s'</span> <span class="o">%</span> \
                    <span class="p">(</span><span class="n">six</span><span class="p">.</span><span class="n">get_method_self</span><span class="p">(</span><span class="n">method</span><span class="p">).</span><span class="n">__class__</span><span class="p">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">response</span><span class="p">.</span><span class="n">__class__</span><span class="p">.</span><span class="n">__name__</span><span class="p">)</span>
            <span class="c1"># å¦‚æœä¸‹è½½å™¨ä¸­é—´ä»¶æœ‰è¿”å›å€¼ï¼Œç›´æ¥è¿”å›æ­¤ç»“æœ
</span>            <span class="k">if</span> <span class="n">response</span><span class="p">:</span>
                <span class="n">defer</span><span class="p">.</span><span class="n">returnValue</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="c1"># å¦‚æœä¸‹è½½å™¨ä¸­é—´ä»¶æ²¡æœ‰è¿”å›å€¼ï¼Œåˆ™æ‰§è¡Œæ³¨å†Œè¿›æ¥çš„æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯Downloaderçš„_enqueue_request
</span>        <span class="n">defer</span><span class="p">.</span><span class="n">returnValue</span><span class="p">((</span><span class="k">yield</span> <span class="n">download_func</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">,</span><span class="n">spider</span><span class="o">=</span><span class="n">spider</span><span class="p">)))</span>
    <span class="o">@</span><span class="n">defer</span><span class="p">.</span><span class="n">inlineCallbacks</span>
    <span class="k">def</span> <span class="nf">process_response</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">,</span> <span class="s">'Received None in process_response'</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">Request</span><span class="p">):</span>
            <span class="n">defer</span><span class="p">.</span><span class="n">returnValue</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="c1"># å¦‚æœä¸‹è½½å™¨ä¸­é—´ä»¶æœ‰å®šä¹‰process_responseï¼Œåˆ™ä¾æ¬¡æ‰§è¡Œ
</span>        <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">methods</span><span class="p">[</span><span class="s">'process_response'</span><span class="p">]:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">method</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="o">=</span><span class="n">response</span><span class="p">,</span>
                                    <span class="n">spider</span><span class="o">=</span><span class="n">spider</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="p">(</span><span class="n">Response</span><span class="p">,</span> <span class="n">Request</span><span class="p">)),</span> \
                <span class="s">'Middleware %s.process_response must return Response or Request, got %s'</span> <span class="o">%</span> \
                <span class="p">(</span><span class="n">six</span><span class="p">.</span><span class="n">get_method_self</span><span class="p">(</span><span class="n">method</span><span class="p">).</span><span class="n">__class__</span><span class="p">.</span><span class="n">__name__</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">response</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">Request</span><span class="p">):</span>
                <span class="n">defer</span><span class="p">.</span><span class="n">returnValue</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="n">defer</span><span class="p">.</span><span class="n">returnValue</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
    <span class="o">@</span><span class="n">defer</span><span class="p">.</span><span class="n">inlineCallbacks</span>
    <span class="k">def</span> <span class="nf">process_exception</span><span class="p">(</span><span class="n">_failure</span><span class="p">):</span>
        <span class="n">exception</span> <span class="o">=</span> <span class="n">_failure</span><span class="p">.</span><span class="n">value</span>
        <span class="c1"># å¦‚æœä¸‹è½½å™¨ä¸­é—´ä»¶æœ‰å®šä¹‰process_exceptionï¼Œåˆ™ä¾æ¬¡æ‰§è¡Œ
</span>        <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">methods</span><span class="p">[</span><span class="s">'process_exception'</span><span class="p">]:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">method</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">,</span> <span class="n">exception</span><span class="o">=</span><span class="n">exception</span><span class="p">,</span>
                                    <span class="n">spider</span><span class="o">=</span><span class="n">spider</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">response</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="p">(</span><span class="n">Response</span><span class="p">,</span> <span class="n">Request</span><span class="p">)),</span> \
                <span class="s">'Middleware %s.process_exception must return None, Response or Request, got %s'</span> <span class="o">%</span> \
                <span class="p">(</span><span class="n">six</span><span class="p">.</span><span class="n">get_method_self</span><span class="p">(</span><span class="n">method</span><span class="p">).</span><span class="n">__class__</span><span class="p">.</span><span class="n">__name__</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">response</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">response</span><span class="p">:</span>
                <span class="n">defer</span><span class="p">.</span><span class="n">returnValue</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="n">defer</span><span class="p">.</span><span class="n">returnValue</span><span class="p">(</span><span class="n">_failure</span><span class="p">)</span>
    <span class="c1"># æ³¨å†Œæ‰§è¡Œã€é”™è¯¯ã€å›è°ƒæ–¹æ³•
</span>    <span class="n">deferred</span> <span class="o">=</span> <span class="n">mustbe_deferred</span><span class="p">(</span><span class="n">process_request</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
    <span class="n">deferred</span><span class="p">.</span><span class="n">addErrback</span><span class="p">(</span><span class="n">process_exception</span><span class="p">)</span>
    <span class="n">deferred</span><span class="p">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">process_response</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">deferred</span>
</code></pre></div></div>

<p>åœ¨ä¸‹è½½è¿‡ç¨‹ä¸­ï¼Œé¦–å…ˆå…ˆæ‰¾åˆ°æ‰€æœ‰å®šä¹‰å¥½çš„ä¸‹è½½å™¨ä¸­é—´ä»¶ï¼ŒåŒ…æ‹¬å†…ç½®å®šä¹‰å¥½çš„ï¼Œä¹Ÿå¯ä»¥è‡ªå·±æ‰©å±•ä¸‹è½½å™¨ä¸­é—´ä»¶ï¼Œä¸‹è½½å‰å…ˆä¾æ¬¡æ‰§è¡Œ<code class="language-plaintext highlighter-rouge">process_request</code>æ–¹æ³•ï¼Œå¯å¯¹<code class="language-plaintext highlighter-rouge">request</code>è¿›è¡ŒåŠ å·¥ã€å¤„ç†ã€æ ¡éªŒç­‰æ“ä½œï¼Œç„¶åå‘èµ·çœŸæ­£çš„ç½‘ç»œä¸‹è½½ï¼Œä¹Ÿå°±æ˜¯ç¬¬ä¸€ä¸ªå‚æ•°<code class="language-plaintext highlighter-rouge">download_func</code>ï¼Œåœ¨è¿™é‡Œæ˜¯<code class="language-plaintext highlighter-rouge">Downloader</code>çš„<code class="language-plaintext highlighter-rouge">_enqueue_request</code>æ–¹æ³•ï¼š</p>

<p>ä¸‹è½½æˆåŠŸåå›è°ƒDownloaderçš„<code class="language-plaintext highlighter-rouge">_enqueue_request</code>ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_enqueue_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">spider</span><span class="p">):</span>
       <span class="c1"># åŠ å…¥ä¸‹è½½è¯·æ±‚é˜Ÿåˆ—
</span>       <span class="n">key</span><span class="p">,</span> <span class="n">slot</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_get_slot</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">spider</span><span class="p">)</span>
       <span class="n">request</span><span class="p">.</span><span class="n">meta</span><span class="p">[</span><span class="s">'download_slot'</span><span class="p">]</span> <span class="o">=</span> <span class="n">key</span>
       <span class="k">def</span> <span class="nf">_deactivate</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
           <span class="n">slot</span><span class="p">.</span><span class="n">active</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
           <span class="k">return</span> <span class="n">response</span>
       <span class="n">slot</span><span class="p">.</span><span class="n">active</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
       <span class="n">deferred</span> <span class="o">=</span> <span class="n">defer</span><span class="p">.</span><span class="n">Deferred</span><span class="p">().</span><span class="n">addBoth</span><span class="p">(</span><span class="n">_deactivate</span><span class="p">)</span>
       <span class="c1"># ä¸‹è½½é˜Ÿåˆ—
</span>       <span class="n">slot</span><span class="p">.</span><span class="n">queue</span><span class="p">.</span><span class="n">append</span><span class="p">((</span><span class="n">request</span><span class="p">,</span> <span class="n">deferred</span><span class="p">))</span>
       <span class="c1"># å¤„ç†ä¸‹è½½é˜Ÿåˆ—
</span>       <span class="bp">self</span><span class="p">.</span><span class="n">_process_queue</span><span class="p">(</span><span class="n">spider</span><span class="p">,</span> <span class="n">slot</span><span class="p">)</span>
       <span class="k">return</span> <span class="n">deferred</span>
   
   <span class="k">def</span> <span class="nf">_process_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spider</span><span class="p">,</span> <span class="n">slot</span><span class="p">):</span>
       <span class="k">if</span> <span class="n">slot</span><span class="p">.</span><span class="n">latercall</span> <span class="ow">and</span> <span class="n">slot</span><span class="p">.</span><span class="n">latercall</span><span class="p">.</span><span class="n">active</span><span class="p">():</span>
           <span class="k">return</span>
       <span class="c1"># å¦‚æœå»¶è¿Ÿä¸‹è½½å‚æ•°æœ‰é…ç½®ï¼Œåˆ™å»¶è¿Ÿå¤„ç†é˜Ÿåˆ—
</span>       <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
       <span class="n">delay</span> <span class="o">=</span> <span class="n">slot</span><span class="p">.</span><span class="n">download_delay</span><span class="p">()</span>
       <span class="k">if</span> <span class="n">delay</span><span class="p">:</span>
           <span class="n">penalty</span> <span class="o">=</span> <span class="n">delay</span> <span class="o">-</span> <span class="n">now</span> <span class="o">+</span> <span class="n">slot</span><span class="p">.</span><span class="n">lastseen</span>
           <span class="k">if</span> <span class="n">penalty</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
               <span class="n">slot</span><span class="p">.</span><span class="n">latercall</span> <span class="o">=</span> <span class="n">reactor</span><span class="p">.</span><span class="n">callLater</span><span class="p">(</span><span class="n">penalty</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">_process_queue</span><span class="p">,</span> <span class="n">spider</span><span class="p">,</span> <span class="n">slot</span><span class="p">)</span>
               <span class="k">return</span>
       <span class="c1"># å¤„ç†ä¸‹è½½é˜Ÿåˆ—
</span>       <span class="k">while</span> <span class="n">slot</span><span class="p">.</span><span class="n">queue</span> <span class="ow">and</span> <span class="n">slot</span><span class="p">.</span><span class="n">free_transfer_slots</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
           <span class="n">slot</span><span class="p">.</span><span class="n">lastseen</span> <span class="o">=</span> <span class="n">now</span>
           <span class="c1"># ä»ä¸‹è½½é˜Ÿåˆ—ä¸­å–å‡ºä¸‹è½½è¯·æ±‚
</span>           <span class="n">request</span><span class="p">,</span> <span class="n">deferred</span> <span class="o">=</span> <span class="n">slot</span><span class="p">.</span><span class="n">queue</span><span class="p">.</span><span class="n">popleft</span><span class="p">()</span>
           <span class="c1"># å¼€å§‹ä¸‹è½½
</span>           <span class="n">dfd</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_download</span><span class="p">(</span><span class="n">slot</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">spider</span><span class="p">)</span>
           <span class="n">dfd</span><span class="p">.</span><span class="n">chainDeferred</span><span class="p">(</span><span class="n">deferred</span><span class="p">)</span>
           <span class="c1"># å»¶è¿Ÿ
</span>           <span class="k">if</span> <span class="n">delay</span><span class="p">:</span>
               <span class="bp">self</span><span class="p">.</span><span class="n">_process_queue</span><span class="p">(</span><span class="n">spider</span><span class="p">,</span> <span class="n">slot</span><span class="p">)</span>
               <span class="k">break</span>
               
   <span class="k">def</span> <span class="nf">_download</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">spider</span><span class="p">):</span>
       <span class="c1"># æ³¨å†Œæ–¹æ³•ï¼Œè°ƒç”¨handlersçš„download_request
</span>       <span class="n">dfd</span> <span class="o">=</span> <span class="n">mustbe_deferred</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">handlers</span><span class="p">.</span><span class="n">download_request</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">spider</span><span class="p">)</span>
       <span class="c1"># æ³¨å†Œä¸‹è½½å®Œæˆå›è°ƒæ–¹æ³•
</span>       <span class="k">def</span> <span class="nf">_downloaded</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
           <span class="bp">self</span><span class="p">.</span><span class="n">signals</span><span class="p">.</span><span class="n">send_catch_log</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="p">.</span><span class="n">response_downloaded</span><span class="p">,</span>
                                       <span class="n">response</span><span class="o">=</span><span class="n">response</span><span class="p">,</span>
                                       <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">,</span>
                                       <span class="n">spider</span><span class="o">=</span><span class="n">spider</span><span class="p">)</span>
           <span class="k">return</span> <span class="n">response</span>
       <span class="n">dfd</span><span class="p">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">_downloaded</span><span class="p">)</span>
       <span class="n">slot</span><span class="p">.</span><span class="n">transferring</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
       <span class="k">def</span> <span class="nf">finish_transferring</span><span class="p">(</span><span class="n">_</span><span class="p">):</span>
           <span class="n">slot</span><span class="p">.</span><span class="n">transferring</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
           <span class="c1"># ä¸‹è½½å®Œæˆåè°ƒç”¨_process_queue
</span>           <span class="bp">self</span><span class="p">.</span><span class="n">_process_queue</span><span class="p">(</span><span class="n">spider</span><span class="p">,</span> <span class="n">slot</span><span class="p">)</span>
           <span class="k">return</span> <span class="n">_</span>
       <span class="k">return</span> <span class="n">dfd</span><span class="p">.</span><span class="n">addBoth</span><span class="p">(</span><span class="n">finish_transferring</span><span class="p">)</span>
</code></pre></div></div>

<p>åœ¨è¿™é‡Œï¼Œä¹Ÿç»´æŠ¤äº†ä¸€ä¸ªä¸‹è½½é˜Ÿåˆ—ï¼Œå¯æ ¹æ®é…ç½®è¾¾åˆ°å»¶è¿Ÿä¸‹è½½çš„è¦æ±‚ã€‚çœŸæ­£å‘èµ·ä¸‹è½½è¯·æ±‚çš„æ˜¯è°ƒç”¨äº†<code class="language-plaintext highlighter-rouge">self.handlers.download_request</code>ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">download_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">spider</span><span class="p">):</span>
    <span class="c1"># è·å–è¯·æ±‚çš„scheme
</span>    <span class="n">scheme</span> <span class="o">=</span> <span class="n">urlparse_cached</span><span class="p">(</span><span class="n">request</span><span class="p">).</span><span class="n">scheme</span>
    <span class="c1"># æ ¹æ®scheemeè·å–ä¸‹è½½å¤„ç†å™¨
</span>    <span class="n">handler</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_get_handler</span><span class="p">(</span><span class="n">scheme</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">handler</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">NotSupported</span><span class="p">(</span><span class="s">"Unsupported URL scheme '%s': %s"</span> <span class="o">%</span>
                           <span class="p">(</span><span class="n">scheme</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">_notconfigured</span><span class="p">[</span><span class="n">scheme</span><span class="p">]))</span>
    <span class="c1"># å¼€å§‹ä¸‹è½½ï¼Œå¹¶è¿”å›ç»“æœ
</span>    <span class="k">return</span> <span class="n">handler</span><span class="p">.</span><span class="n">download_request</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">spider</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_get_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scheme</span><span class="p">):</span>
    <span class="c1"># æ ¹æ®schemeè·å–å¯¹åº”çš„ä¸‹è½½å¤„ç†å™¨
</span>    <span class="c1"># é…ç½®æ–‡ä»¶ä¸­å®šä¹‰å¥½äº†httpã€httpsã€ftpç­‰èµ„æºçš„ä¸‹è½½å¤„ç†å™¨
</span>    <span class="k">if</span> <span class="n">scheme</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">_handlers</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">_handlers</span><span class="p">[</span><span class="n">scheme</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">scheme</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">_notconfigured</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">scheme</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">_schemes</span><span class="p">:</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_notconfigured</span><span class="p">[</span><span class="n">scheme</span><span class="p">]</span> <span class="o">=</span> <span class="s">'no handler available for that scheme'</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_schemes</span><span class="p">[</span><span class="n">scheme</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># å®ä¾‹åŒ–ä¸‹è½½å¤„ç†å™¨
</span>        <span class="n">dhcls</span> <span class="o">=</span> <span class="n">load_object</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">dh</span> <span class="o">=</span> <span class="n">dhcls</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">_crawler</span><span class="p">.</span><span class="n">settings</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">NotConfigured</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_notconfigured</span><span class="p">[</span><span class="n">scheme</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">logger</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="s">'Loading "%(clspath)s" for scheme "%(scheme)s"'</span><span class="p">,</span>
                     <span class="p">{</span><span class="s">"clspath"</span><span class="p">:</span> <span class="n">path</span><span class="p">,</span> <span class="s">"scheme"</span><span class="p">:</span> <span class="n">scheme</span><span class="p">},</span>
                     <span class="n">exc_info</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>  <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s">'crawler'</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">_crawler</span><span class="p">})</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_notconfigured</span><span class="p">[</span><span class="n">scheme</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_handlers</span><span class="p">[</span><span class="n">scheme</span><span class="p">]</span> <span class="o">=</span> <span class="n">dh</span>
    <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">_handlers</span><span class="p">[</span><span class="n">scheme</span><span class="p">]</span>
</code></pre></div></div>

<p>ä¸‹è½½å‰ï¼Œå…ˆé€šè¿‡è§£æ<code class="language-plaintext highlighter-rouge">request</code>çš„<code class="language-plaintext highlighter-rouge">scheme</code>æ¥è·å–å¯¹åº”çš„ä¸‹è½½å¤„ç†å™¨ï¼Œé»˜è®¤é…ç½®æ–‡ä»¶ä¸­å®šä¹‰çš„ä¸‹è½½å¤„ç†å™¨ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">DOWNLOAD_HANDLERS_BASE</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'file'</span><span class="p">:</span> <span class="s">'scrapy.core.downloader.handlers.file.FileDownloadHandler'</span><span class="p">,</span>
    <span class="s">'http'</span><span class="p">:</span> <span class="s">'scrapy.core.downloader.handlers.http.HTTPDownloadHandler'</span><span class="p">,</span>
    <span class="s">'https'</span><span class="p">:</span> <span class="s">'scrapy.core.downloader.handlers.http.HTTPDownloadHandler'</span><span class="p">,</span>
    <span class="s">'s3'</span><span class="p">:</span> <span class="s">'scrapy.core.downloader.handlers.s3.S3DownloadHandler'</span><span class="p">,</span>
    <span class="s">'ftp'</span><span class="p">:</span> <span class="s">'scrapy.core.downloader.handlers.ftp.FTPDownloadHandler'</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ç„¶åè°ƒç”¨<code class="language-plaintext highlighter-rouge">download_request</code>æ–¹æ³•ï¼Œå®Œæˆç½‘ç»œä¸‹è½½ï¼Œè¿™é‡Œä¸å†è¯¦ç»†è®²è§£æ¯ä¸ªå¤„ç†å™¨çš„å®ç°ï¼Œç®€å•æ¥è¯´ä½ å°±æŠŠå®ƒæƒ³è±¡æˆå°è£…å¥½çš„ç½‘ç»œä¸‹è½½åº“ï¼Œè¾“å…¥URLï¼Œè¾“å‡ºä¸‹è½½ç»“æœå°±å¥½äº†ï¼Œè¿™æ ·æ–¹ä¾¿ç†è§£ã€‚</p>

<p>åœ¨ä¸‹è½½è¿‡ç¨‹ä¸­ï¼Œå¦‚æœå‘ç”Ÿå¼‚å¸¸æƒ…å†µï¼Œåˆ™ä¼šä¾æ¬¡è°ƒç”¨ä¸‹è½½å™¨ä¸­é—´ä»¶çš„<code class="language-plaintext highlighter-rouge">process_exception</code>æ–¹æ³•ï¼Œæ¯ä¸ªä¸­é—´ä»¶åªéœ€å®šä¹‰è‡ªå·±çš„å¼‚å¸¸å¤„ç†é€»è¾‘å³å¯ã€‚</p>

<p>å¦‚æœä¸‹è½½æˆåŠŸï¼Œåˆ™ä¼šä¾æ¬¡æ‰§è¡Œä¸‹è½½å™¨ä¸­é—´ä»¶çš„<code class="language-plaintext highlighter-rouge">process_response</code>æ–¹æ³•ï¼Œæ¯ä¸ªä¸­é—´ä»¶å¯ä»¥è¿›ä¸€æ­¥å¤„ç†ä¸‹è½½åçš„ç»“æœï¼Œæœ€ç»ˆè¿”å›ã€‚</p>

<p>è¿™é‡Œå€¼å¾—æä¸€ä¸‹ï¼Œé™¤äº†<code class="language-plaintext highlighter-rouge">process_request</code>æ–¹æ³•æ˜¯æ¯ä¸ªä¸­é—´ä»¶é¡ºåºæ‰§è¡Œçš„ï¼Œè€Œ<code class="language-plaintext highlighter-rouge">process_response</code>å’Œ<code class="language-plaintext highlighter-rouge">process_exception</code>æ–¹æ³•æ˜¯æ¯ä¸ªä¸­é—´ä»¶å€’åºæ‰§è¡Œçš„ï¼Œå…·ä½“å¯çœ‹ä¸€ä¸‹<code class="language-plaintext highlighter-rouge">DownaloderMiddlewareManager</code>çš„<code class="language-plaintext highlighter-rouge">_add_middleware</code>æ–¹æ³•ï¼Œå¯æ˜ç™½æ˜¯å¦‚ä½•æ³¨å†Œè¿™ä¸ªæ–¹æ³•é“¾çš„ã€‚</p>

<p>æ‹¿åˆ°æœ€ç»ˆçš„ä¸‹è½½ç»“æœåï¼Œå†å›åˆ°<code class="language-plaintext highlighter-rouge">ExecuteEngine</code>çš„<code class="language-plaintext highlighter-rouge">_next_request_from_scheduler</code>æ–¹æ³•ï¼Œä¼šçœ‹åˆ°è°ƒç”¨äº†<code class="language-plaintext highlighter-rouge">_handle_downloader_output</code>æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯å¤„ç†ä¸‹è½½ç»“æœçš„é€»è¾‘ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_handle_downloader_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">spider</span><span class="p">):</span>
    <span class="c1"># ä¸‹è½½ç»“æœå¿…é¡»æ˜¯Requestã€Responseã€Failureå…¶ä¸€
</span>    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="p">(</span><span class="n">Request</span><span class="p">,</span> <span class="n">Response</span><span class="p">,</span> <span class="n">Failure</span><span class="p">)),</span> <span class="n">response</span>
    <span class="c1"># å¦‚æœæ˜¯Requestï¼Œåˆ™å†æ¬¡è°ƒç”¨crawlï¼Œæ‰§è¡ŒSchedulerçš„å…¥é˜Ÿé€»è¾‘
</span>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">Request</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">crawl</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">spider</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="c1"># å¦‚æœæ˜¯Responseæˆ–Failureï¼Œåˆ™è°ƒç”¨scraperçš„enqueue_scrapeè¿›ä¸€æ­¥å¤„ç†
</span>    <span class="c1"># ä¸»è¦æ˜¯å’ŒSpiderså’ŒPipelineäº¤äº’
</span>    <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">scraper</span><span class="p">.</span><span class="n">enqueue_scrape</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">spider</span><span class="p">)</span>
    <span class="n">d</span><span class="p">.</span><span class="n">addErrback</span><span class="p">(</span><span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">logger</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="s">'Error while enqueuing downloader output'</span><span class="p">,</span>
                                        <span class="n">exc_info</span><span class="o">=</span><span class="n">failure_to_exc_info</span><span class="p">(</span><span class="n">f</span><span class="p">),</span>
                                        <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s">'spider'</span><span class="p">:</span> <span class="n">spider</span><span class="p">}))</span>
    <span class="k">return</span> <span class="n">d</span>
</code></pre></div></div>

<p>æ‹¿åˆ°ä¸‹è½½ç»“æœåï¼Œä¸»è¦åˆ†2ä¸ªé€»è¾‘ï¼Œå¦‚æœæ˜¯<code class="language-plaintext highlighter-rouge">Request</code>å®ä¾‹ï¼Œåˆ™ç›´æ¥å†æ¬¡æ”¾å…¥<code class="language-plaintext highlighter-rouge">Scheduler</code>è¯·æ±‚é˜Ÿåˆ—ã€‚å¦‚æœæ˜¯<code class="language-plaintext highlighter-rouge">Response</code>æˆ–<code class="language-plaintext highlighter-rouge">Failure</code>å®ä¾‹ï¼Œåˆ™è°ƒç”¨Scraperçš„<code class="language-plaintext highlighter-rouge">enqueue_scrape</code>æ–¹æ³•ï¼Œè¿›è¡Œè¿›ä¸€æ­¥å¤„ç†ã€‚</p>

<p>Scrapyerä¸»è¦æ˜¯ä¸<code class="language-plaintext highlighter-rouge">Spideræ¨¡å—</code>å’Œ<code class="language-plaintext highlighter-rouge">Pipelineæ¨¡å—</code>è¿›è¡Œäº¤äº’ã€‚</p>

<h1 id="10å¤„ç†ä¸‹è½½ç»“æœ">10.å¤„ç†ä¸‹è½½ç»“æœ</h1>

<p>è¯·æ±‚å…¥é˜Ÿé€»è¾‘ä¸ç”¨å†è¯´ï¼Œå‰é¢å·²ç»è®²è¿‡ã€‚ç°åœ¨ä¸»è¦çœ‹<code class="language-plaintext highlighter-rouge">Scraper</code>çš„<code class="language-plaintext highlighter-rouge">enqueue_scrape</code>ï¼Œçœ‹Scraperç»„ä»¶æ˜¯å¦‚ä½•å¤„ç†åç»­é€»è¾‘çš„ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">enqueue_scrape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">spider</span><span class="p">):</span>
    <span class="c1"># åŠ å…¥Scrapeå¤„ç†é˜Ÿåˆ—
</span>    <span class="n">slot</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">slot</span>
    <span class="n">dfd</span> <span class="o">=</span> <span class="n">slot</span><span class="p">.</span><span class="n">add_response_request</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">finish_scraping</span><span class="p">(</span><span class="n">_</span><span class="p">):</span>
        <span class="n">slot</span><span class="p">.</span><span class="n">finish_response</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_check_if_closing</span><span class="p">(</span><span class="n">spider</span><span class="p">,</span> <span class="n">slot</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_scrape_next</span><span class="p">(</span><span class="n">spider</span><span class="p">,</span> <span class="n">slot</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_</span>
    <span class="n">dfd</span><span class="p">.</span><span class="n">addBoth</span><span class="p">(</span><span class="n">finish_scraping</span><span class="p">)</span>
    <span class="n">dfd</span><span class="p">.</span><span class="n">addErrback</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">logger</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="s">'Scraper bug processing %(request)s'</span><span class="p">,</span>
                               <span class="p">{</span><span class="s">'request'</span><span class="p">:</span> <span class="n">request</span><span class="p">},</span>
                               <span class="n">exc_info</span><span class="o">=</span><span class="n">failure_to_exc_info</span><span class="p">(</span><span class="n">f</span><span class="p">),</span>
                               <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s">'spider'</span><span class="p">:</span> <span class="n">spider</span><span class="p">}))</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">_scrape_next</span><span class="p">(</span><span class="n">spider</span><span class="p">,</span> <span class="n">slot</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dfd</span>
<span class="k">def</span> <span class="nf">_scrape_next</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spider</span><span class="p">,</span> <span class="n">slot</span><span class="p">):</span>
    <span class="k">while</span> <span class="n">slot</span><span class="p">.</span><span class="n">queue</span><span class="p">:</span>
        <span class="c1"># ä»Scraperé˜Ÿåˆ—ä¸­è·å–ä¸€ä¸ªå¾…å¤„ç†çš„ä»»åŠ¡
</span>        <span class="n">response</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">deferred</span> <span class="o">=</span> <span class="n">slot</span><span class="p">.</span><span class="n">next_response_request_deferred</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_scrape</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">spider</span><span class="p">).</span><span class="n">chainDeferred</span><span class="p">(</span><span class="n">deferred</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_scrape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">spider</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="p">(</span><span class="n">Response</span><span class="p">,</span> <span class="n">Failure</span><span class="p">))</span>
    <span class="c1"># è°ƒç”¨_scrape2ç»§ç»­å¤„ç†
</span>    <span class="n">dfd</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_scrape2</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">spider</span><span class="p">)</span>
    <span class="c1"># æ³¨å†Œå¼‚å¸¸å›è°ƒ
</span>    <span class="n">dfd</span><span class="p">.</span><span class="n">addErrback</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">handle_spider_error</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">spider</span><span class="p">)</span>
    <span class="c1"># å‡ºå£å›è°ƒ
</span>    <span class="n">dfd</span><span class="p">.</span><span class="n">addCallback</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">handle_spider_output</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">spider</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dfd</span>
<span class="k">def</span> <span class="nf">_scrape2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_result</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">spider</span><span class="p">):</span>
    <span class="c1"># å¦‚æœç»“æœä¸æ˜¯Failureå®ä¾‹ï¼Œåˆ™è°ƒç”¨çˆ¬è™«ä¸­é—´ä»¶ç®¡ç†å™¨çš„scrape_response
</span>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">request_result</span><span class="p">,</span> <span class="n">Failure</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">spidermw</span><span class="p">.</span><span class="n">scrape_response</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">call_spider</span><span class="p">,</span> <span class="n">request_result</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">spider</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># ç›´æ¥è°ƒç”¨call_spider
</span>        <span class="n">dfd</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">call_spider</span><span class="p">(</span><span class="n">request_result</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">spider</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dfd</span><span class="p">.</span><span class="n">addErrback</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">_log_download_errors</span><span class="p">,</span> <span class="n">request_result</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">spider</span><span class="p">)</span>
</code></pre></div></div>

<p>é¦–å…ˆåŠ å…¥åˆ°<code class="language-plaintext highlighter-rouge">Scraper</code>çš„å¤„ç†é˜Ÿåˆ—ä¸­ï¼Œç„¶åä»é˜Ÿåˆ—ä¸­è·å–åˆ°ä»»åŠ¡ï¼Œå¦‚æœä¸æ˜¯å¼‚å¸¸ç»“æœï¼Œåˆ™è°ƒç”¨<code class="language-plaintext highlighter-rouge">çˆ¬è™«ä¸­é—´ä»¶ç®¡ç†å™¨</code>çš„<code class="language-plaintext highlighter-rouge">scrape_response</code>æ–¹æ³•ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">scrape_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scrape_func</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">spider</span><span class="p">):</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">f</span><span class="p">:</span><span class="s">'%s.%s'</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">six</span><span class="p">.</span><span class="n">get_method_self</span><span class="p">(</span><span class="n">f</span><span class="p">).</span><span class="n">__class__</span><span class="p">.</span><span class="n">__name__</span><span class="p">,</span>
            <span class="n">six</span><span class="p">.</span><span class="n">get_method_function</span><span class="p">(</span><span class="n">f</span><span class="p">).</span><span class="n">__name__</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">process_spider_input</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
        <span class="c1"># æ‰§è¡Œä¸€ç³»åˆ—çˆ¬è™«ä¸­é—´ä»¶çš„process_spider_input
</span>        <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">methods</span><span class="p">[</span><span class="s">'process_spider_input'</span><span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="n">response</span><span class="o">=</span><span class="n">response</span><span class="p">,</span> <span class="n">spider</span><span class="o">=</span><span class="n">spider</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">result</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">,</span> \
                        <span class="s">'Middleware %s must returns None or '</span> \
                        <span class="s">'raise an exception, got %s '</span> \
                        <span class="o">%</span> <span class="p">(</span><span class="n">fname</span><span class="p">(</span><span class="n">method</span><span class="p">),</span> <span class="nb">type</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">scrape_func</span><span class="p">(</span><span class="n">Failure</span><span class="p">(),</span> <span class="n">request</span><span class="p">,</span> <span class="n">spider</span><span class="p">)</span>
        <span class="c1"># æ‰§è¡Œå®Œä¸­é—´ä»¶çš„ä¸€ç³»åˆ—process_spider_inputæ–¹æ³•åï¼Œæ‰§è¡Œcall_spider
</span>        <span class="k">return</span> <span class="n">scrape_func</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">spider</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">process_spider_exception</span><span class="p">(</span><span class="n">_failure</span><span class="p">):</span>
        <span class="c1"># æ‰§è¡Œä¸€ç³»åˆ—çˆ¬è™«ä¸­é—´ä»¶çš„process_spider_exception
</span>        <span class="n">exception</span> <span class="o">=</span> <span class="n">_failure</span><span class="p">.</span><span class="n">value</span>
        <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">methods</span><span class="p">[</span><span class="s">'process_spider_exception'</span><span class="p">]:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="n">response</span><span class="o">=</span><span class="n">response</span><span class="p">,</span> <span class="n">exception</span><span class="o">=</span><span class="n">exception</span><span class="p">,</span> <span class="n">spider</span><span class="o">=</span><span class="n">spider</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">result</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">_isiterable</span><span class="p">(</span><span class="n">result</span><span class="p">),</span> \
                <span class="s">'Middleware %s must returns None, or an iterable object, got %s '</span> <span class="o">%</span> \
                <span class="p">(</span><span class="n">fname</span><span class="p">(</span><span class="n">method</span><span class="p">),</span> <span class="nb">type</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">result</span>
        <span class="k">return</span> <span class="n">_failure</span>
    <span class="k">def</span> <span class="nf">process_spider_output</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
        <span class="c1"># æ‰§è¡Œä¸€ç³»åˆ—çˆ¬è™«ä¸­é—´ä»¶çš„process_spider_output
</span>        <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">methods</span><span class="p">[</span><span class="s">'process_spider_output'</span><span class="p">]:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="n">response</span><span class="o">=</span><span class="n">response</span><span class="p">,</span> <span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="p">,</span> <span class="n">spider</span><span class="o">=</span><span class="n">spider</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">_isiterable</span><span class="p">(</span><span class="n">result</span><span class="p">),</span> \
                <span class="s">'Middleware %s must returns an iterable object, got %s '</span> <span class="o">%</span> \
                <span class="p">(</span><span class="n">fname</span><span class="p">(</span><span class="n">method</span><span class="p">),</span> <span class="nb">type</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="c1"># æ‰§è¡Œprocess_spider_input
</span>    <span class="n">dfd</span> <span class="o">=</span> <span class="n">mustbe_deferred</span><span class="p">(</span><span class="n">process_spider_input</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
    <span class="c1"># æ³¨å†Œå¼‚å¸¸å›è°ƒ
</span>    <span class="n">dfd</span><span class="p">.</span><span class="n">addErrback</span><span class="p">(</span><span class="n">process_spider_exception</span><span class="p">)</span>
    <span class="c1"># æ³¨å†Œå‡ºå£å›è°ƒ
</span>    <span class="n">dfd</span><span class="p">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">process_spider_output</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dfd</span>
</code></pre></div></div>

<p>æœ‰æ²¡æœ‰æ„Ÿè§‰å¥—è·¯å¾ˆç†Ÿæ‚‰ï¼Ÿä¸ä¸Šé¢ä¸‹è½½å™¨ä¸­é—´ä»¶è°ƒç”¨æ–¹å¼éå¸¸ç›¸ä¼¼ï¼Œä¹Ÿè°ƒç”¨ä¸€ç³»åˆ—çš„å‰ç½®æ–¹æ³•ï¼Œå†æ‰§è¡ŒçœŸæ­£çš„å¤„ç†é€»è¾‘ï¼Œç„¶åæ‰§è¡Œä¸€äº›åˆ—çš„åç½®æ–¹æ³•ã€‚</p>

<h1 id="11å›è°ƒçˆ¬è™«">11.å›è°ƒçˆ¬è™«</h1>

<p>åœ¨è¿™é‡ŒçœŸæ­£çš„å¤„ç†é€»è¾‘æ˜¯<code class="language-plaintext highlighter-rouge">call_spider</code>ï¼Œä¹Ÿå°±æ˜¯å›è°ƒæˆ‘ä»¬å†™çš„çˆ¬è™«ç±»ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">call_spider</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">spider</span><span class="p">):</span>
    <span class="c1"># å›è°ƒçˆ¬è™«æ¨¡å—
</span>    <span class="n">result</span><span class="p">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">request</span>
    <span class="n">dfd</span> <span class="o">=</span> <span class="n">defer_result</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="c1"># æ³¨å†Œå›è°ƒæ–¹æ³•ï¼Œå–å¾—request.callbackï¼Œå¦‚æœæœªå®šä¹‰åˆ™è°ƒç”¨çˆ¬è™«æ¨¡å—çš„parseæ–¹æ³•
</span>    <span class="n">dfd</span><span class="p">.</span><span class="n">addCallbacks</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">callback</span> <span class="ow">or</span> <span class="n">spider</span><span class="p">.</span><span class="n">parse</span><span class="p">,</span> <span class="n">request</span><span class="p">.</span><span class="n">errback</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dfd</span><span class="p">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">iterate_spider_output</span><span class="p">)</span>
</code></pre></div></div>

<p>çœ‹åˆ°è¿™é‡Œï¼Œä½ åº”è¯¥æ›´ç†Ÿæ‚‰ï¼Œå¹³æ—¶æˆ‘ä»¬å†™çš„æœ€å¤šçš„çˆ¬è™«æ¨¡å—çš„<code class="language-plaintext highlighter-rouge">parse</code>åˆ™æ˜¯ç¬¬ä¸€ä¸ªå›è°ƒæ–¹æ³•ï¼Œåç»­çˆ¬è™«æ¨¡å—æ‹¿åˆ°ä¸‹è½½ç»“æœï¼Œå¯å®šä¹‰ä¸‹è½½åçš„<code class="language-plaintext highlighter-rouge">callback</code>å°±æ˜¯åœ¨è¿™é‡Œè¿›è¡Œå›è°ƒæ‰§è¡Œçš„ã€‚</p>

<h1 id="12å¤„ç†è¾“å‡º">12.å¤„ç†è¾“å‡º</h1>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">handle_spider_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">spider</span><span class="p">):</span>
    <span class="c1"># å¤„ç†çˆ¬è™«è¾“å‡ºç»“æœ
</span>    <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">defer_succeed</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
    <span class="n">it</span> <span class="o">=</span> <span class="n">iter_errback</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">handle_spider_error</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">spider</span><span class="p">)</span>
    <span class="c1"># æ³¨å†Œ_process_spidermw_output
</span>    <span class="n">dfd</span> <span class="o">=</span> <span class="n">parallel</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">concurrent_items</span><span class="p">,</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_process_spidermw_output</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">spider</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dfd</span>
<span class="k">def</span> <span class="nf">_process_spidermw_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">spider</span><span class="p">):</span>
    <span class="c1"># å¤„ç†Spideræ¨¡å—è¿”å›çš„æ¯ä¸€ä¸ªRequest/Item
</span>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">Request</span><span class="p">):</span>
        <span class="c1"># å¦‚æœç»“æœæ˜¯Requestï¼Œå†æ¬¡å…¥Schedulerçš„è¯·æ±‚é˜Ÿåˆ—
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">crawler</span><span class="p">.</span><span class="n">engine</span><span class="p">.</span><span class="n">crawl</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">output</span><span class="p">,</span> <span class="n">spider</span><span class="o">=</span><span class="n">spider</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="p">(</span><span class="n">BaseItem</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)):</span>
        <span class="c1"># å¦‚æœç»“æœæ˜¯BaseItem/dict
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">slot</span><span class="p">.</span><span class="n">itemproc_size</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1"># è°ƒç”¨Pipelineçš„process_item
</span>        <span class="n">dfd</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">itemproc</span><span class="p">.</span><span class="n">process_item</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">spider</span><span class="p">)</span>
        <span class="n">dfd</span><span class="p">.</span><span class="n">addBoth</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">_itemproc_finished</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">spider</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dfd</span>
    <span class="k">elif</span> <span class="n">output</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">typename</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">output</span><span class="p">).</span><span class="n">__name__</span>
        <span class="n">logger</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="s">'Spider must return Request, BaseItem, dict or None, '</span>
                     <span class="s">'got %(typename)r in %(request)s'</span><span class="p">,</span>
                     <span class="p">{</span><span class="s">'request'</span><span class="p">:</span> <span class="n">request</span><span class="p">,</span> <span class="s">'typename'</span><span class="p">:</span> <span class="n">typename</span><span class="p">},</span>
                     <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s">'spider'</span><span class="p">:</span> <span class="n">spider</span><span class="p">})</span>
</code></pre></div></div>

<p>æˆ‘ä»¬ç¼–å†™çˆ¬è™«ç±»æ—¶ï¼Œå†™çš„é‚£äº›å›è°ƒæ–¹æ³•å¤„ç†é€»è¾‘ï¼Œä¹Ÿå°±æ˜¯åœ¨è¿™é‡Œè¢«å›è°ƒæ‰§è¡Œï¼Œæ‰§è¡Œå®Œè‡ªå®šä¹‰çš„è§£æé€»è¾‘åï¼Œè§£ææ–¹æ³•å¯è¿”å›æ–°çš„<code class="language-plaintext highlighter-rouge">Request</code>æˆ–<code class="language-plaintext highlighter-rouge">BaseItem</code>å®ä¾‹ï¼Œå¦‚æœæ˜¯æ–°çš„è¯·æ±‚ï¼Œåˆ™å†æ¬¡é€šè¿‡<code class="language-plaintext highlighter-rouge">Scheduler</code>è¿›å…¥è¯·æ±‚é˜Ÿåˆ—ï¼Œå¦‚æœæ˜¯<code class="language-plaintext highlighter-rouge">BaseItem</code>å®ä¾‹ï¼Œåˆ™è°ƒç”¨<code class="language-plaintext highlighter-rouge">Pipeline</code>ç®¡ç†å™¨ï¼Œä¾æ¬¡æ‰§è¡Œ<code class="language-plaintext highlighter-rouge">process_item</code>ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬æƒ³è¾“å‡ºç»“æœæ—¶ï¼Œåªå®šä¹‰Pepelineç±»ï¼Œç„¶åé‡å†™è¿™ä¸ªæ–¹æ³•å°±å¯ä»¥äº†ã€‚</p>

<p><code class="language-plaintext highlighter-rouge">ItemPipeManager</code>å¤„ç†é€»è¾‘ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ItemPipelineManager</span><span class="p">(</span><span class="n">MiddlewareManager</span><span class="p">):</span>
    <span class="n">component_name</span> <span class="o">=</span> <span class="s">'item pipeline'</span>
    <span class="o">@</span><span class="nb">classmethod</span>
    <span class="k">def</span> <span class="nf">_get_mwlist_from_settings</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">build_component_list</span><span class="p">(</span><span class="n">settings</span><span class="p">.</span><span class="n">getwithbase</span><span class="p">(</span><span class="s">'ITEM_PIPELINES'</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">_add_middleware</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipe</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ItemPipelineManager</span><span class="p">,</span> <span class="bp">self</span><span class="p">).</span><span class="n">_add_middleware</span><span class="p">(</span><span class="n">pipe</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="s">'process_item'</span><span class="p">):</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">methods</span><span class="p">[</span><span class="s">'process_item'</span><span class="p">].</span><span class="n">append</span><span class="p">(</span><span class="n">pipe</span><span class="p">.</span><span class="n">process_item</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">process_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">spider</span><span class="p">):</span>
        <span class="c1"># ä¾æ¬¡è°ƒç”¨Pipelineçš„process_item
</span>        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">_process_chain</span><span class="p">(</span><span class="s">'process_item'</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">spider</span><span class="p">)</span>
</code></pre></div></div>

<p>å¯ä»¥çœ‹åˆ°<code class="language-plaintext highlighter-rouge">ItemPipeManager</code>ä¹Ÿæ˜¯ä¸€ä¸ªä¸­é—´ä»¶ï¼Œå’Œä¹‹å‰ä¸‹è½½å™¨ä¸­é—´ä»¶ç®¡ç†å™¨å’Œçˆ¬è™«ä¸­é—´ä»¶ç®¡ç†å™¨ç±»ä¼¼ï¼Œå¦‚æœå­ç±»æœ‰å®šä¹‰<code class="language-plaintext highlighter-rouge">process_item</code>ï¼Œåˆ™ä¾æ¬¡æ‰§è¡Œå®ƒã€‚</p>

<p>æ‰§è¡Œå®Œåï¼Œè°ƒç”¨<code class="language-plaintext highlighter-rouge">_itemproc_finished</code>ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_itemproc_finished</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">spider</span><span class="p">):</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">slot</span><span class="p">.</span><span class="n">itemproc_size</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">Failure</span><span class="p">):</span>
        <span class="n">ex</span> <span class="o">=</span> <span class="n">output</span><span class="p">.</span><span class="n">value</span>
        <span class="c1"># å¦‚æœåœ¨Pipelineå¤„ç†ä¸­æŠ›DropItemå¼‚å¸¸ï¼Œå¿½ç•¥å¤„ç†ç»“æœ
</span>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">DropItem</span><span class="p">):</span>
            <span class="n">logkws</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">logformatter</span><span class="p">.</span><span class="n">dropped</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">ex</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">spider</span><span class="p">)</span>
            <span class="n">logger</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="o">*</span><span class="n">logformatter_adapter</span><span class="p">(</span><span class="n">logkws</span><span class="p">),</span> <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s">'spider'</span><span class="p">:</span> <span class="n">spider</span><span class="p">})</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">signals</span><span class="p">.</span><span class="n">send_catch_log_deferred</span><span class="p">(</span>
                <span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="p">.</span><span class="n">item_dropped</span><span class="p">,</span> <span class="n">item</span><span class="o">=</span><span class="n">item</span><span class="p">,</span> <span class="n">response</span><span class="o">=</span><span class="n">response</span><span class="p">,</span>
                <span class="n">spider</span><span class="o">=</span><span class="n">spider</span><span class="p">,</span> <span class="n">exception</span><span class="o">=</span><span class="n">output</span><span class="p">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="s">'Error processing %(item)s'</span><span class="p">,</span> <span class="p">{</span><span class="s">'item'</span><span class="p">:</span> <span class="n">item</span><span class="p">},</span>
                         <span class="n">exc_info</span><span class="o">=</span><span class="n">failure_to_exc_info</span><span class="p">(</span><span class="n">output</span><span class="p">),</span>
                         <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s">'spider'</span><span class="p">:</span> <span class="n">spider</span><span class="p">})</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logkws</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">logformatter</span><span class="p">.</span><span class="n">scraped</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">spider</span><span class="p">)</span>
        <span class="n">logger</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="o">*</span><span class="n">logformatter_adapter</span><span class="p">(</span><span class="n">logkws</span><span class="p">),</span> <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s">'spider'</span><span class="p">:</span> <span class="n">spider</span><span class="p">})</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">signals</span><span class="p">.</span><span class="n">send_catch_log_deferred</span><span class="p">(</span>
            <span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="p">.</span><span class="n">item_scraped</span><span class="p">,</span> <span class="n">item</span><span class="o">=</span><span class="n">output</span><span class="p">,</span> <span class="n">response</span><span class="o">=</span><span class="n">response</span><span class="p">,</span>
            <span class="n">spider</span><span class="o">=</span><span class="n">spider</span><span class="p">)</span>
</code></pre></div></div>

<p>è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœæƒ³åœ¨<code class="language-plaintext highlighter-rouge">Pipeline</code>ä¸­ä¸¢å¼ƒæŸä¸ªç»“æœï¼Œç›´æ¥æŠ›å‡º<code class="language-plaintext highlighter-rouge">DropItem</code>å¼‚å¸¸å³å¯ï¼ŒScrapyä¼šè¿›è¡Œå¯¹åº”çš„å¤„ç†ã€‚</p>

<p>åˆ°è¿™é‡Œï¼ŒæŠ“å–ç»“æœæ ¹æ®è‡ªå®šä¹‰çš„è¾“å‡ºç±»è¾“å‡ºåˆ°æŒ‡å®šä½ç½®ï¼Œè€Œæ–°çš„Requeståˆ™ä¼šå†æ¬¡è¿›å…¥è¯·æ±‚é˜Ÿåˆ—ï¼Œç­‰å¾…å¼•æ“ä¸‹ä¸€æ¬¡è°ƒåº¦ï¼Œä¹Ÿå°±æ˜¯å†æ¬¡è°ƒç”¨<code class="language-plaintext highlighter-rouge">ExecutionEngine</code>çš„<code class="language-plaintext highlighter-rouge">_next_request</code>æ–¹æ³•ï¼Œç›´è‡³è¯·æ±‚é˜Ÿåˆ—æ²¡æœ‰æ–°çš„ä»»åŠ¡ï¼Œæ•´ä¸ªç¨‹åºé€€å‡ºã€‚</p>

<h1 id="13crawlerspider">13.CrawlerSpider</h1>

<p>è¿™é‡Œä¹Ÿç®€å•è¯´ä¸€ä¸‹<code class="language-plaintext highlighter-rouge">CrawlerSpider</code>ç±»ï¼Œå®ƒå…¶å®å°±ç»§æ‰¿äº†<code class="language-plaintext highlighter-rouge">Spider</code>ç±»ï¼Œç„¶åé‡å†™äº†<code class="language-plaintext highlighter-rouge">parse</code>æ–¹æ³•ï¼ˆè¿™ä¹Ÿæ˜¯é›†æˆæ­¤ç±»ä¸è¦é‡å†™æ­¤æ–¹æ³•çš„åŸå› ï¼‰ï¼Œå¹¶ç»“åˆ<code class="language-plaintext highlighter-rouge">Rule</code>ç­‰è§„åˆ™ç±»ï¼Œæ¥å®Œæˆ<code class="language-plaintext highlighter-rouge">Request</code>çš„è‡ªåŠ¨æå–é€»è¾‘ã€‚</p>

<p>ç”±æ­¤ä¹Ÿå¯çœ‹å‡ºï¼ŒScrapyçš„æ¯ä¸ªæ¨¡å—çš„å®ç°éƒ½éå¸¸çº¯ç²¹ï¼Œæ¯ä¸ªç»„ä»¶éƒ½é€šè¿‡é…ç½®æ–‡ä»¶å®šä¹‰è¿æ¥èµ·æ¥ï¼Œå¦‚æœæƒ³è¦æ‰©å±•æˆ–æ›¿æ¢ï¼Œåªéœ€å®šä¹‰å¹¶å®ç°è‡ªå·±çš„å¤„ç†é€»è¾‘å³å¯ï¼Œå…¶ä»–æ¨¡å—å‡ä¸å—ä»»ä½•å½±å“ï¼Œè¿™ä¹Ÿå¯¼è‡´ç¼–å†™ä¸€ä¸ªæ’ä»¶æ˜¯å˜å¾—å¤šä¹ˆå®¹æ˜“ï¼</p>

<h1 id="14æ€»ç»“">14.æ€»ç»“</h1>

<p>æ€»ç»“ä¸€ä¸‹æ•´ä¸ªè¿è¡Œæµç¨‹ï¼Œè¿˜æ˜¯ç”¨è¿™ä¸¤å¼ å›¾è¡¨ç¤ºå†æ¸…æ¥šä¸è¿‡ï¼š</p>

<p><img src="http://walidream.com:9999/blogImage/python/python_22.png" alt="ssl" /></p>

<p><img src="http://walidream.com:9999/blogImage/python/python_24.png" alt="ssl" /></p>

<p>Scrapyæ•´ä½“ç»™æˆ‘çš„æ„Ÿè§‰æ˜¯ï¼Œè™½ç„¶å®ƒæä¾›çš„åªæ˜¯å•æœºç‰ˆçš„çˆ¬è™«æ¡†æ¶ï¼Œä½†æˆ‘ä»¬å¯ä»¥é€šè¿‡ç¼–å†™æ›´å¤šçš„æ’ä»¶å’Œæ›¿æ¢æŸäº›ç»„ä»¶ï¼Œæ¥å®šåˆ¶åŒ–è‡ªå·±çš„çˆ¬è™«ï¼Œä»è€Œæ¥å®ç°æ›´å¼ºå¤§çš„åŠŸèƒ½ï¼Œä¾‹å¦‚åˆ†å¸ƒå¼ã€ä»£ç†è°ƒåº¦ã€å¹¶å‘æ§åˆ¶ã€å¯è§†åŒ–ã€ç›‘æ§ç­‰ç­‰åŠŸèƒ½ï¼Œéƒ½æ˜¯éå¸¸æ–¹ä¾¿çš„ï¼</p>

:ET