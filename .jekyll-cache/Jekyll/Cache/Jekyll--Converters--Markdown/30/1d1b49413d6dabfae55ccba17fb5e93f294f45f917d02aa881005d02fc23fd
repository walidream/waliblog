I"Ò=<p>ngx_http_geoip_moduleæ˜¯å¯¹IPåœ°å€è¿›è¡Œåœ°åŸŸä¿¡æ¯çš„è¯»å–ã€‚å®¢æˆ·ç«¯åœ¨è®¿é—®æ—¶ï¼Œé€šè¿‡ipåœ°å€èƒ½å¤ŸçŸ¥é“å®¢æˆ·ç«¯æ‰€åœ¨çš„å›½å®¶ï¼ŒåŸå¸‚ã€‚å¸¸ç”¨äºå¤„ç†ä¸åŒå›½å®¶çš„å®¢æˆ·è®¿é—®ã€‚</p>

<p>ä¹‹å‰å°èœæœ‰å†™è¿‡ç”¨yumæºå®‰è£…nginx<a href="/nginx/2018/11/10/nginx-3.html" title="/nginx/2018/11/10/nginx-3.html">ä¼ é€é—¨</a>å’Œnginxå¹³æ»‘å‡çº§<a href="/nginx/2019/01/05/nginx-24.html" title="/nginx/2019/01/05/nginx-24.html">ä¼ é€é—¨</a>å¦‚æœå°ä¼™ä¼´ä»¬ä¸è®°å¾—å¯ä»¥å›å¤´æ‰¾æ‰¾ã€‚
åœ¨nginxå¹³æ»‘å‡çº§ä¸­ä»‹ç»åˆ°ç”¨æºç æ·»åŠ æ¨¡å—ã€‚</p>

<ul>
  <li>
    <p><a href="https://www.vpsee.com/2011/03/install-nginx-with-geoip-module-for-country-targeting/" title="https://www.vpsee.com/2011/03/install-nginx-with-geoip-module-for-country-targeting/" target="_blank">hi@vpsee.comåšå®¢</a></p>
  </li>
  <li>
    <p><a href="https://serverfault.com/questions/503909/geoip-for-configuration-into-nginx" title="https://serverfault.com/questions/503909/geoip-for-configuration-into-nginx">ç¼–è¯‘æ—¶å‡ºé”™æ’é”™</a></p>
  </li>
</ul>

<h1 id="1ä¸‹è½½nginx-module-geoip">1.ä¸‹è½½nginx-module-geoip</h1>

<p>åœ¨ç¬¬3å°èŠ‚ä¸­è®°å½•nginxå®‰è£…ä¸­ï¼Œé»˜è®¤æ˜¯æ²¡æœ‰å®‰è£…è¿™ä¸ªæ¨¡å—ã€‚éœ€è¦æ‰‹åŠ¨ä¸‹è½½<code class="language-plaintext highlighter-rouge">ngx_http_geoip_module</code>æ¨¡å—ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yum install nginx-module-geoip
</code></pre></div></div>

<p>å®‰è£…æˆåŠŸåï¼Œä¼šåœ¨<code class="language-plaintext highlighter-rouge">/etc/nginx/module</code>æ–‡ä»¶å¤¹ä¸‹å‡ºç°geoipæ¨¡å—ã€‚</p>

<h1 id="2å®‰è£…maxmindçš„geoipåº“">2.å®‰è£…MaxMindçš„GeoIPåº“</h1>

<p>å°†GeoIPåº“ä¸‹è½½ç›®å½•<code class="language-plaintext highlighter-rouge">/opt/download</code>æ–‡ä»¶å¤¹ä¸‹</p>

<pre><code class="language-linux">cd /opt/download  #å¦‚æœæ²¡æœ‰æ‰‹åŠ¨åˆ›å»º
wget http://geolite.maxmind.com/download/geoip/api/c/GeoIP.tar.gz
tar -zxvf GeoIP.tar.gz
cd GeoIP-1.4.8
./configure
make
make install
</code></pre>

<p>åˆšæ‰å®‰è£…çš„åº“è‡ªåŠ¨å®‰è£…åˆ° /usr/local/lib ä¸‹ï¼Œæ‰€ä»¥è¿™ä¸ªç›®å½•éœ€è¦åŠ åˆ°åŠ¨æ€é“¾æ¥é…ç½®é‡Œé¢ä»¥ä¾¿è¿è¡Œç›¸å…³ç¨‹åºçš„æ—¶å€™èƒ½è‡ªåŠ¨ç»‘å®šåˆ°è¿™ä¸ª GeoIP åº“ï¼š</p>

<pre><code class="language-linux">echo '/usr/local/lib' &gt; /etc/ld.so.conf.d/geoip.conf
ldconfig
</code></pre>

<h1 id="3ä¸‹è½½ipæ•°æ®åº“">3.ä¸‹è½½IPæ•°æ®åº“</h1>

<p>æœ€ç»ˆç›®å½•ç»“æ„</p>

<pre><code class="language-txt">/etc/nginx/data/geoip
|-GeoIP.dat
|-GeoLiteCity.dat
</code></pre>

<p>MaxMind æä¾›äº†å…è´¹çš„ IP åœ°åŸŸæ•°æ®åº“ï¼Œè¿™ä¸ªæ•°æ®åº“æ˜¯äºŒè¿›åˆ¶çš„ï¼Œä¸èƒ½ç”¨æ–‡æœ¬ç¼–è¾‘å™¨æ‰“å¼€ï¼Œéœ€è¦ä¸Šé¢çš„ GeoIP åº“æ¥è¯»å–ã€‚å°èœåœ¨è¿™é‡Œæ”¾ä¸€ä¸ªå®˜æ–¹çš„ä¸‹è½½åœ°å€<a href="https://dev.maxmind.com/zh-hans/geoip/legacy/geolite/" title="https://dev.maxmind.com/zh-hans/geoip/legacy/geolite/" target="_blank">å®˜æ–¹ä¸‹è½½</a>
éœ€è¦ä¸‹è½½<code class="language-plaintext highlighter-rouge">GeoIP.dat.gz</code>æ–‡ä»¶å’Œ<code class="language-plaintext highlighter-rouge">GeoLiteCity.dat.gz</code>æ–‡ä»¶ã€‚å°èœåœ¨è¿™é‡Œæ”¾ä¸€ä¸ªäº‘ç›˜ï¼Œæ–¹ä¾¿å›½å†…å°ä¼™ä¼´è·å–<a href="https://pan.baidu.com/s/120UKQWFILuRQMfn2s-tYHg" title="https://pan.baidu.com/s/120UKQWFILuRQMfn2s-tYHg" target="_blank">äº‘ç›˜åœ°å€</a> æå–ç [ 5ft5 ]</p>

<pre><code class="language-linux">cd /etc/nginx/data/geoip  #å¦‚æœæ²¡æœ‰dataï¼Œéœ€è¦æ‰‹åŠ¨åˆ›å»º

gunzip GeoIP.dat.gz  #è§£å‹
gunzip GeoLiteCity.dat.gz  #è§£å‹
</code></pre>

<h1 id="4ç¼–è¯‘å®‰è£…">4.ç¼–è¯‘å®‰è£…</h1>

<p>åŸºæœ¬å·¥ä½œå‡†å¤‡å®Œæˆåæˆ‘ä»¬å°±å¯ä»¥ngx_http_geoip_moduleç¼–è¯‘è¿›nginxã€‚<a href="http://nginx.org/en/docs/http/ngx_http_geoip_module.html" title="http://nginx.org/en/docs/http/ngx_http_geoip_module.html" target="_blank">ngx_http_geoip_moduleæ–‡æ¡£</a>
é»˜è®¤æƒ…å†µä¸‹ä¸æ„å»ºæ­¤æ¨¡å—ï¼Œåº”ä½¿ç”¨<code class="language-plaintext highlighter-rouge">--with-http_geoip_module</code>é…ç½®å‚æ•°å¯ç”¨å®ƒã€‚</p>

<p>ä¹‹å‰åœ¨nginxå¹³æ»‘å‡çº§ä¸­å°èœç¼–è¯‘nginxçš„æºç åŒ…æ”¾åœ¨<code class="language-plaintext highlighter-rouge">/opt/download/nginx-1.14.2</code>æ–‡ä»¶å¤¹ä¸‹ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd /opt/download/nginx-1.14.2
</code></pre></div></div>

<h4 id="è·å–ç¼–è¯‘å‚æ•°">è·å–ç¼–è¯‘å‚æ•°</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nginx -V
</code></pre></div></div>

<p>è¾“å‡º</p>

<p>â€“prefix=/etc/nginx â€“sbin-path=/usr/sbin/nginx â€“modules-path=/usr/lib64/nginx/modules â€“conf-path=/etc/nginx/nginx.conf â€“error-log-path=/var/log/nginx/error.log â€“http-log-path=/var/log/nginx/access.log â€“pid-path=/var/run/nginx.pid â€“lock-path=/var/run/nginx.lock â€“http-client-body-temp-path=/var/cache/nginx/client_temp â€“http-proxy-temp-path=/var/cache/nginx/proxy_temp â€“http-fastcgi-temp-path=/var/cache/nginx/fastcgi_temp â€“http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp â€“http-scgi-temp-path=/var/cache/nginx/scgi_temp â€“user=nginx â€“group=nginx â€“with-compat â€“with-file-aio â€“with-threads â€“with-http_addition_module â€“with-http_auth_request_module â€“with-http_dav_module â€“with-http_flv_module â€“with-http_gunzip_module â€“with-http_gzip_static_module â€“with-http_mp4_module â€“with-http_random_index_module â€“with-http_realip_module â€“with-http_secure_link_module â€“with-http_slice_module â€“with-http_ssl_module â€“with-http_stub_status_module â€“with-http_sub_module â€“with-http_v2_module â€“with-mail â€“with-mail_ssl_module â€“with-stream â€“with-stream_realip_module â€“with-stream_ssl_module â€“with-stream_ssl_preread_module â€“with-cc-opt=â€™-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong â€“param=ssp-buffer-size=4 -grecord-gcc-switches -m64 -mtune=generic -fPICâ€™ â€“with-ld-opt=â€™-Wl,-z,relro -Wl,-z,now -pieâ€™</p>

<h4 id="æ·»åŠ ç¼–è¯‘å‚æ•°--with-http_geoip_module">æ·»åŠ ç¼–è¯‘å‚æ•°<code class="language-plaintext highlighter-rouge">--with-http_geoip_module</code></h4>

<p><code class="language-plaintext highlighter-rouge">--prefix=/etc/nginx --sbin-path=/usr/sbin/nginx --modules-path=/usr/lib64/nginx/modules --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/log/nginx/error.log --http-log-path=/var/log/nginx/access.log --pid-path=/var/run/nginx.pid --lock-path=/var/run/nginx.lock --http-client-body-temp-path=/var/cache/nginx/client_temp --http-proxy-temp-path=/var/cache/nginx/proxy_temp --http-fastcgi-temp-path=/var/cache/nginx/fastcgi_temp --http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp --http-scgi-temp-path=/var/cache/nginx/scgi_temp --user=nginx --group=nginx --with-compat --with-file-aio --with-threads --with-http_addition_module --with-http_auth_request_module --with-http_dav_module --with-http_flv_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_mp4_module --with-http_random_index_module --with-http_realip_module --with-http_secure_link_module --with-http_slice_module --with-http_ssl_module --with-http_stub_status_module --with-http_sub_module --with-http_v2_module --with-mail --with-mail_ssl_module --with-stream --with-stream_realip_module --with-stream_ssl_module --with-stream_ssl_preread_module --with-cc-opt='-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -m64 -mtune=generic -fPIC' --with-ld-opt='-Wl,-z,relro -Wl,-z,now -pie' --with-http_geoip_module</code></p>

<h4 id="ç¼–è¯‘">ç¼–è¯‘</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./configure  ä¸Šé¢ç¼–è¯‘å‚æ•° 
</code></pre></div></div>

<h4 id="å®‰è£…">å®‰è£…</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>make &amp;&amp; make install
</code></pre></div></div>

<p>å¦‚æœåœ¨ç¼–è¯‘ä¸­æœ‰é”™è¯¯ï¼ŒæŸ¥çœ‹æœ€ä¸Šé¢çš„<code class="language-plaintext highlighter-rouge">ç¼–è¯‘æ—¶å‡ºé”™æ’é”™</code>ã€‚å¸Œæœ›å¯¹å°ä¼™ä¼´ä»¬æœ‰ç”¨</p>

<h4 id="æ£€æµ‹">æ£€æµ‹</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nginx -V
</code></pre></div></div>

<p>æŸ¥çœ‹è¾“å‡ºç¼–è¯‘å‚æ•°æœ‰æ²¡æœ‰<code class="language-plaintext highlighter-rouge">--with-http_geoip_module</code>ï¼Œæœ‰å°±è¯æ˜å®‰è£…å¥½äº†ã€‚</p>

<h1 id="5é…ç½®æ¨¡å—">5.é…ç½®æ¨¡å—</h1>

<h4 id="geoip_country">geoip_country</h4>

<div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Syntax:</span>	<span class="s">geoip_country</span> <span class="s">file</span><span class="p">;</span>
<span class="k">Default:</span> <span class="s">â€”</span>
<span class="s">Context:</span> <span class="s">http</span>
</code></pre></div></div>

<p><br /></p>

<table>
  <thead>
    <tr>
      <th>å‚æ•°å</th>
      <th>æè¿°</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>$geoip_country_code</td>
      <td>ä¸¤ä¸ªå­—æ¯çš„å›½å®¶/åœ°åŒºä»£ç ï¼Œä¾‹å¦‚â€œRUâ€ï¼Œâ€œUSâ€</td>
    </tr>
    <tr>
      <td>$geoip_country_code3</td>
      <td>ä¸‰ä¸ªå­—æ¯çš„å›½å®¶/åœ°åŒºä»£ç ï¼Œä¾‹å¦‚â€œRUSâ€ï¼Œâ€œUSAâ€</td>
    </tr>
    <tr>
      <td>$geoip_country_name</td>
      <td>å›½åï¼Œä¾‹å¦‚â€œä¿„ç½—æ–¯è”é‚¦â€ï¼Œâ€œç¾å›½â€</td>
    </tr>
  </tbody>
</table>

<h4 id="geoip_city">geoip_city</h4>

<div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Syntax:</span>	<span class="s">geoip_city</span> <span class="s">file</span><span class="p">;</span>
<span class="k">Default:</span> <span class="s">â€”</span>
<span class="s">Context:</span> <span class="s">http</span>
</code></pre></div></div>
<p><br /></p>

<table>
  <thead>
    <tr>
      <th>å‚æ•°å</th>
      <th>æè¿°</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>$geoip_area_code</td>
      <td>ç”µè¯åŒºå·ï¼ˆä»…é™ç¾å›½ï¼‰</td>
    </tr>
    <tr>
      <td>$geoip_city_continent_code</td>
      <td>ä¸¤ä¸ªå­—æ¯çš„å¤§é™†ä»£ç ï¼Œä¾‹å¦‚â€œEUâ€ï¼Œâ€œNAâ€</td>
    </tr>
    <tr>
      <td>$geoip_city_country_code</td>
      <td>ä¸¤ä¸ªå­—æ¯çš„å›½å®¶/åœ°åŒºä»£ç ï¼Œä¾‹å¦‚â€œRUâ€ï¼Œâ€œUSâ€</td>
    </tr>
    <tr>
      <td>$geoip_city_country_code3</td>
      <td>ä¸‰ä¸ªå­—æ¯çš„å›½å®¶/åœ°åŒºä»£ç ï¼Œä¾‹å¦‚â€œRUSâ€ï¼Œâ€œUSAâ€</td>
    </tr>
    <tr>
      <td>$geoip_city_country_name</td>
      <td>å›½åï¼Œä¾‹å¦‚â€œä¿„ç½—æ–¯è”é‚¦â€ï¼Œâ€œç¾å›½â€</td>
    </tr>
    <tr>
      <td>$geoip_dma_code</td>
      <td>æ ¹æ®Google AdWords APIä¸­çš„åœ°ç†ä½ç½®å®šä½ï¼Œç¾å›½çš„DMAåŒºåŸŸä»£ç ï¼ˆä¹Ÿç§°ä¸ºâ€œéƒ½å¸‚ä»£ç â€ï¼‰</td>
    </tr>
    <tr>
      <td>$geoip_latitude</td>
      <td>çº¬åº¦</td>
    </tr>
    <tr>
      <td>$geoip_longitude</td>
      <td>ç»åº¦</td>
    </tr>
    <tr>
      <td>$geoip_region</td>
      <td>åŒç¬¦å·å›½å®¶åŒºåŸŸä»£ç ï¼ˆåœ°åŒºï¼Œé¢†åœŸï¼Œå·ï¼Œçœï¼Œè”é‚¦åœŸåœ°ç­‰ï¼‰ï¼Œä¾‹å¦‚â€œ48â€ï¼Œâ€œDCâ€</td>
    </tr>
    <tr>
      <td>$geoip_region_name</td>
      <td>å›½å®¶åœ°åŒºåç§°ï¼ˆåœ°åŒºï¼Œé¢†åœŸï¼Œå·ï¼Œçœï¼Œè”é‚¦åœŸåœ°ç­‰ï¼‰ï¼Œä¾‹å¦‚â€œè«æ–¯ç§‘å¸‚â€ï¼Œâ€œå“¥ä¼¦æ¯”äºšç‰¹åŒºâ€</td>
    </tr>
    <tr>
      <td>$geoip_city</td>
      <td>åŸå¸‚åç§°ï¼Œä¾‹å¦‚â€œè«æ–¯ç§‘â€ï¼Œâ€œåç››é¡¿â€</td>
    </tr>
    <tr>
      <td>$geoip_postal_code</td>
      <td>é‚®æ”¿ç¼–ç </td>
    </tr>
  </tbody>
</table>

<h4 id="geoip_org">geoip_org</h4>

<div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Syntax:</span>	<span class="s">geoip_org</span> <span class="s">file</span><span class="p">;</span>
<span class="k">Default:</span> <span class="s">â€”</span>
<span class="s">Context:</span> <span class="s">http</span>
</code></pre></div></div>
<p><br /></p>

<table>
  <thead>
    <tr>
      <th>å‚æ•°å</th>
      <th>æè¿°</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>$geoip_org</td>
      <td>ç»„ç»‡åç§°ï¼Œä¾‹å¦‚â€œå¢¨å°”æœ¬å¤§å­¦â€</td>
    </tr>
  </tbody>
</table>

<h4 id="geoip_proxy">geoip_proxy</h4>

<div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Syntax:</span>	<span class="s">geoip_proxy</span> <span class="s">address</span> <span class="s">|</span> <span class="s">CIDR</span><span class="p">;</span>
<span class="k">Default:</span> <span class="s">â€”</span>
<span class="s">Context:</span> <span class="s">http</span>
</code></pre></div></div>

<p>å®šä¹‰å¯ä¿¡åœ°å€ã€‚å½“è¯·æ±‚æ¥è‡ªå¯ä¿¡åœ°å€æ—¶ï¼Œå°†ä½¿ç”¨æ¥è‡ª<code class="language-plaintext highlighter-rouge">X-Forwarded-For</code>è¯·æ±‚å¤´å­—æ®µçš„åœ°å€ã€‚</p>

<h4 id="geoip_proxy_recursive">geoip_proxy_recursive</h4>

<div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Syntax:</span>	<span class="s">geoip_proxy_recursive</span> <span class="no">on</span> <span class="s">|</span> <span class="no">off</span><span class="p">;</span>
<span class="k">Default:</span> <span class="s">geoip_proxy_recursive</span> <span class="no">off</span><span class="p">;</span>
<span class="k">Context:</span> <span class="s">http</span>
</code></pre></div></div>

<p>å¦‚æœç¦ç”¨é€’å½’æœç´¢ï¼Œåˆ™ä¸ä½¿ç”¨ä¸å…¶ä¸­ä¸€ä¸ªå¯ä¿¡åœ°å€åŒ¹é…çš„åŸå§‹å®¢æˆ·ç«¯åœ°å€ï¼Œè€Œæ˜¯ä½¿ç”¨<code class="language-plaintext highlighter-rouge">X-Forwarded-For</code>ä¸­å‘é€çš„æœ€åä¸€ä¸ªåœ°å€ã€‚å¦‚æœå¯ç”¨é€’å½’æœç´¢ï¼Œåˆ™ä¸ä½¿ç”¨ä¸å…¶ä¸­ä¸€ä¸ªå¯ä¿¡åœ°å€åŒ¹é…çš„åŸå§‹å®¢æˆ·ç«¯åœ°å€ï¼Œè€Œæ˜¯ä½¿ç”¨åœ¨<code class="language-plaintext highlighter-rouge">X-Forwarded-For</code>ä¸­å‘é€çš„æœ€åä¸€ä¸ªä¸å¯ä¿¡åœ°å€ã€‚</p>

<h1 id="6é…ç½®æ•™ç¨‹">6.é…ç½®æ•™ç¨‹</h1>

<p>æœåŠ¡ç›®å½•</p>

<pre><code class="language-txt">/etc/nginx/conf.d
|-geoip.conf
</code></pre>

<h4 id="geoipconf">geoip.conf</h4>

<div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">geoip_country</span> <span class="n">/etc/nginx/data/geoip/GeoIP.dat</span><span class="p">;</span>
<span class="k">geoip_city</span> <span class="n">/etc/nginx/data/geoip/GeoLiteCity.dat</span><span class="p">;</span>
<span class="k">server</span> <span class="p">{</span>
    <span class="kn">listen</span>       <span class="mi">80</span><span class="p">;</span>
    <span class="kn">server_name</span>  <span class="s">localhost</span><span class="p">;</span>

    <span class="c1">#charset koi8-r;</span>
    <span class="kn">access_log</span>  <span class="n">/var/log/nginx/log/geoip.access.log</span>  <span class="s">main</span><span class="p">;</span>

    <span class="kn">location</span> <span class="n">/</span> <span class="p">{</span>
        <span class="kn">if</span> <span class="s">(</span><span class="nv">$geoip_country_code</span> <span class="s">!=</span> <span class="s">CN)</span> <span class="p">{</span>
            <span class="kn">return</span> <span class="mi">403</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="kn">root</span>   <span class="n">/opt/app/code</span><span class="p">;</span>
        <span class="kn">index</span>  <span class="s">index.html</span> <span class="s">index.htm</span><span class="p">;</span>
    <span class="p">}</span>

   <span class="kn">location</span> <span class="n">/myip</span> <span class="p">{</span>
        <span class="kn">default_type</span> <span class="nc">text/plain</span><span class="p">;</span>
        <span class="kn">return</span> <span class="mi">200</span> <span class="s">"</span><span class="nv">$remote_addr</span> <span class="nv">$geoip_country_name</span> <span class="nv">$geoip_country_code</span> <span class="nv">$geoip_city</span><span class="s">"</span><span class="p">;</span>
   <span class="p">}</span>

<span class="p">}</span>
</code></pre></div></div>

:ET