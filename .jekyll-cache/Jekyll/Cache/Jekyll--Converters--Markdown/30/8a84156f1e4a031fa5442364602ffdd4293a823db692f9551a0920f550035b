I"Œa<p>nginxä»£ç†æœåŠ¡ï¼Œæ‰€è°“çš„ä»£ç†ç®€å•ç†è§£å°±æ˜¯ä»£ä¸ºåŠç†ã€‚ç”Ÿæ´»ä¸­å¸¸è§çš„ä»£ç†ï¼ˆä»£ç†ç†è´¢ã€ä»£ç†æ”¶è´§ç­‰ç­‰ï¼‰ã€‚åœ¨æ²¡æœ‰nginxä½œä¸ºä»£ç†æœåŠ¡æ—¶ï¼Œå®¢æˆ·ç«¯ç›´æ¥å‘é€è¯·æ±‚ï¼ŒæœåŠ¡ç«¯ç›´æ¥å“åº”è¯·æ±‚</p>

<p><img src="http://walidream.com:9999/blogImage/nginx/nginx_15.jpg?1234" alt="ssl" /></p>

<p>å½“å‡ºç°nginxä»£ç†æœåŠ¡æ—¶ï¼Œå®¢æˆ·ç«¯æ‰€æœ‰çš„è¯·æ±‚ç”±nginxæ¥æ”¶åœ¨è½¬å‘ç»™æœåŠ¡ç«¯ï¼ŒæœåŠ¡å•å“åº”ç»™nginxåœ¨æœ‰nginxå“åº”ç»™å®¢æˆ·ç«¯ã€‚</p>

<p><img src="http://walidream.com:9999/blogImage/nginx/nginx_16.jpg?1234" alt="ssl" /></p>

<h1 id="1ä»£ç†åˆ†ç±»">1.ä»£ç†åˆ†ç±»</h1>

<p>ä»£ç†åˆ†ç±»æŒ‰ç…§åº”ç”¨åœºæ™¯æ¨¡å¼åˆ†ä¸ºä¸¤ç±»ï¼Œä¸€ä¸ªæ˜¯<code class="language-plaintext highlighter-rouge">æ­£å‘ä»£ç†</code>ï¼Œæ­£å‘ä»£ç†ä»£ç†çš„å¯¹è±¡æ˜¯å®¢æˆ·ç«¯ï¼Œä¸ºå®¢æˆ·ç«¯æä¾›æœåŠ¡ï¼Œå¦ä¸€ä¸ªæ˜¯<code class="language-plaintext highlighter-rouge">åå‘ä»£ç†</code>ï¼Œåå‘ä»£ç†ä»£ç†çš„å¯¹è±¡æœåŠ¡ç«¯ï¼Œä¸ºæœåŠ¡ç«¯æä¾›æœåŠ¡ã€‚</p>

<p>æ­£å‘ä»£ç†å’Œåå‘ä»£ç†åŒºåˆ†æ˜¯çœ‹nginxä»£ç†çš„æ˜¯å®¢æˆ·ç«¯è¿˜æ˜¯æœåŠ¡ç«¯ï¼Œå¦‚æœnginxä»£ç†çš„æ˜¯å®¢æˆ·ç«¯å°±æ˜¯æ­£å‘ä»£ç†ï¼Œä»£ç†çš„æ˜¯æœåŠ¡ç«¯å°±æ˜¯åå‘ä»£ç†ã€‚</p>

<h1 id="2æ­£å‘ä»£ç†">2.æ­£å‘ä»£ç†</h1>

<p>æ­£å‘ä»£ç†ä¹Ÿå°±æ˜¯ä»£ç†ï¼Œä»–çš„å·¥ä½œåŸç†å°±åƒä¸€ä¸ªè·³æ¿ï¼Œç®€å•çš„è¯´ï¼Œæˆ‘è®¿é—®ä¸äº†google.comï¼Œä½†æ˜¯æˆ‘èƒ½è®¿é—®ä¸€ä¸ªä»£ç†æœåŠ¡å™¨Aï¼ŒAèƒ½è®¿é—®google.comï¼Œäºæ˜¯æˆ‘å…ˆè¿ä¸Šä»£ç†æœåŠ¡å™¨Aï¼Œå‘Šè¯‰ä»–æˆ‘éœ€è¦google.comçš„å†…å®¹ï¼ŒAå°±å»å–å›æ¥ï¼Œç„¶åè¿”å›ç»™æˆ‘ã€‚ä»ç½‘ç«™çš„è§’åº¦ï¼Œåªåœ¨ä»£ç†æœåŠ¡å™¨æ¥å–å†…å®¹çš„æ—¶å€™æœ‰ä¸€æ¬¡è®°å½•ï¼Œæœ‰æ—¶å€™å¹¶ä¸çŸ¥é“æ˜¯ç”¨æˆ·çš„è¯·æ±‚ï¼Œä¹Ÿéšè—äº†ç”¨æˆ·çš„èµ„æ–™ï¼Œè¿™å–å†³äºä»£ç†å‘Šä¸å‘Šè¯‰ç½‘ç«™ã€‚</p>

<p>ç»“è®ºå°±æ˜¯ï¼Œæ­£å‘ä»£ç†æ˜¯ä¸€ä¸ªä½äºå®¢æˆ·ç«¯å’ŒåŸå§‹æœåŠ¡å™¨(origin server)ä¹‹é—´çš„æœåŠ¡å™¨ã€‚ä¸ºäº†ä»åŸå§‹æœåŠ¡å™¨å–å¾—å†…å®¹ï¼Œå®¢æˆ·ç«¯å‘ä»£ç†å‘é€ä¸€ä¸ªè¯·æ±‚å¹¶æŒ‡å®šç›®æ ‡(åŸå§‹æœåŠ¡å™¨)ï¼Œç„¶åä»£ç†å‘åŸå§‹æœåŠ¡å™¨è½¬äº¤è¯·æ±‚å¹¶å°†è·å¾—çš„å†…å®¹è¿”å›ç»™å®¢æˆ·ç«¯ã€‚</p>

<p><img src="http://walidream.com:9999/blogImage/nginx/nginx_17.png?1234" alt="ssl" /></p>

<h1 id="3åå‘ä»£ç†">3.åå‘ä»£ç†</h1>

<p>ä¸¾ä¸ªä¾‹å­ï¼Œæ¯”å¦‚æˆ‘æƒ³è®¿é—® http://www.test.com/readmeï¼Œä½†www.test.comä¸Šå¹¶ä¸å­˜åœ¨readmeé¡µé¢ï¼Œäºæ˜¯ä»–æ˜¯å·å·ä»å¦å¤–ä¸€å°æœåŠ¡å™¨ä¸Šå–å›æ¥ï¼Œç„¶åä½œä¸ºè‡ªå·±çš„å†…å®¹è¿”å›ç”¨æˆ·ï¼Œä½†ç”¨æˆ·å¹¶ä¸çŸ¥æƒ…ã€‚è¿™é‡Œæ‰€æåˆ°çš„ www.test.com è¿™ä¸ªåŸŸåå¯¹åº”çš„æœåŠ¡å™¨å°±è®¾ç½®äº†åå‘ä»£ç†åŠŸèƒ½ã€‚</p>

<p>ç»“è®ºå°±æ˜¯ï¼Œåå‘ä»£ç†æ­£å¥½ç›¸åï¼Œå¯¹äºå®¢æˆ·ç«¯è€Œè¨€å®ƒå°±åƒæ˜¯åŸå§‹æœåŠ¡å™¨ï¼Œå¹¶ä¸”å®¢æˆ·ç«¯ä¸éœ€è¦è¿›è¡Œä»»ä½•ç‰¹åˆ«çš„è®¾ç½®ã€‚å®¢æˆ·ç«¯å‘åå‘ä»£ç†çš„å‘½åç©ºé—´(name-space)ä¸­çš„å†…å®¹å‘é€æ™®é€šè¯·æ±‚ï¼Œæ¥ç€åå‘ä»£ç†å°†åˆ¤æ–­å‘ä½•å¤„(åŸå§‹æœåŠ¡å™¨)è½¬äº¤è¯·æ±‚ï¼Œå¹¶å°†è·å¾—çš„å†…å®¹è¿”å›ç»™å®¢æˆ·ç«¯ï¼Œå°±åƒè¿™äº›å†…å®¹åŸæœ¬å°±æ˜¯å®ƒè‡ªå·±çš„ä¸€æ ·ã€‚</p>

<p><img src="http://walidream.com:9999/blogImage/nginx/nginx_18.png?1234" alt="ssl" /></p>

<h1 id="4nginxæ”¯æŒçš„ä»£ç†åè®®">4.nginxæ”¯æŒçš„ä»£ç†åè®®</h1>

<p>nginxæ”¯æŒéå¸¸å¤šçš„ä»£ç†åè®®ï¼Œæ”¯æŒhttpã€httpsã€websocketã€GRPCã€ICMP/POP/IMAPã€RTMPã€‚httpæ˜¯webæœåŠ¡ä¸­å¸¸ç”¨è¶…æ–‡æœ¬åè®®ï¼Œhttpsæ˜¯å½“å‰ä¸»æµçš„ä¸€ä¸ªåŠ å¯†åè®®ï¼Œwebsocketæ˜¯åœ¨http1.1ç‰ˆæœ¬ä¹‹ä¸Š
å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯å¸¸è¿æ¥é€šä¿¡åè®®ï¼ŒGRPCæ˜¯GOå¼€å‘ä¸­è¿œç¨‹è¿‡ç¨‹è°ƒç”¨åè®®ï¼ŒICMP/POP/IMAPæ˜¯é‚®ä»¶æ”¶å‘åè®®ï¼ŒRTMPæ˜¯åº”ç”¨æµåª’ä½“æœåŠ¡åè®®(ç›´æ’­)ã€‚</p>

<p><img src="http://walidream.com:9999/blogImage/nginx/nginx_19.jpg" alt="ssl" /></p>

<h3 id="å¸¸è§çš„nginxä½œä¸ºåå‘ä»£ç†æ”¯æŒåè®®">å¸¸è§çš„nginxä½œä¸ºåå‘ä»£ç†æ”¯æŒåè®®</h3>

<p><img src="http://walidream.com:9999/blogImage/nginx/nginx_21.jpg" alt="ssl" /></p>

<h3 id="åå‘ä»£ç†æ¨¡å¼ä¸nginxä»£ç†æ¨¡å—">åå‘ä»£ç†æ¨¡å¼ä¸nginxä»£ç†æ¨¡å—</h3>

<p><img src="http://walidream.com:9999/blogImage/nginx/nginx_20.jpg" alt="ssl" /></p>

<h3 id="å¸¸è§çš„nginxä½œä¸ºæ­£å‘ä»£ç†æ”¯æŒåè®®">å¸¸è§çš„nginxä½œä¸ºæ­£å‘ä»£ç†æ”¯æŒåè®®</h3>

<p><img src="http://walidream.com:9999/blogImage/nginx/nginx_22.jpg" alt="ssl" /></p>

<h1 id="5é…ç½®æ¨¡å—">5.é…ç½®æ¨¡å—</h1>

<h3 id="proxy_pass">proxy_pass</h3>

<p>proxy_passé…ç½®é¡¹å±äº<code class="language-plaintext highlighter-rouge">ngx_http_proxy_module</code>æ¨¡å—<a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html" title="http://nginx.org/en/docs/http/ngx_http_proxy_module.html" target="_blank">ä¼ é€é—¨</a></p>

<div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Syntax:</span>	<span class="s">proxy_pass</span> <span class="s">URL</span><span class="p">;</span>
<span class="k">Default:</span> <span class="s">â€”</span>
<span class="s">Context:</span> <span class="s">location,</span> <span class="s">if</span> <span class="s">in</span> <span class="s">location,</span> <span class="s">limit_except</span>
</code></pre></div></div>

<h1 id="6åå‘ä»£ç†é…ç½®">6.åå‘ä»£ç†é…ç½®</h1>

<p>æœåŠ¡ç›®å½•å¦‚ä¸‹</p>
<pre><code class="language-txt">/opt/app  #åº”ç”¨ç›®å½•
   |--code1
     |--index.html
   |--code2
     |--testproxy.html

/etc/nginx/conf.d/ #é…ç½®ç›®å½•
   |
   |--fs_proxy.conf
   |--realserver.conf
</code></pre>

<h4 id="indexhtml">index.html</h4>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!doctype html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
	<span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"UTF-8"</span><span class="nt">&gt;</span>
	<span class="nt">&lt;title&gt;</span>Document<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
	<span class="nt">&lt;h1&gt;</span>ç“¦åŠ›åšå®¢<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<h4 id="testproxyhtml">testproxy.html</h4>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!doctype html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
	<span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"UTF-8"</span><span class="nt">&gt;</span>
	<span class="nt">&lt;title&gt;</span>Document<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
	<span class="nt">&lt;h1&gt;</span>ä»£ç†æµ‹è¯•é¡µé¢<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<h4 id="fs_proxyconf">fs_proxy.conf</h4>

<div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">server</span> <span class="p">{</span>
    <span class="kn">listen</span>       <span class="mi">80</span><span class="p">;</span> 
    <span class="kn">server_name</span>  <span class="s">localhost</span><span class="p">;</span>
 
    <span class="kn">location</span> <span class="n">/</span> <span class="p">{</span> 
        <span class="kn">root</span>   <span class="n">/opt/app/code1</span><span class="p">;</span>
        <span class="kn">index</span>  <span class="s">index.html</span> <span class="s">index.htm</span><span class="p">;</span>
    <span class="p">}</span>      

    <span class="kn">location</span> <span class="p">~</span> <span class="sr">/testproxy.html$</span> <span class="p">{</span>  <span class="c1">#è®¾ç½®ä»£ç†</span>
        <span class="kn">proxy_pass</span> <span class="s">http://127.0.0.1:9000</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="realserverconf">realserver.conf</h4>

<div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">server</span> <span class="p">{</span>
    <span class="kn">listen</span>       <span class="mi">9000</span><span class="p">;</span> 
    <span class="kn">server_name</span>  <span class="s">localhost</span><span class="p">;</span>
 
    <span class="kn">location</span> <span class="n">/</span> <span class="p">{</span> 
        <span class="kn">root</span>   <span class="n">/opt/app/code2</span><span class="p">;</span>
        <span class="kn">index</span>  <span class="s">index.html</span> <span class="s">index.htm</span><span class="p">;</span>
    <span class="p">}</span>      
<span class="p">}</span>
</code></pre></div></div>

<h4 id="æ£€æµ‹é‡å¯nginx">æ£€æµ‹é‡å¯nginx</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nginx -tc /etc/nginx/nginx.conf  #æ£€æµ‹è¯­æ³•

nginx -s reload -c /etc/nginx/nginx.conf #é‡å¯
</code></pre></div></div>

<p>ä¸Šé¢åˆ›å»ºäº†ä¸¤ä¸ªåº”ç”¨åˆ†åˆ«ä¸º<code class="language-plaintext highlighter-rouge">code1</code>å’Œ<code class="language-plaintext highlighter-rouge">code2</code>ã€‚code1åˆ†é…çš„æ˜¯80ç«¯å£ï¼Œcode2åˆ†é…çš„9000ç«¯å£ï¼Œé»˜è®¤80ç«¯å£å¯ä»¥åœ¨å…¬ç½‘è®¿é—®ï¼Œè€Œ9000ç«¯å£ä¸èƒ½
åœ¨å…¬ç½‘ä¸Šè®¿é—®ï¼Œcode1çš„nginxé…ç½®ä¸º<code class="language-plaintext highlighter-rouge">fs_proxy.conf</code>ï¼Œcode2çš„nginxé…ç½®ä¸º<code class="language-plaintext highlighter-rouge">realserver.conf</code>ã€‚é€šè¿‡nginxåå‘ä»£ç†è®¾ç½®æˆ‘ä»¬å°±
å¯ä»¥åœ¨å…¬ç½‘ä¸Šè®¿é—®code2çš„åº”ç”¨ï¼Œè®¿é—®åœ°å€<code class="language-plaintext highlighter-rouge">http://walidream.com/testproxy.html</code>ã€‚é€šè¿‡fs_proxy.confé…ç½®åŒ¹é…<code class="language-plaintext highlighter-rouge">/testproxy.html$</code></p>

<div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">location</span> <span class="p">~</span> <span class="sr">/testproxy.html$</span> <span class="p">{</span>  <span class="c1">#è®¾ç½®ä»£ç†</span>
	<span class="kn">proxy_pass</span> <span class="s">http://127.0.0.1:9000</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p><img src="http://walidream.com:9999/blogImage/nginx/nginx_23.png" alt="ssl" /></p>

<h1 id="7æ­£å‘ä»£ç†é…ç½®">7.æ­£å‘ä»£ç†é…ç½®</h1>

<p>æµ‹è¯•æ­£å‘ä»£ç†éœ€è¦ä¸¤å°æœåŠ¡å™¨ï¼Œå°èœå‘¢åˆšå¥½æœ‰ä¸¤å°æœåŠ¡å™¨å°±æ¥ç©ä¸€ç©ã€‚server1: <code class="language-plaintext highlighter-rouge">www.walidream.com</code>ï¼Œserver2:<code class="language-plaintext highlighter-rouge">www.yagm.xin</code>ã€‚</p>

<h3 id="server1æœåŠ¡ç›®å½•">server1æœåŠ¡ç›®å½•</h3>

<pre><code class="language-txt">/etc/nginx/conf.d/  #é…ç½®
    |
	|--zx_proxy.conf
</code></pre>

<h4 id="zx_proxyconfserver1æœåŠ¡å™¨">zx_proxy.conf(server1æœåŠ¡å™¨)</h4>

<div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">server</span> <span class="p">{</span>
    <span class="kn">listen</span>       <span class="mi">80</span><span class="p">;</span> 
    <span class="kn">server_name</span>  <span class="s">localhost</span><span class="p">;</span>
	
    <span class="kn">resolver</span> <span class="mi">8</span><span class="s">.8.8.8</span><span class="p">;</span>
    <span class="kn">location</span> <span class="n">/</span> <span class="p">{</span> 
        <span class="kn">proxy_set_header</span> <span class="s">X-Forwarded-For</span> <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span> 
        <span class="kn">proxy_pass</span> <span class="s">http://yagm.xin</span><span class="p">;</span>
    <span class="p">}</span>      
<span class="p">}</span>
</code></pre></div></div>

<p>è¿™é‡Œé¢éœ€è¦æ³¨æ„çš„æ˜¯<code class="language-plaintext highlighter-rouge">resolver</code>dnsè§£æï¼Œå› ä¸ºæ­£å‘ä»£ç†çš„dnsè§£æåœ¨ä»£ç†ä¸Šé¢ã€‚</p>

<h3 id="server2æœåŠ¡ç›®å½•">server2æœåŠ¡ç›®å½•</h3>

<pre><code class="language-txt">/home/app #åº”ç”¨
    |
	|--index.html
	
/etc/nginx/conf.d/  #é…ç½®
    |
	|--admin.conf
</code></pre>

<h4 id="indexhtmlserver2æœåŠ¡å™¨">index.html(server2æœåŠ¡å™¨)</h4>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!doctype html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
	<span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"UTF-8"</span><span class="nt">&gt;</span>
	<span class="nt">&lt;title&gt;</span>Document<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
	<span class="nt">&lt;h1&gt;</span>æ´‹æ´‹çš„ä¸€ç±³é˜³å…‰<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<h4 id="adminconfserver2æœåŠ¡å™¨">admin.conf(server2æœåŠ¡å™¨)</h4>

<div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">server</span> <span class="p">{</span>
    <span class="kn">listen</span>       <span class="mi">80</span><span class="p">;</span> 
    <span class="kn">server_name</span>  <span class="s">localhost</span><span class="p">;</span>
	
    <span class="kn">location</span> <span class="n">/</span> <span class="p">{</span> 
        <span class="kn">if</span> <span class="s">(</span> <span class="nv">$http_x_forwarded_for</span> <span class="s">!~*</span> <span class="s">"^99</span><span class="err">\</span><span class="s">.99</span><span class="err">\</span><span class="s">.99</span><span class="err">\</span><span class="s">.99"</span> <span class="s">)</span> <span class="p">{</span> 
            <span class="kn">return</span> <span class="mi">403</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="kn">root</span>   <span class="n">/home/app</span><span class="p">;</span>
        <span class="kn">index</span>  <span class="s">index.html</span> <span class="s">index.htm</span><span class="p">;</span>
    <span class="p">}</span>      
<span class="p">}</span>
</code></pre></div></div>

<h4 id="æ£€æµ‹é‡å¯nginx-1">æ£€æµ‹é‡å¯nginx</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nginx -tc /etc/nginx/nginx.conf  #æ£€æµ‹è¯­æ³•

nginx -s reload -c /etc/nginx/nginx.conf #é‡å¯
</code></pre></div></div>

<p>ä¸Šé¢ä¸¤ä¸ªåº”ç”¨åˆ†åˆ«åœ¨ä¸¤ä¸ªæœåŠ¡å™¨ä¸Šï¼Œserver1: <code class="language-plaintext highlighter-rouge">www.walidream.com</code>ï¼Œserver2:<code class="language-plaintext highlighter-rouge">www.yagm.xin</code>ã€‚server2æœåŠ¡å™¨åªå…è®¸server1æœåŠ¡å™¨æ¥è®¿é—®ï¼Œå…¶ä»–è®¿é—®æ‹’ç»ã€‚é€šè¿‡åœ¨server1
æœåŠ¡å™¨ä¸Šé…ç½®nginxçš„æ­£å‘ä»£ç†æ¥è®¿é—®server2ä¸Šé¢çš„æœåŠ¡</p>

<p><img src="http://walidream.com:9999/blogImage/nginx/nginx_24.png" alt="ssl" /></p>

<blockquote>
  <p>ç‰¹åˆ«æ³¨æ„</p>
</blockquote>

<p>ä¸Šé¢é…ç½®è¯­æ³•ä¸­çš„IP<code class="language-plaintext highlighter-rouge">99.99.99.99</code>ä¸æ˜¯server2æœåŠ¡å™¨çš„å…¬ç½‘ipã€‚å°èœç”¨çš„æœåŠ¡å™¨æ˜¯é˜¿é‡Œäº‘çš„æœåŠ¡å™¨ï¼Œä½†æ˜¯è¿™ä¸ªé‡Œé¢<code class="language-plaintext highlighter-rouge">$http_x_forwarded_for</code>æ˜¯ä»£ç†åšè½¬å‘çš„ipã€‚ç¬¬ä¸€æ¬¡å¡«å†™æˆ
é˜¿é‡Œäº‘æœåŠ¡å™¨çš„å…¬ç½‘IPè¿”å›æ€»æ˜¯403ã€‚åé¢æŸ¥çœ‹æ—¥å¿—æ—¶ï¼Œå‘ç°æ—¥å¿—ä¸­æ‰“å°çš„<code class="language-plaintext highlighter-rouge">http_x_forwarded_for</code>çš„IPå€¼å’Œå¡«å†™çš„é˜¿é‡Œäº‘å…¬ç½‘IPä¸ä¸€æ ·ï¼Œå°èœå‘¢çŒœæƒ³ï¼Œè™½ç„¶ç”¨é˜¿é‡Œäº‘ç»™çš„å…¬ç½‘IP
èƒ½å¤Ÿè®¿é—®çš„åˆ°é˜¿é‡Œäº‘æœåŠ¡å™¨ã€‚ä½†æ˜¯ä¸èƒ½ä¿è¯é˜¿é‡Œäº‘æ²¡æœ‰ç»™è‡ªå·±çš„æœåŠ¡å™¨åšä»£ç†ã€‚å°èœå°†<code class="language-plaintext highlighter-rouge">99.99.99.99</code>æ¢æˆäº†æ—¥å¿—ä¸­çš„<code class="language-plaintext highlighter-rouge">$http_x_forwarded_for</code>çš„å€¼ï¼Œç„¶åå°±okäº†ã€‚</p>

<p>è®¿é—®http://www.walidream.comå°±å¯ä»¥çœ‹åˆ°http://www.yagm.xinæœåŠ¡å™¨ä¸Šçš„å†…å®¹</p>

<p><img src="http://walidream.com:9999/blogImage/nginx/nginx_25.jpg" alt="ssl" /></p>

<h1 id="8æ·»åŠ ä»£ç†å¸¸ç”¨é…ç½®é¡¹">8.æ·»åŠ ä»£ç†å¸¸ç”¨é…ç½®é¡¹</h1>

<p>ä¸‹é¢ä»‹ç»çš„é…ç½®é¡¹éƒ½å±äº<code class="language-plaintext highlighter-rouge">ngx_http_proxy_module</code>æ¨¡å—<a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html" title="http://nginx.org/en/docs/http/ngx_http_proxy_module.html" target="_blank">ä¼ é€é—¨</a></p>

<h3 id="1proxy_redirect">1.proxy_redirect</h3>

<div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Syntax:</span>	<span class="s">proxy_redirect</span> <span class="s">default</span><span class="p">;</span>
	<span class="k">proxy_redirect</span> <span class="no">off</span><span class="p">;</span>
	<span class="k">proxy_redirect</span> <span class="s">redirect</span> <span class="s">replacement</span><span class="p">;</span>
<span class="k">Default:</span> <span class="s">proxy_redirect</span> <span class="s">default</span><span class="p">;</span>
<span class="k">Context:</span> <span class="s">http,</span> <span class="s">server,</span> <span class="s">location</span>
</code></pre></div></div>

<h3 id="2proxy_set_header">2.proxy_set_header</h3>

<div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Syntax:</span> <span class="s">proxy_set_header</span> <span class="s">field</span> <span class="s">value</span><span class="p">;</span>
<span class="k">Default:proxy_set_header</span> <span class="s">Host</span> <span class="nv">$proxy_host</span><span class="p">;</span>
	<span class="k">proxy_set_header</span> <span class="s">Connection</span> <span class="s">close</span><span class="p">;</span>
<span class="k">Context:</span> <span class="s">http,</span> <span class="s">server,</span> <span class="s">location</span>
</code></pre></div></div>

<h3 id="3proxy_connect_timeout">3.proxy_connect_timeout</h3>

<div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Syntax:</span>	<span class="s">proxy_connect_timeout</span> <span class="s">time</span><span class="p">;</span>
<span class="k">Default:</span> <span class="s">proxy_connect_timeout</span> <span class="s">60s</span><span class="p">;</span>
<span class="k">Context:</span> <span class="s">http,</span> <span class="s">server,</span> <span class="s">location</span>
</code></pre></div></div>

<h3 id="4proxy_send_timeout">4.proxy_send_timeout</h3>

<div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Syntax:</span>	<span class="s">proxy_send_timeout</span> <span class="s">time</span><span class="p">;</span>
<span class="k">Default:</span> <span class="s">proxy_send_timeout</span> <span class="s">60s</span><span class="p">;</span>
<span class="k">Context:</span> <span class="s">http,</span> <span class="s">server,</span> <span class="s">location</span>
</code></pre></div></div>

<h3 id="5proxy_read_timeout">5.proxy_read_timeout</h3>

<div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Syntax:</span>	<span class="s">proxy_read_timeout</span> <span class="s">time</span><span class="p">;</span>
<span class="k">Default:</span> <span class="s">proxy_read_timeout</span> <span class="s">60s</span><span class="p">;</span>
<span class="k">Context:</span> <span class="s">http,</span> <span class="s">server,</span> <span class="s">location</span>
</code></pre></div></div>

<h3 id="6proxy_buffer_size">6.proxy_buffer_size</h3>

<div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Syntax:</span>	<span class="s">proxy_buffer_size</span> <span class="s">size</span><span class="p">;</span>
<span class="k">Default:</span> <span class="s">proxy_buffer_size</span> <span class="mi">4k</span><span class="s">|8k</span><span class="p">;</span>
<span class="k">Context:</span> <span class="s">http,</span> <span class="s">server,</span> <span class="s">location</span>
</code></pre></div></div>

<h3 id="7proxy_buffering">7.proxy_buffering</h3>

<div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Syntax:</span>	<span class="s">proxy_buffering</span> <span class="no">on</span> <span class="s">|</span> <span class="no">off</span><span class="p">;</span>
<span class="k">Default:</span> <span class="s">proxy_buffering</span> <span class="no">on</span><span class="p">;</span>
<span class="k">Context:</span> <span class="s">http,</span> <span class="s">server,</span> <span class="s">location</span>
</code></pre></div></div>

<h3 id="8proxy_buffers">8.proxy_buffers</h3>

<div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Syntax:</span>	<span class="s">proxy_buffers</span> <span class="s">number</span> <span class="s">size</span><span class="p">;</span>
<span class="k">Default:</span> <span class="s">proxy_buffers</span> <span class="mi">8</span> <span class="mi">4k</span><span class="s">|8k</span><span class="p">;</span>
<span class="k">Context:</span> <span class="s">http,</span> <span class="s">server,</span> <span class="s">location</span>
</code></pre></div></div>

<h3 id="9proxy_busy_buffers_size">9.proxy_busy_buffers_size</h3>

<div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Syntax:</span>	<span class="s">proxy_busy_buffers_size</span> <span class="s">size</span><span class="p">;</span>
<span class="k">Default:</span> <span class="s">proxy_busy_buffers_size</span> <span class="mi">8k</span><span class="s">|16k</span><span class="p">;</span>
<span class="k">Context:</span> <span class="s">http,</span> <span class="s">server,</span> <span class="s">location</span>
</code></pre></div></div>

<h3 id="10proxy_max_temp_file_size">10.proxy_max_temp_file_size</h3>

<div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Syntax:</span>	<span class="s">proxy_max_temp_file_size</span> <span class="s">size</span><span class="p">;</span>
<span class="k">Default:</span> <span class="s">proxy_max_temp_file_size</span> <span class="mi">1024m</span><span class="p">;</span>
<span class="k">Context:</span> <span class="s">http,</span> <span class="s">server,</span> <span class="s">location</span>
</code></pre></div></div>

<p>ä¸Šé¢çš„é…ç½®é¡¹éƒ½æ˜¯åœ¨è®¾ç½®ä»£ç†æ—¶å¸¸ç”¨åˆ°çš„é…ç½®ï¼Œå°èœå»ºè®®å°†å¸¸ç”¨çš„é…ç½®æ”¾åœ¨ä¸€ä¸ªæ–‡ä»¶é‡Œã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vim /etc/nginx/proxy_pass
</code></pre></div></div>

<p>åˆ›å»ºå¥½proxy_passæ–‡ä»¶ä¹‹åï¼Œå°†ä¸‹é¢å†…å®¹æ‹·è´è¿›å»ã€‚</p>

<div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#proxy_pass ä»£ç†å¸¸ç”¨é…ç½®</span>

<span class="k">proxy_redirect</span> <span class="s">default</span><span class="p">;</span>

<span class="k">proxy_set_header</span> <span class="s">Host</span> <span class="nv">$http_host</span><span class="p">;</span>
<span class="k">proxy_set_header</span> <span class="s">X-Real-IP</span> <span class="nv">$remote_addr</span><span class="p">;</span>

<span class="k">proxy_connect_timeout</span> <span class="mi">30</span><span class="p">;</span>
<span class="k">proxy_send_timeout</span> <span class="mi">60</span><span class="p">;</span>
<span class="k">proxy_read_timeout</span> <span class="mi">60</span><span class="p">;</span>

<span class="k">proxy_buffer_size</span> <span class="mi">32k</span><span class="p">;</span>
<span class="k">proxy_buffering</span> <span class="no">on</span><span class="p">;</span>
<span class="k">proxy_buffers</span> <span class="mi">4</span> <span class="mi">128k</span><span class="p">;</span>
<span class="k">proxy_busy_buffers_size</span> <span class="mi">256k</span><span class="p">;</span>
<span class="k">proxy_max_temp_file_size</span> <span class="mi">256k</span><span class="p">;</span>
</code></pre></div></div>

<p>åœ¨é…ç½®ä»£ç†æ—¶ï¼Œåªéœ€è¦å°†æ–‡ä»¶å†…å®¹å¯¼å…¥nginxé…ç½®å°±æˆäº†ã€‚</p>

<div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">location</span> <span class="n">/</span> <span class="p">{</span>
	<span class="kn">proxy_pass</span> <span class="s">http://127.0.0.1:8080</span><span class="p">;</span>
	<span class="kn">include</span> <span class="s">proxy_params</span><span class="p">;</span>  <span class="c1">#å°†é…ç½®æ–‡ä»¶å¯¼å…¥</span>
<span class="p">}</span>
</code></pre></div></div>

:ET