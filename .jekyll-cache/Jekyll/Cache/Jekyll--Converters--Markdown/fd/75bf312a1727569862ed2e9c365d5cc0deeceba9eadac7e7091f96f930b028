I"/<p>luaæ˜¯ä¸€ä¸ªç®€æ´ã€è½»é‡ã€å¯æ‰©å±•çš„è„šæœ¬è¯­è¨€ã€‚nginx+luaå¼€å‘å……åˆ†çš„ç»“åˆNginxçš„å¹¶å‘å¤„ç†epollä¼˜åŠ¿å’Œluaçš„è½»é‡å®ç°ç®€å•çš„åŠŸèƒ½åˆ‡é«˜å¹¶å‘çš„åœºæ™¯ã€‚</p>

<h1 id="1å®‰è£…lua">1.å®‰è£…lua</h1>

<p>å¦‚æœæ˜¯centos7ç‰ˆæœ¬ä¹‹ä¸Šä¼šè‡ªå¸¦luaï¼Œç‰ˆæœ¬5.1.4ã€‚luaæ²¡æœ‰å®‰è£…</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yum install lua
</code></pre></div></div>

<h1 id="2å®‰è£…luajit">2.å®‰è£…LuaJIT</h1>

<p>å®‰è£…LuaJITç¯å¢ƒï¼Œæ¯”è‡ªå¸¦çš„luaè§£æå™¨æ‰©å±•æ¨¡å—å¤šå¹¶ä¸”é«˜æ•ˆã€‚</p>

<pre><code class="language-linux">cd /opt/download
wget http://luajit.org/download/LuaJIT-2.0.2.tar.gz
tar -zxvf LuaJIT-2.0.2.tar.gz
cd LuaJIT-2.0.2
make install  PREFIX=/usr/local/LuaJIT
export LUAJIT_LIB=/usr/local/LuaJIT/lib
export LUAJIT_INC=/usr/local/LuaJIT/include/luajit-2.0
</code></pre>

<h4 id="åŠ è½½luaåº“åŠ å…¥åˆ°ldsoconfæ–‡ä»¶">åŠ è½½luaåº“ï¼ŒåŠ å…¥åˆ°ld.so.confæ–‡ä»¶</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>echo "/usr/local/LuaJIT/lib" &gt;&gt; /etc/ld.so.conf
ldconfig
</code></pre></div></div>

<h1 id="3ä¸‹è½½ngx_devel_kitå’Œlua-nginx-module">3.ä¸‹è½½ngx_devel_kitå’Œlua-nginx-module</h1>

<pre><code class="language-linux">cd /opt/download
wget https://github.com/simpl/ngx_devel_kit/archive/v0.3.0.tar.gz
tar -zxvf v0.3.0.tar.gz

wget https://github.com/openresty/lua-nginx-module/archive/v0.10.9rc7.tar.gz
tar -zxvf v0.10.9rc7.tar.gz
</code></pre>

<h1 id="4nginxç¼–è¯‘æ¨¡å—">4.nginxç¼–è¯‘æ¨¡å—</h1>

<p>å°†ngx_devel_kitæ¨¡å—å’Œlua-nginx-moduleæ¨¡å—ç¼–è¯‘è¿›nginx</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd /opt/download/nginx-1.14.2
nginx -V
</code></pre></div></div>

<p>è¾“å‡º</p>

<p><code class="language-plaintext highlighter-rouge">--prefix=/etc/nginx --sbin-path=/usr/sbin/nginx --modules-path=/usr/lib64/nginx/modules --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/log/nginx/error.log --http-log-path=/var/log/nginx/access.log --pid-path=/var/run/nginx.pid --lock-path=/var/run/nginx.lock --http-client-body-temp-path=/var/cache/nginx/client_temp --http-proxy-temp-path=/var/cache/nginx/proxy_temp --http-fastcgi-temp-path=/var/cache/nginx/fastcgi_temp --http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp --http-scgi-temp-path=/var/cache/nginx/scgi_temp --user=nginx --group=nginx --with-compat --with-file-aio --with-threads --with-http_addition_module --with-http_auth_request_module --with-http_dav_module --with-http_flv_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_mp4_module --with-http_random_index_module --with-http_realip_module --with-http_secure_link_module --with-http_slice_module --with-http_ssl_module --with-http_stub_status_module --with-http_sub_module --with-http_v2_module --with-mail --with-mail_ssl_module --with-stream --with-stream_realip_module --with-stream_ssl_module --with-stream_ssl_preread_module --with-cc-opt='-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -m64 -mtune=generic -fPIC' --with-ld-opt='-Wl,-z,relro -Wl,-z,now -pie' --add-module=/opt/download/echo-nginx-module-0.61 --with-http_geoip_module</code></p>

<h4 id="æ·»åŠ ngx_devel_kitæ¨¡å—å’Œlua-nginx-moduleæ¨¡å—æ·»åŠ åˆ°ç¼–è¯‘å‚æ•°">æ·»åŠ ngx_devel_kitæ¨¡å—å’Œlua-nginx-moduleæ¨¡å—æ·»åŠ åˆ°ç¼–è¯‘å‚æ•°</h4>

<p><code class="language-plaintext highlighter-rouge">--prefix=/etc/nginx --sbin-path=/usr/sbin/nginx --modules-path=/usr/lib64/nginx/modules --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/log/nginx/error.log --http-log-path=/var/log/nginx/access.log --pid-path=/var/run/nginx.pid --lock-path=/var/run/nginx.lock --http-client-body-temp-path=/var/cache/nginx/client_temp --http-proxy-temp-path=/var/cache/nginx/proxy_temp --http-fastcgi-temp-path=/var/cache/nginx/fastcgi_temp --http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp --http-scgi-temp-path=/var/cache/nginx/scgi_temp --user=nginx --group=nginx --with-compat --with-file-aio --with-threads --with-http_addition_module --with-http_auth_request_module --with-http_dav_module --with-http_flv_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_mp4_module --with-http_random_index_module --with-http_realip_module --with-http_secure_link_module --with-http_slice_module --with-http_ssl_module --with-http_stub_status_module --with-http_sub_module --with-http_v2_module --with-mail --with-mail_ssl_module --with-stream --with-stream_realip_module --with-stream_ssl_module --with-stream_ssl_preread_module --with-cc-opt='-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -m64 -mtune=generic -fPIC' --with-ld-opt='-Wl,-z,relro -Wl,-z,now -pie' --add-module=/opt/download/echo-nginx-module-0.61 --with-http_geoip_module --add-module=/opt/download/lua-nginx-module-0.10.9rc7 --add-module=/opt/download/ngx_devel_kit-0.3.0</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./configure ç¼–è¯‘å‚æ•°
make &amp;&amp; make install
</code></pre></div></div>

<h1 id="5nginxè°ƒç”¨luaæ¨¡å—æŒ‡ä»¤">5.nginxè°ƒç”¨luaæ¨¡å—æŒ‡ä»¤</h1>

<p>nginxçš„å¯æ’æ‹”æ¨¡å—åŒ–åŠ è½½æ‰§è¡Œï¼Œå…±11ä¸ªå¤„ç†é˜¶æ®µ</p>

<table>
  <thead>
    <tr>
      <th>å‚æ•°</th>
      <th>æè¿°</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>set_by_lua<br />set_by_lua_file</td>
      <td>è®¾ç½®nginxå˜é‡ï¼Œå¯ä»¥å®ç°å¤æ‚çš„å¤æ‚é€»è¾‘</td>
    </tr>
    <tr>
      <td>access_by_lua<br />access_by_lua_file</td>
      <td>è¯·æ±‚è®¿é—®é˜¶æ®µå¤„ç†ï¼Œç”¨äºè®¿é—®æ§åˆ¶</td>
    </tr>
    <tr>
      <td>content_by_lua<br />content_by_lua_file</td>
      <td>å†…å®¹å¤„ç†å®¹å™¨ï¼Œä»‹ç»è¯·æ±‚å¤„ç†å¹¶è¾“å‡ºå“åº”</td>
    </tr>
  </tbody>
</table>

<h1 id="6nginxè°ƒç”¨luaçš„api">6.nginxè°ƒç”¨luaçš„api</h1>

<table>
  <thead>
    <tr>
      <th>api</th>
      <th>æè¿°</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>ngx.var</td>
      <td>nginxå˜é‡</td>
    </tr>
    <tr>
      <td>ngx.req.get_headers</td>
      <td>è·å–è¯·æ±‚å¤´</td>
    </tr>
    <tr>
      <td>ngx.req.get_uri_args</td>
      <td>è·å–urlè¯·æ±‚å‚æ•°</td>
    </tr>
    <tr>
      <td>ngx.redirect</td>
      <td>é‡å®šå‘</td>
    </tr>
    <tr>
      <td>ngx.print</td>
      <td>è¾“å‡ºå“åº”å†…å®¹ä½“</td>
    </tr>
    <tr>
      <td>ngx.say</td>
      <td>é€šngx.print,ä½†æ˜¯æœ€åä¼šè¾“å‡ºä¸€ä¸ªæ¢è¡Œç¬¦</td>
    </tr>
    <tr>
      <td>ngx.header</td>
      <td>è¾“å‡ºå“åº”å¤´</td>
    </tr>
    <tr>
      <td>â€¦</td>
      <td>Â </td>
    </tr>
  </tbody>
</table>

<h1 id="7ç°åº¦å‘å¸ƒ">7.ç°åº¦å‘å¸ƒ</h1>

<p>æŒ‰ç…§ä¸€å®šçš„å…³ç³»åŒºåˆ«ï¼Œåˆ†éƒ¨åˆ†çš„ä»£ç è¿›è¡Œä¸Šçº¿ï¼Œä½¿ä»£ç çš„å‘å¸ƒèƒ½å¹³æ»‘è¿‡æ¸¡ä¸Šçº¿ã€‚</p>

<h4 id="æœªå®Œæˆå¾…ç»­">æœªå®Œæˆå¾…ç»­</h4>

:ET