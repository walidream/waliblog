I"á$<p>nginxä¸­çš„<code class="language-plaintext highlighter-rouge">ngx_http_proxy_module</code>å’Œ<code class="language-plaintext highlighter-rouge">ngx_http_fastcgi_module</code>éƒ½å¯ä»¥å®ç°åå‘ä»£ç†ã€‚ngx_http_proxy_moduleæ˜¯é€šç”¨httpåè®®åå‘ä»£ç†ï¼Œngx_http_fastcgi_moduleæ˜¯æŒ‰
fastcgiæ¥å£åè®®çš„åå‘ä»£ç†ã€‚</p>

<table>
  <thead>
    <tr>
      <th>ngx_http_proxy_module</th>
      <th>ngx_http_fastcgi_module</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>proxy_pass</td>
      <td>fastcgi_pass</td>
    </tr>
    <tr>
      <td>proxy_busy_buffers_size</td>
      <td>fastcgi_busy_buffers_size</td>
    </tr>
    <tr>
      <td>proxy_buffer_size</td>
      <td>fastcgi_buffer_size</td>
    </tr>
  </tbody>
</table>

<h1 id="1fastcgiç¼“å­˜å›¾è§£">1.Fastcgiç¼“å­˜å›¾è§£</h1>

<p><img src="http://walidream.com:9999/blogImage/nginx/nginx_40.jpg" alt="ssl" /></p>

<h1 id="2é…ç½®æ¨¡å—">2.é…ç½®æ¨¡å—</h1>

<p>fastcgiç¼“å­˜é…ç½®å’Œproxy_cacheè¯­æ³•ï¼Œé…ç½®éƒ½å·®ä¸å¤šã€‚</p>

<h3 id="fastcgi_cache_path">fastcgi_cache_path</h3>

<div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Syntax:</span>	<span class="s">fastcgi_cache_path</span> <span class="s">path</span> <span class="s">[levels=levels]</span> <span class="s">[use_temp_path=on|off]</span> <span class="s">keys_zone=name:size</span> <span class="s">[inactive=time]</span> <span class="s">[max_size=size]</span> <span class="s">[manager_files=number]</span> <span class="s">[manager_sleep=time]</span> <span class="s">[manager_threshold=time]</span> <span class="s">[loader_files=number]</span> <span class="s">[loader_sleep=time]</span> <span class="s">[loader_threshold=time]</span> <span class="s">[purger=on|off]</span> <span class="s">[purger_files=number]</span> <span class="s">[purger_sleep=time]</span> <span class="s">[purger_threshold=time]</span><span class="p">;</span>
<span class="k">Default:</span> <span class="s">â€”</span>
<span class="s">Context:</span> <span class="s">http</span>
</code></pre></div></div>

<h3 id="fastcgi_cache_key">fastcgi_cache_key</h3>

<p>è®°å½•ç¼“å­˜çš„ç»´åº¦ï¼Œç»´åº¦è¶Šç»†ï¼Œç¼“å­˜è¶Šè¯¦ç»†</p>

<div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Syntax:</span>	<span class="s">fastcgi_cache_key</span> <span class="s">string</span><span class="p">;</span>
<span class="k">Default:</span> <span class="s">â€”</span>
<span class="s">Context:</span> <span class="s">http,</span> <span class="s">server,</span> <span class="s">location</span>
</code></pre></div></div>

<h3 id="fastcgi_cache">fastcgi_cache</h3>

<div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Syntax:</span>	<span class="s">fastcgi_cache</span> <span class="s">zone</span> <span class="s">|</span> <span class="no">off</span><span class="p">;</span>
<span class="k">Default:</span> <span class="s">fastcgi_cache</span> <span class="no">off</span><span class="p">;</span>
<span class="k">Context:</span> <span class="s">http,</span> <span class="s">server,</span> <span class="s">location</span>
</code></pre></div></div>

<h3 id="fastcgi_cache_valid">fastcgi_cache_valid</h3>

<div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Syntax:</span>	<span class="s">fastcgi_cache_valid</span> <span class="s">[code</span> <span class="s">...]</span> <span class="s">time</span><span class="p">;</span>
<span class="k">Default:</span> <span class="s">â€”</span>
<span class="s">Context:</span> <span class="s">http,</span> <span class="s">server,</span> <span class="s">location</span>
</code></pre></div></div>

<h1 id="3fastcgiç¼“å­˜é…ç½®">3.fastcgiç¼“å­˜é…ç½®</h1>

<p>æœåŠ¡ç›®å½•</p>

<pre><code class="language-txt">/opt/app/code6
|--index.php
|--time.php

/etc/nginx/conf.d
|--fastcgi_cache.conf
</code></pre>

<h4 id="indexphp">index.php</h4>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
	<span class="k">echo</span> <span class="s2">"ç“¦åŠ›åšå®¢"</span><span class="p">;</span>
</code></pre></div></div>

<h4 id="timephp">time.php</h4>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
	<span class="k">echo</span> <span class="nb">date</span><span class="p">(</span><span class="s1">'Y-m-d H:m:s'</span><span class="p">);</span>
</code></pre></div></div>

<h4 id="fastcgi_cacheconf">fastcgi_cache.conf</h4>

<div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">fastcgi_cache_path</span> <span class="n">/opt/app/fastcache</span> <span class="s">levels=1:2</span> <span class="s">keys_zone=wali:100m</span> <span class="s">max_size=1g</span> <span class="s">inactive=60m</span><span class="p">;</span>

<span class="k">server</span> <span class="p">{</span>
    <span class="kn">listen</span>       <span class="mi">80</span><span class="p">;</span> 
    <span class="kn">server_name</span>  <span class="s">localhost</span><span class="p">;</span>

    <span class="c1">#charset koi8-r;</span>
    <span class="kn">access_log</span>  <span class="n">/var/log/nginx/host.access.log</span>  <span class="s">main</span><span class="p">;</span>
    
    <span class="kn">location</span> <span class="n">/</span> <span class="p">{</span> 
        <span class="kn">root</span> <span class="n">/opt/app/code6</span><span class="p">;</span>
        <span class="kn">try_files</span> <span class="nv">$uri</span> <span class="nv">$uri</span><span class="n">/</span> <span class="n">/index.php?</span><span class="nv">$args</span><span class="p">;</span>
        <span class="kn">index</span>  <span class="s">index.php</span><span class="p">;</span>
    <span class="p">}</span>   

    <span class="kn">location</span> <span class="p">~</span> <span class="sr">\.php$</span> <span class="p">{</span>
        <span class="kn">root</span> <span class="n">/opt/app/code6</span><span class="p">;</span>
        <span class="kn">fastcgi_pass</span> <span class="nf">127.0.0.1</span><span class="p">:</span><span class="mi">9000</span><span class="p">;</span>
        <span class="kn">fastcgi_index</span> <span class="s">index.php</span><span class="p">;</span>
        <span class="kn">include</span> <span class="s">fastcgi_params</span><span class="p">;</span>
        <span class="kn">fastcgi_param</span> <span class="s">SCRIPT_FILENAME</span> <span class="nv">$document_root$fastcgi_script_name</span><span class="p">;</span>
    
        <span class="kn">fastcgi_cache_key</span> <span class="nv">$scheme$request_method$host$request_uri$is_args$args</span><span class="p">;</span>
        <span class="kn">fastcgi_cache</span> <span class="s">wali</span><span class="p">;</span>
        <span class="kn">fastcgi_cache_valid</span> <span class="mi">200</span> <span class="mi">60m</span><span class="p">;</span>
    
        <span class="kn">add_header</span> <span class="s">X-Cache-Source</span> <span class="nv">$upstream_cache_status</span><span class="p">;</span>
    <span class="p">}</span>   
<span class="p">}</span>
</code></pre></div></div>

<p>æ£€æµ‹è¯­æ³•å¹¶é‡å¯</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nginx -tc /etc/nginx/nginx.conf
nginx -s reload -c /etc/nginx/nginx.conf
</code></pre></div></div>

<p>è®¿é—®ä½ çš„åŸŸåhttp://walidream.com/time.phpï¼ŒæŒ‰f5åˆ·æ–°ï¼Œæ‰“å¼€æ§åˆ¶å°å¦‚æœçœ‹åˆ°<code class="language-plaintext highlighter-rouge">X-Cache-Source:HIT</code>å°±è¯´æ˜é…ç½®å¥½äº†ã€‚</p>

<p><img src="http://walidream.com:9999/blogImage/nginx/nginx_41.jpg" alt="ssl" /></p>

<h1 id="4åç«¯æœåŠ¡æ·»åŠ no-cacheå¤´å¯¹äºnginxä»£ç†ç¼“å­˜çš„å½±å“">4.åç«¯æœåŠ¡æ·»åŠ no-cacheå¤´å¯¹äºNginxä»£ç†ç¼“å­˜çš„å½±å“</h1>

<p>åç«¯æœåŠ¡æ·»åŠ no-cacheå¤´å¯¹äºNginxä»£ç†ç¼“å­˜çš„å½±å“</p>

<p><img src="http://walidream.com:9999/blogImage/nginx/nginx_42.jpg" alt="ssl" /></p>

<p>å¦‚æœåå°æœåŠ¡å™¨åœ¨headå¤´ä¿¡æ¯æ·»åŠ no-chcheï¼Œé‚£ä¹ˆnginxå°±ä¸ä¼šç¼“å­˜ã€‚å¦‚æœè¿™ç§æƒ…å†µä¸‹è¿˜éœ€è¦nginxåšç¼“å­˜</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fastcgi_ignore_headers Cache-Control Expires Set-Cookie; #å¿½ç•¥å¤´ä¿¡æ¯
</code></pre></div></div>

<h1 id="5è®¾ç½®ç¼“å­˜ç»´åº¦ä¼šå¸¦æ¥å“ªäº›å½±å“">5.è®¾ç½®ç¼“å­˜ç»´åº¦ä¼šå¸¦æ¥å“ªäº›å½±å“</h1>

<p>fastcgi_cache_keyè®¾ç½®ä¸åŒç»´åº¦çš„keyä¼šäº§ç”Ÿå“ªäº›ä¸åŒçš„çŠ¶å†µ</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fastcgi_cache_key $scheme$request_method$host$request_uri$is_args$args;
fastcgi_cache_key  $scheme$host;
</code></pre></div></div>

<p>ç¬¬ä¸€ä¸ªkeyæ¯”ç¬¬äºŒä¸ªå¯ä»¥è®¾ç½®çš„è¯¦æƒ…ï¼Œç¬¬äºŒä¸ªkeyåªè®¾ç½®<code class="language-plaintext highlighter-rouge">åè®®</code>+<code class="language-plaintext highlighter-rouge">åŸŸå</code>ã€‚å‡å¦‚è®¿é—®http://walidream.com/tiem.php é¡µé¢è¢«ç¼“å­˜äº†ä¹‹åï¼Œç„¶ååœ¨è®¿é—®http://walidream.com/index.phpçš„æ—¶å€™
å°±ä¼šå‘ç°é¡µé¢æ²¡æœ‰åˆ·æ–°ï¼ŒåŸå› å°±æ˜¯ç¬¬äºŒä¸ªkeyè®¾ç½®çš„ç»´åº¦åªæœ‰åè®®å’ŒåŸŸåå¯¼è‡´ä¸Šé¢ä¸¤ä¸ªé“¾æ¥è¢«è®¤ä¸ºæ˜¯åŒä¸€ä¸ªç¼“å­˜ï¼Œæ‰€ä»¥è®¿é—®ç¬¬äºŒä¸ªé“¾æ¥æ—¶é¡µé¢æ²¡æœ‰è¢«åˆ·æ–°ã€‚</p>

:ET