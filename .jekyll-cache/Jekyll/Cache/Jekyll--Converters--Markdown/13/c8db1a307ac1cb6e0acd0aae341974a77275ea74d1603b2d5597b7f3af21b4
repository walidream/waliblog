I"ş!<p>ngx_http_secure_link_moduleæ¨¡å—ç”¨äºæ£€æŸ¥è¯·æ±‚é“¾æ¥çš„çœŸä¼ªï¼Œä¿æŠ¤èµ„æºå…å—æœªç»æˆæƒçš„è®¿é—®ï¼Œé™åˆ¶é“¾æ¥çš„ç”Ÿå‘½å‘¨æœŸã€‚</p>

<p>é€šè¿‡å°†è¯·æ±‚ä¸­ä¼ é€’çš„æ ¡éªŒå’Œå€¼ä¸è¯·æ±‚è®¡ç®—çš„å€¼è¿›è¡Œæ¯”è¾ƒæ¥éªŒè¯è¯·æ±‚é“¾æ¥çš„çœŸå®æ€§ã€‚å¦‚æœé“¾æ¥çš„ç”Ÿå‘½å‘¨æœŸæœ‰é™å¹¶ä¸”æ—¶é—´å·²è¿‡ï¼Œåˆ™è¯¥é“¾æ¥å°†è¢«è§†ä¸ºè¿‡æ—¶ã€‚</p>

<p>è¯¥æ¨¡å—æä¾›ä¸¤ç§å¤‡é€‰æ“ä½œæ¨¡å¼ã€‚ç¬¬ä¸€ç§æ¨¡å¼<code class="language-plaintext highlighter-rouge">secure_link_secret</code>æŒ‡ä»¤å¯ç”¨ï¼Œç”¨äºæ£€æŸ¥è¯·æ±‚é“¾æ¥çš„çœŸå®æ€§ä»¥åŠä¿æŠ¤èµ„æºå…å—æœªç»æˆæƒçš„è®¿é—®ã€‚ç¬¬äºŒç§æ¨¡å¼<code class="language-plaintext highlighter-rouge">secure_link</code>å’Œ<code class="language-plaintext highlighter-rouge">secure_link_md5</code>æŒ‡ä»¤å¯ç”¨ï¼Œä¹Ÿç”¨äºé™åˆ¶é“¾æ¥ç”Ÿå‘½å‘¨æœŸã€‚</p>

<h1 id="1é…ç½®æ¨¡å—">1.é…ç½®æ¨¡å—</h1>

<h4 id="secure_link">secure_link</h4>

<div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Syntax:</span>	<span class="s">secure_link</span> <span class="s">expression</span><span class="p">;</span>
<span class="k">Default:</span> <span class="s">â€”</span>
<span class="s">Context:</span> <span class="s">http,</span> <span class="s">server,</span> <span class="s">location</span>
</code></pre></div></div>

<h4 id="secure_link_md5">secure_link_md5</h4>

<div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Syntax:</span>	<span class="s">secure_link_md5</span> <span class="s">expression</span><span class="p">;</span>
<span class="k">Default:</span> <span class="s">â€”</span>
<span class="s">Context:</span> <span class="s">http,</span> <span class="s">server,</span> <span class="s">location</span>
</code></pre></div></div>

<h4 id="secure_link_secret">secure_link_secret</h4>

<div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Syntax:</span>	<span class="s">secure_link_secret</span> <span class="s">word</span><span class="p">;</span>
<span class="k">Default:</span> <span class="s">â€”</span>
<span class="s">Context:</span> <span class="s">location</span>
</code></pre></div></div>

<h1 id="2éªŒè¯åŸç†">2.éªŒè¯åŸç†</h1>

<p><img src="http://walidream.com:9999/blogImage/nginx/nginx_52.jpg" alt="ssl" /></p>

<p>ç”¨æˆ·åœ¨å®¢æˆ·ç«¯ç‚¹å‡»ä¸‹è½½æŒ‰é’®ï¼ŒæœåŠ¡å™¨æ”¶åˆ°è¯·æ±‚åç”Ÿæˆä¸€ä¸ª<code class="language-plaintext highlighter-rouge">ä¸‹è½½åœ°å€</code>è¿”å›ç»™å®¢æˆ·ç«¯ã€‚å®¢æˆ·ç«¯åœ¨ç”¨è¿™ä¸ªç”Ÿæˆçš„ä¸‹è½½åœ°å€å»è¯·æ±‚èµ„æºï¼Œæ­¤æ—¶nginxå»åšæ ¡éªŒï¼Œæ ¡éªŒé“¾æ¥åœ°å€çœŸä¼ªå’Œé“¾æ¥åœ°å€æ˜¯å¦è¿‡æœŸã€‚å¦‚æœé“¾æ¥åœ°å€æ˜¯çœŸçš„å¹¶ä¸”é“¾æ¥åœ°å€æ²¡æœ‰è¿‡æœŸï¼Œå°±ç»™å®¢æˆ·ç«¯è¿”å›ä¸‹è½½èµ„æºã€‚ï¼ˆnginxéªŒè¯å’ŒæœåŠ¡å™¨ç”Ÿæˆå¯†é’¥è§„åˆ™è¦ä¸€è‡´ï¼Œå¦åˆ™ä¸ä¼šé€šè¿‡çš„ï¼‰</p>

<h1 id="3é…ç½®æ•™ç¨‹">3.é…ç½®æ•™ç¨‹</h1>

<p>æœåŠ¡ç›®å½•</p>

<pre><code class="language-txt">/opt/app
|-code9
   |-md5url.sh
   |-index.html
   |-download
       |-tesla.img
	   
/etc/nginx/conf.d
|-download.conf
</code></pre>

<h4 id="md5urlsh">md5url.sh</h4>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#ç”Ÿæˆä¸€ä¸ªæµ‹è¯•é“¾æ¥è„šæœ¬</span>
<span class="nv">servername</span><span class="o">=</span><span class="s2">"walidream.com"</span>
<span class="nv">download_file</span><span class="o">=</span><span class="s2">"/download/tesla.img"</span>
<span class="nv">time_num</span><span class="o">=</span><span class="si">$(</span><span class="nb">date</span> <span class="nt">-d</span> <span class="s2">"2019-1-10 00:00:00"</span> +%s<span class="si">)</span>
<span class="nv">secret_num</span><span class="o">=</span><span class="s2">"wali"</span>

<span class="nv">res</span><span class="o">=</span><span class="si">$(</span><span class="nb">echo</span> <span class="nt">-n</span> <span class="s2">"</span><span class="k">${</span><span class="nv">time_num</span><span class="k">}${</span><span class="nv">download_file</span><span class="k">}</span><span class="s2"> </span><span class="k">${</span><span class="nv">secret_num</span><span class="k">}</span><span class="s2">"</span>|openssl md5 <span class="nt">-binary</span> | openssl <span class="nb">base64</span> | <span class="nb">tr</span> +/ <span class="nt">-_</span> | <span class="nb">tr</span> <span class="nt">-d</span> <span class="o">=</span><span class="si">)</span>

<span class="nb">echo</span> <span class="s2">"http://</span><span class="k">${</span><span class="nv">servername</span><span class="k">}${</span><span class="nv">download_file</span><span class="k">}</span><span class="s2">?md5=</span><span class="k">${</span><span class="nv">res</span><span class="k">}</span><span class="s2">&amp;expires=</span><span class="k">${</span><span class="nv">time_num</span><span class="k">}</span><span class="s2">"</span>
</code></pre></div></div>

<h4 id="è·å–æµ‹è¯•é“¾æ¥">è·å–æµ‹è¯•é“¾æ¥</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sh /opt/app/code9/md5url.sh
</code></pre></div></div>

<p>è¾“å‡º</p>

<p>http://walidream.com/download/tesla.img?md5=T1gCW3YQNsnWCcJHWWbcPg&amp;expires=154704960</p>

<h4 id="indexhtml">index.html</h4>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!doctype html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
	<span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"UTF-8"</span><span class="nt">&gt;</span>
	<span class="nt">&lt;title&gt;</span>Document<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
	<span class="nt">&lt;h1&gt;</span>æ¬¢è¿æ¥åˆ°ç“¦åŠ›åšå®¢<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<h4 id="downloadconf">download.conf</h4>

<div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">server</span> <span class="p">{</span>
    <span class="kn">listen</span>       <span class="mi">80</span><span class="p">;</span>
    <span class="kn">server_name</span>  <span class="s">localhost</span><span class="p">;</span>

    <span class="c1">#charset koi8-r;</span>
    
    <span class="kn">root</span> <span class="n">/opt/app/code9</span><span class="p">;</span>

    <span class="kn">location</span> <span class="n">/</span> <span class="p">{</span>
        <span class="kn">index</span> <span class="s">index.html</span><span class="p">;</span>
    <span class="p">}</span>
	
    <span class="kn">location</span> <span class="n">/download</span> <span class="p">{</span>
        <span class="kn">secure_link</span> <span class="nv">$arg_md5</span><span class="s">,</span><span class="nv">$arg_expires</span><span class="p">;</span>
        <span class="kn">secure_link_md5</span> <span class="s">"</span><span class="nv">$secure_link_expires$uri</span> <span class="s">wali"</span><span class="p">;</span>
	
        <span class="kn">if</span> <span class="s">(</span><span class="nv">$secure_link</span> <span class="p">=</span> <span class="s">"")</span> <span class="p">{</span>
            <span class="kn">return</span> <span class="mi">403</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="kn">if</span> <span class="s">(</span><span class="nv">$secure_link</span> <span class="p">=</span> <span class="s">"0")</span> <span class="p">{</span>
            <span class="kn">return</span> <span class="mi">410</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>	
</code></pre></div></div>

<p>æ£€æµ‹è¯­æ³•å¹¶é‡å¯</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nginx -tc /etc/nginx/nginx.conf
nginx -s reload -c /etc/nginx/nginx.conf
</code></pre></div></div>

<p>æˆ‘ä»¬åœ¨æµè§ˆå™¨è¾“å…¥<code class="language-plaintext highlighter-rouge">walidream.com</code>ä¼šæ˜¾ç¤ºæ¬¢è¿æ¥åˆ°ç“¦åŠ›åšå®¢ï¼Œå½“è¾“å…¥ä¸Šé¢æµ‹è¯•é“¾æ¥<code class="language-plaintext highlighter-rouge">http://walidream.com/download/tesla.img?md5=T1gCW3YQNsnWCcJHWWbcPg&amp;expires=154704960</code>å°±å¯ä»¥çœ‹åˆ°<code class="language-plaintext highlighter-rouge">tesla.img</code>æ–‡ä»¶åœ¨æµè§ˆå™¨ä¸‹è½½äº†ã€‚</p>

<p>å°†åé¢çš„æ—¶é—´æˆ³éšä¾¿æ”¹å†™å¦‚expires=15470496011ï¼Œå›è½¦ï¼Œå‘ç°ç½‘é¡µå˜ä¸º403</p>

:ET