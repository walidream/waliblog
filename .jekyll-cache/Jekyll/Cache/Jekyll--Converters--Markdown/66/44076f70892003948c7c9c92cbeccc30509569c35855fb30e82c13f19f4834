I")<p>在上小节制定了数据库开发规范后，这小节之后将开始数据库电商项目实战。在电商实战项目中我们一共涉及<code class="language-plaintext highlighter-rouge">用户模块</code>、<code class="language-plaintext highlighter-rouge">商品模块</code>、<code class="language-plaintext highlighter-rouge">订单模块</code>、<code class="language-plaintext highlighter-rouge">仓储模块</code>。本次测试所用的数据库版本<code class="language-plaintext highlighter-rouge">mysql 5.7</code></p>

<p>涉及模块功能：</p>
<ul>
  <li>用户模块：完成用户注册和登录验证</li>
  <li>商品模块：前后台商品浏览和管理</li>
  <li>订单模块：订单及购物车的生成和管理</li>
  <li>仓储模块：仓库库存和物流的管理</li>
</ul>

<p><img src="http://walidream.com:9999/blogImage/sql/sql_13.png" alt="ssl" /></p>

<h1 id="1用户模块属性">1.用户模块属性</h1>

<p>用户模块的属性一般有</p>

<p><img src="http://walidream.com:9999/blogImage/sql/sql_15.png" alt="ssl" /></p>

<p><img src="http://walidream.com:9999/blogImage/sql/sql_14.png" alt="ssl" /></p>

<p>将用户实体所有的属性存放在一张表中，在数据的读取和写入时比较方便，但是也会带来一些问题？</p>

<h4 id="数据插入异常">数据插入异常？</h4>

<p>插入异常：想要插入数据,结构因为表设计的问题,导致不能成功插入。</p>

<p>在上面表中，如果我们想给用户设一个等级，小于100积分(青铜级)，100-200(白银级)，200-300(黄金级),300-400(铂金级),400积分以上(钻石级)。</p>

<pre><code class="language-mysql">insert into 用户名(会员级别) value('青铜级')
</code></pre>
<p>这条sql是会报错，因为用户表中用户名时主键，主键是不能为<code class="language-plaintext highlighter-rouge">NULL</code>，所以插入数据会报错。</p>

<h4 id="数据更新异常">数据更新异常？</h4>

<p>更新异常：要修改某一行的值，不得不修改多行数据</p>

<p>有一天，产品经理说想要把青铜级用户改为<code class="language-plaintext highlighter-rouge">注册会员</code>,需要执行以下sql</p>

<pre><code class="language-mysql">update 用户表 set 等级 = '注册会员' where 等级 = '青铜级'
</code></pre>

<p>本来我们想修改一条数据,将<code class="language-plaintext highlighter-rouge">青铜级</code>改为<code class="language-plaintext highlighter-rouge">注册会员</code>，但是由于表结构的设计，导致要更新用户表中所有的<code class="language-plaintext highlighter-rouge">青铜级</code>。</p>

<h4 id="数据删除异常">数据删除异常？</h4>

<p>数据删除异常：删除某一数据时不得不同时删除另一数据</p>

<p>过了一段时间后，产品进来说不想要<code class="language-plaintext highlighter-rouge">注册会员</code>了，需要执行以下sql</p>

<pre><code class="language-mysql">delelt from 用户表 where 用户等级 = '注册会员';
</code></pre>

<p>本来只想删除用户等级为<code class="language-plaintext highlighter-rouge">注册会员</code>，结果把用户信息也一并删除，如果真这么做了，估计明天就不用去上班了。</p>

<h4 id="数据冗余">数据冗余？</h4>

<p>数据冗余：想修改一个属性,就要更新多行数据</p>

<p>每当我们更新用户等级信息，就必须也要更新用户的积分上限和下限，这样会造成大量的数据冗余问题。</p>

<h1 id="2优化用户表设计">2.优化用户表设计</h1>

<p>设计关系数据库时，遵从不同的规范要求，设计出合理的关系型数据库。目前<code class="language-plaintext highlighter-rouge">关系数据库</code>有六种范式：<code class="language-plaintext highlighter-rouge">第一范式（1NF）</code>、<code class="language-plaintext highlighter-rouge">第二范式（2NF）</code>、<code class="language-plaintext highlighter-rouge">第三范式（3NF）</code>、<code class="language-plaintext highlighter-rouge">巴斯-科德范式（BCNF）</code>、<code class="language-plaintext highlighter-rouge">第四范式(4NF）</code>和<code class="language-plaintext highlighter-rouge">第五范式（5NF）</code>。一般说来，数据库只需满足第三范式(3NF）就基本不会碰到上面遇到的问题。</p>

<p>下面我们就上上面的表拆分下:</p>

<h4 id="用户级别信息表customer_level_inf">用户级别信息表(customer_level_inf):</h4>

<pre><code class="language-txt">会员级别        积分上限        积分下限
</code></pre>

<h4 id="用户登录表customer_login">用户登录表(customer_login):</h4>

<pre><code class="language-txt">登录名      登录密码        登录状态
</code></pre>

<h4 id="用户地址表customer_addr">用户地址表(customer_addr):</h4>

<pre><code class="language-txt">省      市      区      邮编        地址
</code></pre>

<h4 id="用户信息表customer_info">用户信息表(customer_info):</h4>

<pre><code class="language-txt">用户姓名        证件类型        证件号码        手机号      邮箱        性别        积分        注册时间        生日        会员级别        用户余额
</code></pre>

<h1 id="3建表语句">3.建表语句</h1>

<h4 id="用户级别">用户级别</h4>

<pre><code class="language-mysql">CREATE TABLE customer_level_inf(
	customer_level TINYINT NOT NULL AUTO_INCREMENT COMMENT '会员级别ID',
	level_name VARCHAR(10) NOT NULL COMMENT '会员级别名称',
	min_point INT UNSIGNED NOT NULL DEFAULT 0 COMMENT '最低积分',
	max_point INT UNSIGNED NOT NULL DEFAULT 0 COMMENT '最高积分',
	modified_time TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '最后修改时间',
	PRIMARY KEY pk_levelid(customer_level)
)ENGINE=INNODB DEFAULT charset=utf8 COMMENT '用户级别信息表';

</code></pre>

<h4 id="用户登录表">用户登录表</h4>

<pre><code class="language-mysql">CREATE TABLE customer_login(
	customer_id	INT UNSIGNED AUTO_INCREMENT	NOT NULL COMMENT '用户ID',
	login_name VARCHAR(50) NOT NULL COMMENT '用户登录名',
	password CHAR(32) NOT NULL COMMENT '用户登录密码',
	user_stats TINYINT  NOT NULL DEFAULT 1 COMMENT '用户状态,1在线,0离线',
	modified_time TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '最后修改时间',
	PRIMARY KEY pk_customerid(customer_id)
)ENGINE=INNODB DEFAULT charset=utf8 COMMENT '用户登录表';
</code></pre>

<h4 id="用户地址表">用户地址表</h4>

<pre><code class="language-mysql">CREATE TABLE customer_addr(
	customer_add_id INT UNSIGNED AUTO_INCREMENT NOT NULL COMMENT '自增主键ID',
	customer_id INT UNSIGNED NOT NULL COMMENT 'customer_login表的自增ID',
	zip SMALLINT NOT NULL COMMENT '邮编',
	province SMALLINT NOT NULL COMMENT '省',
	city SMALLINT NOT NULL COMMENT '市',
	district SMALLINT NOT NULL COMMENT '区',
	address VARCHAR(200) NOT NULL COMMENT '具体地址',
	is_default TINYINT NOT NULL COMMENT '是否默认',
	modified_time TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '最后修改时间',
	PRIMARY KEY pk_customeraddid (customer_add_id)
)ENGINE=INNODB DEFAULT charset=utf8 COMMENT '用户地址表';
</code></pre>

<h4 id="用户信息表">用户信息表</h4>

<pre><code class="language-mysql">CREATE TABLE customer_inf(
	customer_inf_id INT UNSIGNED AUTO_INCREMENT NOT NULL COMMENT '用户信息ID',
	customer_id  INT UNSIGNED NOT NULL COMMENT 'customer_login表的自增ID',
	customer_name VARCHAR(20) NOT NULL COMMENT '用户真实姓名',
	identity_card_type TINYINT NOT NULL DEFAULT 1 COMMENT '证件类型：1 身份证,2 军官证,3 护照',
	identity_card_no VARCHAR(20) COMMENT '证件号码',
	mobile_phone INT UNSIGNED COMMENT '手机号',
	customer_emial VARCHAR(50) COMMENT '邮箱',
	gender char(1) COMMENT '性别',
	user_point INT NOT NULL DEFAULT 0 COMMENT '用户积分',
	register_time TIMESTAMP NOT NULL COMMENT '注册时间',
	birthday DATETIME COMMENT '会员生日',
	customer_level TINYINT NOT NULL DEFAULT 1 COMMENT '会员级别：1普通会员,2青铜会员,3白银会员,4黄金会员,5钻石会员',
	user_money DECIMAL(8,2) NOT NULL DEFAULT 0.00 COMMENT '用户余额',
	modified_time TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '最后修改时间',
	PRIMARY KEY pk_customerinfif (customer_inf_id)	
)ENGINE=INNODB DEFAULT charset=utf8 COMMENT '用户信息表';
</code></pre>

<h4 id="用户登录日志表">用户登录日志表</h4>

<pre><code class="language-mysql">CREATE TABLE customer_login_log(
	login_id INT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '用户登录日志ID',
	customer_id INT UNSIGNED NOT NULL COMMENT '登录用户ID',
	login_time TIMESTAMP NOT NULL COMMENT '用户登录时间',
	login_ip   INT UNSIGNED NOT NULL COMMENT '用户登录IP',
	login_type TINYINT NOT NULL COMMENT '登录类型：0未成功 1成功',
	PRIMARY KEY pk_loginid (login_id)
)ENGINE=INNODB DEFAULT charset=utf8 COMMENT '用户登录日志表'
</code></pre>

<h4 id="用户积分日志表">用户积分日志表</h4>

<pre><code class="language-mysql">CREATE TABLE customer_point_log(
	point_id INT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '积分日志ID',
	customer_id INT UNSIGNED NOT NULL COMMENT '用户ID',
	source TINYINT UNSIGNED NOT NULL COMMENT '积分来源 0订单，1登录，2活动',
	refer_number INT UNSIGNED NOT NULL DEFAULT 0 COMMENT '积分来源相关编号',
	change_ponit SMALLINT NOT NULL DEFAULT 0 COMMENT '变更积分数',
	create_time TIMESTAMP NOT NULL COMMENT '积分日志生成时间',
	PRIMARY KEY pk_pointid (point_id)
)ENGINE=INNODB DEFAULT charset=utf8 COMMENT '用户积分日志表';
</code></pre>

<h4 id="用户余额变动表">用户余额变动表</h4>

<pre><code class="language-mysql">CREATE TABLE customer_balance_log(
	balance_id INT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '余额日志ID',
	customer_id INT UNSIGNED NOT NULL COMMENT '用户ID',
	source TINYINT UNSIGNED NOT NULL DEFAULT 1 COMMENT '记录来源：1订单 2退货单',
	create_time TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '记录生成时间',
	amount decimal(8,2) NOT NULL DEFAULT 0.00 COMMENT '变动金额',
	PRIMARY KEY pk_balanceid (balance_id)
)ENGINE=INNODB DEFAULT charset=utf8 COMMENT '用户余额变动表';
</code></pre>

:ET