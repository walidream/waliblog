I"Êd<p>æœ¬å°èŠ‚è®²è§£<code class="language-plaintext highlighter-rouge">dictçš„abcç»§æ‰¿å…³ç³»</code>ï¼Œæ ¹æ®ç»§æ‰¿å…³ç³»ï¼Œå¦‚æœæƒ³è¦å®ç°ä¸€ä¸ªdictæ•°æ®ç»“æ„ï¼Œéœ€è¦å®ç°<code class="language-plaintext highlighter-rouge">Mapping</code>ç±»å¯¹åº”çš„é­”æ³•å‡½æ•°ã€‚<code class="language-plaintext highlighter-rouge">dictå­ç±»</code>ä¸­å°†å½“æˆ‘ä»¬éœ€è¦ç»§æ‰¿dictæ—¶å€™ï¼Œä¸åº”è¯¥ç»§æ‰¿pythonåŸç”Ÿdictï¼Œè€Œåº”è¯¥ç»§æ‰¿<code class="language-plaintext highlighter-rouge">collections</code>ä¸‹æä¾›<code class="language-plaintext highlighter-rouge">UserDict</code>ç±»ã€‚æœ€åä»‹ç»dictçš„å®ç°åŸç†ï¼Œå·²ç»dictçš„ä¼˜ç¼ºç‚¹ã€‚</p>

<h1 id="1dictçš„abcç»§æ‰¿å…³ç³»">1.dictçš„abcç»§æ‰¿å…³ç³»</h1>

<p>dictåè®®è¿™é‡Œä¸»è¦æ ¹æ®<code class="language-plaintext highlighter-rouge">abc</code>(æŠ½è±¡åŸºç±»)çš„ç»§æ‰¿å…³ç³»æ¥ç†è§£ã€‚</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">collections.abc</span>

<span class="c1"># abcæ¨¡å—
</span><span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s">"Awaitable"</span><span class="p">,</span> <span class="s">"Coroutine"</span><span class="p">,</span>
           <span class="s">"AsyncIterable"</span><span class="p">,</span> <span class="s">"AsyncIterator"</span><span class="p">,</span> <span class="s">"AsyncGenerator"</span><span class="p">,</span>
           <span class="s">"Hashable"</span><span class="p">,</span> <span class="s">"Iterable"</span><span class="p">,</span> <span class="s">"Iterator"</span><span class="p">,</span> <span class="s">"Generator"</span><span class="p">,</span> <span class="s">"Reversible"</span><span class="p">,</span>
           <span class="s">"Sized"</span><span class="p">,</span> <span class="s">"Container"</span><span class="p">,</span> <span class="s">"Callable"</span><span class="p">,</span> <span class="s">"Collection"</span><span class="p">,</span>
           <span class="s">"Set"</span><span class="p">,</span> <span class="s">"MutableSet"</span><span class="p">,</span>
           <span class="s">"Mapping"</span><span class="p">,</span> <span class="s">"MutableMapping"</span><span class="p">,</span>
           <span class="s">"MappingView"</span><span class="p">,</span> <span class="s">"KeysView"</span><span class="p">,</span> <span class="s">"ItemsView"</span><span class="p">,</span> <span class="s">"ValuesView"</span><span class="p">,</span>
           <span class="s">"Sequence"</span><span class="p">,</span> <span class="s">"MutableSequence"</span><span class="p">,</span>
           <span class="s">"ByteString"</span><span class="p">,</span>
           <span class="p">]</span>
</code></pre></div></div>

<p>collections.abc å·¥å…·ç±»ä¸­æœ‰<code class="language-plaintext highlighter-rouge">Mapping</code>(ä¸å¯å˜Map)å’Œ<code class="language-plaintext highlighter-rouge">MutableMapping</code>(å¯å˜Map)ã€‚dictå±äºMappingç±»å‹ã€‚</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Collection æºç 
</span><span class="k">class</span> <span class="nc">Collection</span><span class="p">(</span><span class="n">Sized</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">Container</span><span class="p">):</span>
    <span class="p">...</span>
    <span class="p">...</span>

<span class="c1"># Mapping æºç 
</span><span class="k">class</span> <span class="nc">Mapping</span><span class="p">(</span><span class="n">Collection</span><span class="p">):</span>

    <span class="n">__slots__</span> <span class="o">=</span> <span class="p">()</span>

    <span class="s">"""A Mapping is a generic container for associating key/value
    pairs.

    This class provides concrete generic implementations of all
    methods except for __getitem__, __iter__, and __len__.

    """</span>

    <span class="o">@</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">raise</span> <span class="nb">KeyError</span>
    <span class="p">...</span>
    <span class="p">...</span>

<span class="c1"># MutableMapping æºç 
</span><span class="k">class</span> <span class="nc">MutableMapping</span><span class="p">(</span><span class="n">Mapping</span><span class="p">):</span>

    <span class="n">__slots__</span> <span class="o">=</span> <span class="p">()</span>

    <span class="s">"""A MutableMapping is a generic container for associating
    key/value pairs.

    This class provides concrete generic implementations of all
    methods except for __getitem__, __setitem__, __delitem__,
    __iter__, and __len__.

    """</span>

    <span class="o">@</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">raise</span> <span class="nb">KeyError</span>

    <span class="o">@</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">raise</span> <span class="nb">KeyError</span>
    <span class="p">...</span>
    <span class="p">...</span>

</code></pre></div></div>
<p>ä»ä¸Šé¢ç±»çš„ç»§æ‰¿å…³ç³»ä¸­ï¼Œ<code class="language-plaintext highlighter-rouge">MutableMapping</code>æ˜¯ç»§æ‰¿<code class="language-plaintext highlighter-rouge">Mapping</code>ç±»,Mappingç±»ç»§æ‰¿<code class="language-plaintext highlighter-rouge">Collection</code>ï¼ŒCollenctionç»§æ‰¿<code class="language-plaintext highlighter-rouge">Sized</code>ã€<code class="language-plaintext highlighter-rouge">Iterable</code>ã€<code class="language-plaintext highlighter-rouge">Container</code>ã€‚Sizedç±»ä¸­ä¸»è¦å®ç°<code class="language-plaintext highlighter-rouge">__len__</code>æ–¹æ³•ï¼ŒIterableç±»ä¸­ä¸»è¦å®ç°<code class="language-plaintext highlighter-rouge">__iter__</code>æ–¹æ³•ï¼ŒContainerç±»ä¸­ä¸»è¦å®ç°<code class="language-plaintext highlighter-rouge">__contains__</code>æ–¹æ³•ã€‚æ‰€ä»¥ä¸€ä¸ªdictå®ä¾‹å¯ä»¥ä½¿ç”¨<code class="language-plaintext highlighter-rouge">len</code>å‡½æ•°è·å–dictå¯¹è±¡çš„é•¿åº¦,ä½¿ç”¨<code class="language-plaintext highlighter-rouge">for in</code>å¯ä»¥éå†dictå¯¹è±¡ï¼Œä½¿ç”¨<code class="language-plaintext highlighter-rouge">in</code>å¯ä»¥åˆ¤æ–­dictå¯¹è±¡ã€‚</p>

<p>MutableMappingç»§æ‰¿äº†Mappingç±»ï¼Œåœ¨MappingåŸºç¡€ä¸Šæ·»åŠ <code class="language-plaintext highlighter-rouge">__setitem__</code>ã€<code class="language-plaintext highlighter-rouge">__delitem__</code>æ–¹æ³•ã€‚</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Mapping</span>

<span class="n">a</span> <span class="o">=</span> <span class="p">{</span><span class="s">'name'</span><span class="p">:</span><span class="s">'å¼ ä¸‰'</span><span class="p">,</span><span class="n">age</span><span class="p">:</span><span class="mi">18</span><span class="p">,</span><span class="n">sex</span><span class="p">:</span><span class="s">'ç”·'</span><span class="p">}</span>

<span class="k">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
<span class="o">&gt;&gt;&gt;</span> <span class="mi">3</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">a</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">'name'</span> <span class="ow">in</span> <span class="n">di</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="bp">True</span>

<span class="c1"># dictå¯¹è±¡å¹¶ä¸æ˜¯ç»§æ‰¿Mappingç±»ï¼Œè€Œæ˜¯å®ç°Mappingç±»ä¸­çš„åè®®
</span><span class="k">print</span><span class="p">(</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">))</span>
<span class="o">&gt;&gt;&gt;</span> <span class="bp">True</span>
</code></pre></div></div>

<h1 id="2dictçš„å­ç±»">2.dictçš„å­ç±»</h1>

<p>pythonä¸­å†…ç½®çš„ä¸€äº›æ•°æ®ç±»å‹æ˜¯ç”±Cè¯­è¨€å†™ï¼Œè¿™æ ·å¯ä»¥æå‡pythonçš„æ•ˆç‡ã€‚å¯¹äºå†…ç½®çš„ä¸€äº›ç±»<code class="language-plaintext highlighter-rouge">dict</code>ã€<code class="language-plaintext highlighter-rouge">list</code>ä¸å»ºè®®ç›´æ¥ç»§æ‰¿è¿™äº›ç±»ã€‚pythonä¸­æœ‰ä¸ª<code class="language-plaintext highlighter-rouge">collections</code>æ¨¡å—ä¸­å¯¹Cå†™çš„å†…ç½®çš„æ•°æ®ç±»å‹ç”¨pythoné‡æ–°å†™äº†ä¸€éï¼Œé€»è¾‘éƒ½æ˜¯ä¸€æ ·çš„ï¼Œå»ºè®®ç»§æ‰¿è¿™äº›é‡æ–°å†™è¿‡çš„ç±»ã€‚</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kn">import</span> <span class="nn">collections</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s">'deque'</span><span class="p">,</span> <span class="s">'defaultdict'</span><span class="p">,</span> <span class="s">'namedtuple'</span><span class="p">,</span> <span class="s">'UserDict'</span><span class="p">,</span> <span class="s">'UserList'</span><span class="p">,</span>
            <span class="s">'UserString'</span><span class="p">,</span> <span class="s">'Counter'</span><span class="p">,</span> <span class="s">'OrderedDict'</span><span class="p">,</span> <span class="s">'ChainMap'</span><span class="p">]</span>
</code></pre></div></div>

<h4 id="ç»§æ‰¿åŸç”Ÿdictæ²¡æœ‰ä½œç”¨">ç»§æ‰¿åŸç”ŸDictæ²¡æœ‰ä½œç”¨</h4>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Mydict</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">().</span><span class="n">__setitem__</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>

<span class="n">mydict</span> <span class="o">=</span> <span class="n">Mydict</span><span class="p">()</span>
<span class="n">mydict</span><span class="p">[</span><span class="s">'age'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>

<span class="k">print</span><span class="p">(</span><span class="n">mydict</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="ç»§æ‰¿userdict">ç»§æ‰¿UserDict</h4>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">UserDict</span>

<span class="k">class</span> <span class="nc">Mydict</span><span class="p">(</span><span class="n">UserDict</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">().</span><span class="n">__setitem__</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>

<span class="n">mydict</span> <span class="o">=</span> <span class="n">Mydict</span><span class="p">()</span>
<span class="n">mydict</span><span class="p">[</span><span class="s">'age'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>

<span class="k">print</span><span class="p">(</span><span class="n">mydict</span><span class="p">)</span>
</code></pre></div></div>

<h1 id="3dictå®ç°åŸç†">3.dictå®ç°åŸç†</h1>

<p><a href="https://foofish.net/python_dict_implements.html" title="https://foofish.net/python_dict_implements.html">åŸæ–‡ Pythonå­—å…¸å¯¹è±¡å®ç°åŸç†</a></p>

<p><a href="https://github.com/liyaopinner/AdvancePython_resource" title="https://github.com/liyaopinner/AdvancePython_resource">python dictå’Œlistæ€§èƒ½æµ‹è¯•</a></p>

<p>ä¸Šé¢dictå’Œlistæ€§èƒ½æµ‹è¯•å¾—å‡ºä¸‹é¢ç»“è®ºï¼š</p>
<ul>
  <li>dictæŸ¥æ‰¾æ•°æ®æ€§èƒ½è¿œè¿œå¤§äºlist</li>
  <li>åœ¨listä¸­éšç€listæ•°æ®å¢å¤§ æŸ¥æ‰¾æ—¶é—´ä¹Ÿä¼šå¢å¤§</li>
  <li>åœ¨dictä¸­æŸ¥æ‰¾å…ƒç´ ä¸ä¼šéšç€dictçš„å¢å¤§è€Œå¢å¤§</li>
</ul>

<h4 id="å“ˆå¸Œè¡¨-hash-tables">å“ˆå¸Œè¡¨ (HASH TABLES)</h4>

<p>å“ˆå¸Œè¡¨ï¼ˆä¹Ÿå«æ•£åˆ—è¡¨ï¼‰ï¼Œæ ¹æ®å…³é”®å€¼å¯¹(Key-value)è€Œç›´æ¥è¿›è¡Œè®¿é—®çš„æ•°æ®ç»“æ„ã€‚å®ƒé€šè¿‡æŠŠkeyå’Œvalueæ˜ å°„åˆ°è¡¨ä¸­ä¸€ä¸ªä½ç½®æ¥è®¿é—®è®°å½•ï¼Œè¿™ç§æŸ¥è¯¢é€Ÿåº¦éå¸¸å¿«ï¼Œæ›´æ–°ä¹Ÿå¿«ã€‚è€Œè¿™ä¸ªæ˜ å°„å‡½æ•°å«åšå“ˆå¸Œå‡½æ•°ï¼Œå­˜æ”¾å€¼çš„æ•°ç»„å«åšå“ˆå¸Œè¡¨ã€‚ å“ˆå¸Œå‡½æ•°çš„å®ç°æ–¹å¼å†³å®šäº†å“ˆå¸Œè¡¨çš„æœç´¢æ•ˆç‡ã€‚å…·ä½“æ“ä½œè¿‡ç¨‹æ˜¯ï¼š</p>

<p>æ•°æ®æ·»åŠ ï¼šæŠŠkeyé€šè¿‡å“ˆå¸Œå‡½æ•°è½¬æ¢æˆä¸€ä¸ªæ•´å‹æ•°å­—ï¼Œç„¶åå°±å°†è¯¥æ•°å­—å¯¹æ•°ç»„é•¿åº¦è¿›è¡Œå–ä½™ï¼Œå–ä½™ç»“æœå°±å½“ä½œæ•°ç»„çš„ä¸‹æ ‡ï¼Œå°†valueå­˜å‚¨åœ¨ä»¥è¯¥æ•°å­—ä¸ºä¸‹æ ‡çš„æ•°ç»„ç©ºé—´é‡Œã€‚
æ•°æ®æŸ¥è¯¢ï¼šå†æ¬¡ä½¿ç”¨å“ˆå¸Œå‡½æ•°å°†keyè½¬æ¢ä¸ºå¯¹åº”çš„æ•°ç»„ä¸‹æ ‡ï¼Œå¹¶å®šä½åˆ°æ•°ç»„çš„ä½ç½®è·å–valueã€‚
ä½†æ˜¯ï¼Œå¯¹keyè¿›è¡Œhashçš„æ—¶å€™ï¼Œä¸åŒçš„keyå¯èƒ½hashå‡ºæ¥çš„ç»“æœæ˜¯ä¸€æ ·çš„ï¼Œå°¤å…¶æ˜¯æ•°æ®é‡å¢å¤šçš„æ—¶å€™ï¼Œè¿™ä¸ªé—®é¢˜å«åšå“ˆå¸Œå†²çªã€‚å¦‚æœè§£å†³è¿™ç§å†²çªæƒ…å†µå‘¢ï¼Ÿé€šå¸¸çš„åšæ³•æœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯é“¾æ¥æ³•ï¼Œå¦ä¸€ç§æ˜¯å¼€æ”¾å¯»å€æ³•ï¼ŒPythoné€‰æ‹©åè€…ã€‚</p>

<h4 id="å¼€æ”¾å¯»å€æ³•open-addressing">å¼€æ”¾å¯»å€æ³•ï¼ˆOPEN ADDRESSINGï¼‰</h4>

<p>å¼€æ”¾å¯»å€æ³•ä¸­ï¼Œæ‰€æœ‰çš„å…ƒç´ éƒ½å­˜æ”¾åœ¨æ•£åˆ—è¡¨é‡Œï¼Œå½“äº§ç”Ÿå“ˆå¸Œå†²çªæ—¶ï¼Œé€šè¿‡ä¸€ä¸ªæ¢æµ‹å‡½æ•°è®¡ç®—å‡ºä¸‹ä¸€ä¸ªå€™é€‰ä½ç½®ï¼Œå¦‚æœä¸‹ä¸€ä¸ªè·é€‰ä½ç½®è¿˜æ˜¯æœ‰å†²çªï¼Œé‚£ä¹ˆä¸æ–­é€šè¿‡æ¢æµ‹å‡½æ•°å¾€ä¸‹æ‰¾ï¼Œç›´åˆ°æ‰¾ä¸ªä¸€ä¸ªç©ºæ§½æ¥å­˜æ”¾å¾…æ’å…¥å…ƒç´ ã€‚</p>

<h4 id="pydictentry">PYDICTENTRY</h4>

<p>å­—å…¸ä¸­çš„ä¸€ä¸ªkey-valueé”®å€¼å¯¹å…ƒç´ ç§°ä¸ºentryï¼ˆä¹Ÿå«åšslotsï¼‰ï¼Œå¯¹åº”åˆ°Pythonå†…éƒ¨æ˜¯PyDictEntryï¼ŒPyDictObjectå°±æ˜¯PyDictEntryçš„é›†åˆã€‚PyDictEntryçš„å®šä¹‰æ˜¯ï¼š</p>

<pre><code class="language-txt">typedef struct {
    /* Cached hash code of me_key.  Note that hash codes are C longs.
     * We have to use Py_ssize_t instead because dict_popitem() abuses
     * me_hash to hold a search finger.
     */
    Py_ssize_t me_hash;
    PyObject *me_key;
    PyObject *me_value;
} PyDictEntry;
</code></pre>
<p>me_hashç”¨äºç¼“å­˜me_keyçš„å“ˆå¸Œå€¼ï¼Œé˜²æ­¢æ¯æ¬¡æŸ¥è¯¢æ—¶éƒ½è¦è®¡ç®—å“ˆå¸Œå€¼ï¼Œentryæœ‰ä¸‰ç§çŠ¶æ€ã€‚</p>
<ol>
  <li>Unusedï¼š me_key == me_value == NULL; Unusedæ˜¯entryçš„åˆå§‹çŠ¶æ€ï¼Œkeyå’Œvalueéƒ½ä¸ºNULLã€‚æ’å…¥å…ƒç´ æ—¶ï¼ŒUnusedçŠ¶æ€è½¬æ¢æˆActiveçŠ¶æ€ã€‚è¿™æ˜¯me_keyä¸ºNULLçš„å”¯ä¸€æƒ…å†µã€‚</li>
  <li>Activeï¼š me_key != NULL and me_key != dummy ä¸” me_value != NULL; æ’å…¥å…ƒç´ åï¼Œentryå°±æˆäº†ActiveçŠ¶æ€ï¼Œè¿™æ˜¯me_valueå”¯ä¸€ä¸ä¸ºNULLçš„æƒ…å†µï¼Œåˆ é™¤å…ƒç´ æ—¶ActiveçŠ¶æ€åˆ»è½¬æ¢æˆDummyçŠ¶æ€ã€‚</li>
  <li>Dummyï¼š me_key == dummy ä¸” me_value == NULL; æ­¤å¤„çš„dummyå¯¹è±¡å®é™…ä¸Šä¸€ä¸ªPyStringObjectå¯¹è±¡ï¼Œä»…ä½œä¸ºæŒ‡ç¤ºæ ‡å¿—ã€‚DummyçŠ¶æ€çš„å…ƒç´ å¯ä»¥åœ¨æ’å…¥å…ƒç´ çš„æ—¶å€™å°†å®ƒå˜æˆActiveçŠ¶æ€ï¼Œä½†å®ƒä¸å¯èƒ½å†å˜æˆUnusedçŠ¶æ€ã€‚</li>
</ol>

<p>ä¸ºä»€ä¹ˆentryæœ‰DummyçŠ¶æ€å‘¢ï¼Ÿè¿™æ˜¯å› ä¸ºé‡‡ç”¨å¼€æ”¾å¯»å€æ³•ä¸­ï¼Œé‡åˆ°å“ˆå¸Œå†²çªæ—¶ä¼šæ‰¾åˆ°ä¸‹ä¸€ä¸ªåˆé€‚çš„ä½ç½®ï¼Œä¾‹å¦‚æŸå…ƒç´ ç»è¿‡å“ˆå¸Œè®¡ç®—åº”è¯¥æ’å…¥åˆ°Aå¤„ï¼Œä½†æ˜¯æ­¤æ—¶Aå¤„æœ‰å…ƒç´ çš„ï¼Œé€šè¿‡æ¢æµ‹å‡½æ•°è®¡ç®—å¾—åˆ°ä¸‹ä¸€ä¸ªä½ç½®Bï¼Œä»ç„¶æœ‰å…ƒç´ ï¼Œç›´åˆ°æ‰¾åˆ°ä½ç½®Cä¸ºæ­¢ï¼Œæ­¤æ—¶ABCæ„æˆäº†æ¢æµ‹é“¾ï¼ŒæŸ¥æ‰¾å…ƒç´ æ—¶å¦‚æœhashå€¼ç›¸åŒï¼Œé‚£ä¹ˆä¹Ÿæ˜¯é¡ºç€è¿™æ¡æ¢æµ‹é“¾ä¸æ–­å¾€åæ‰¾ï¼Œå½“åˆ é™¤æ¢æµ‹é“¾ä¸­çš„æŸä¸ªå…ƒç´ æ—¶ï¼Œæ¯”å¦‚Bï¼Œå¦‚æœç›´æ¥æŠŠBä»å“ˆå¸Œè¡¨ä¸­ç§»é™¤ï¼Œå³å˜æˆUnusedçŠ¶æ€ï¼Œé‚£ä¹ˆCå°±ä¸å¯èƒ½å†æ‰¾åˆ°äº†ï¼Œå› ä¸ºACä¹‹é—´å‡ºç°äº†æ–­è£‚çš„ç°è±¡ï¼Œæ­£æ˜¯å¦‚æ­¤æ‰å‡ºç°äº†ç¬¬ä¸‰ç§çŠ¶æ€â€”Dummyï¼ŒDummyæ˜¯ä¸€ç§ç±»ä¼¼çš„ä¼ªåˆ é™¤æ–¹å¼ï¼Œä¿è¯æ¢æµ‹é“¾çš„è¿ç»­æ€§ã€‚</p>

<p><img src="http://walidream.com:9999/blogImage/python/python_67.png" alt="ssl" /></p>

<h4 id="pydictobject">PYDICTOBJECT</h4>

<p>PyDictObjectå°±æ˜¯PyDictEntryå¯¹è±¡çš„é›†åˆï¼ŒPyDictObjectçš„ç»“æ„æ˜¯ï¼š</p>

<pre><code class="language-txt">typedef struct _dictobject PyDictObject;
struct _dictobject {
    PyObject_HEAD
    Py_ssize_t ma_fill;  /* # Active + # Dummy */
    Py_ssize_t ma_used;  /* # Active */

    /* The table contains ma_mask + 1 slots, and that's a power of 2.
     * We store the mask instead of the size because the mask is more
     * frequently needed.
     */
    Py_ssize_t ma_mask;

    /* ma_table points to ma_smalltable for small tables, else to
     * additional malloc'ed memory.  ma_table is never NULL!  This rule
     * saves repeated runtime null-tests in the workhorse getitem and
     * setitem calls.
     */
    PyDictEntry *ma_table;
    PyDictEntry *(*ma_lookup)(PyDictObject *mp, PyObject *key, long hash);
    PyDictEntry ma_smalltable[PyDict_MINSIZE];
};
</code></pre>

<p>å˜é‡å«ä¹‰:</p>
<ul>
  <li>ma_fill ï¼šæ‰€æœ‰å¤„äºActiveä»¥åŠDummyçš„å…ƒç´ ä¸ªæ•°</li>
  <li>ma_used ï¼šæ‰€æœ‰å¤„äºActiveçŠ¶æ€çš„å…ƒç´ ä¸ªæ•°</li>
  <li>ma_mask ï¼šæ‰€æœ‰entryçš„å…ƒç´ ä¸ªæ•°ï¼ˆActive+Dummy+Unusedï¼‰</li>
  <li>ma_smalltableï¼šåˆ›å»ºå­—å…¸å¯¹è±¡æ—¶ï¼Œä¸€å®šä¼šåˆ›å»ºä¸€ä¸ªå¤§å°ä¸ºPyDict_MINSIZE==8çš„PyDictEntryæ•°ç»„ã€‚</li>
  <li>ma_tableï¼šå½“entryæ•°é‡å°äºPyDict_MINSIZEï¼Œma_tableæŒ‡å‘ma_smalltableçš„é¦–åœ°å€ï¼Œå½“entryæ•°é‡å¤§äº8æ—¶ï¼ŒPythonæŠŠå®ƒå½“åšä¸€ä¸ªå¤§å­—å…¸æ¥å¤„ç†ï¼Œæ­¤åˆ»ä¼šç”³è¯·é¢å¤–çš„å†…å­˜ç©ºé—´ï¼ŒåŒæ—¶å°†ma_tableæŒ‡å‘è¿™å—ç©ºé—´ã€‚</li>
  <li>ma_lookupï¼šå­—å…¸å…ƒç´ çš„æœç´¢ç­–ç•¥</li>
</ul>

<p>PyDictObjectä½¿ç”¨PyObject_HEADè€Œä¸æ˜¯PyObject_Var_HEADï¼Œè™½ç„¶å­—å…¸ä¹Ÿæ˜¯å˜é•¿å¯¹è±¡ï¼Œä½†æ­¤å¤„å¹¶ä¸æ˜¯é€šè¿‡ob_sizeæ¥å­˜å‚¨å­—å…¸ä¸­å…ƒç´ çš„é•¿åº¦ï¼Œè€Œæ˜¯é€šè¿‡ma_usedå­—æ®µã€‚</p>

<h4 id="pydictobjectçš„åˆ›å»ºè¿‡ç¨‹">PYDICTOBJECTçš„åˆ›å»ºè¿‡ç¨‹</h4>

<pre><code class="language-txt">PyObject *
PyDict_New(void)
{
    register PyDictObject *mp;
    if (dummy == NULL) { /* Auto-initialize dummy */
        dummy = PyString_FromString("&lt;dummy key&gt;");
        if (dummy == NULL)
            return NULL;
    }
    if (numfree) {
        mp = free_list[--numfree];
        assert (mp != NULL);
        assert (Py_TYPE(mp) == &amp;PyDict_Type);
        _Py_NewReference((PyObject *)mp);
        if (mp-&gt;ma_fill) {
            EMPTY_TO_MINSIZE(mp);
        } else {
            /* At least set ma_table and ma_mask; these are wrong
               if an empty but presized dict is added to freelist */
            INIT_NONZERO_DICT_SLOTS(mp);
        }
        assert (mp-&gt;ma_used == 0);
        assert (mp-&gt;ma_table == mp-&gt;ma_smalltable);
        assert (mp-&gt;ma_mask == PyDict_MINSIZE - 1);
    } else {
        mp = PyObject_GC_New(PyDictObject, &amp;PyDict_Type);
        if (mp == NULL)
            return NULL;
        EMPTY_TO_MINSIZE(mp);
    }
    mp-&gt;ma_lookup = lookdict_string;
    return (PyObject *)mp;
}
</code></pre>

<p>æ­¥éª¤ï¼š</p>
<ol>
  <li>åˆå§‹åŒ–dummyå¯¹è±¡</li>
  <li>å¦‚æœç¼“å†²æ± è¿˜æœ‰å¯ç”¨çš„å¯¹è±¡ï¼Œåˆ™ä»ç¼“å†²æ± ä¸­è¯»å–ï¼Œå¦åˆ™ï¼Œæ‰§è¡Œæ­¥éª¤3</li>
  <li>åˆ†é…å†…å­˜ç©ºé—´ï¼Œåˆ›å»ºPyDictObjectå¯¹è±¡ï¼Œåˆå§‹åŒ–å¯¹è±¡</li>
  <li>æŒ‡å®šæ·»åŠ å­—å…¸å…ƒç´ æ—¶çš„æ¢æµ‹å‡½æ•°ï¼Œå…ƒç´ çš„æœç´¢ç­–ç•¥</li>
</ol>

<h4 id="å­—å…¸æœç´¢ç­–ç•¥">å­—å…¸æœç´¢ç­–ç•¥</h4>

<pre><code class="language-txt">static PyDictEntry *
lookdict(PyDictObject *mp, PyObject *key, register long hash)
{
    register size_t i;
    register size_t perturb;
    register PyDictEntry *freeslot;
    register size_t mask = (size_t)mp-&gt;ma_mask;
    PyDictEntry *ep0 = mp-&gt;ma_table;
    register PyDictEntry *ep;
    register int cmp;
    PyObject *startkey;

    i = (size_t)hash &amp; mask;
    ep = &amp;ep0[i];
    if (ep-&gt;me_key == NULL || ep-&gt;me_key == key)
        return ep;

    if (ep-&gt;me_key == dummy)
        freeslot = ep;
    else {
        if (ep-&gt;me_hash == hash) {
            startkey = ep-&gt;me_key;
            Py_INCREF(startkey);
            cmp = PyObject_RichCompareBool(startkey, key, Py_EQ);
            Py_DECREF(startkey);
            if (cmp &lt; 0)
                return NULL;
            if (ep0 == mp-&gt;ma_table &amp;&amp; ep-&gt;me_key == startkey) {
                if (cmp &gt; 0)
                    return ep;
            }
            else {
                /* The compare did major nasty stuff to the
                 * dict:  start over.
                 * XXX A clever adversary could prevent this
                 * XXX from terminating.
                 */
                return lookdict(mp, key, hash);
            }
        }
        freeslot = NULL;
    }

    /* In the loop, me_key == dummy is by far (factor of 100s) the
       least likely outcome, so test for that last. */
    for (perturb = hash; ; perturb &gt;&gt;= PERTURB_SHIFT) {
        i = (i &lt;&lt; 2) + i + perturb + 1;
        ep = &amp;ep0[i &amp; mask];
        if (ep-&gt;me_key == NULL)
            return freeslot == NULL ? ep : freeslot;
        if (ep-&gt;me_key == key)
            return ep;
        if (ep-&gt;me_hash == hash &amp;&amp; ep-&gt;me_key != dummy) {
            startkey = ep-&gt;me_key;
            Py_INCREF(startkey);
            cmp = PyObject_RichCompareBool(startkey, key, Py_EQ);
            Py_DECREF(startkey);
            if (cmp &lt; 0)
                return NULL;
            if (ep0 == mp-&gt;ma_table &amp;&amp; ep-&gt;me_key == startkey) {
                if (cmp &gt; 0)
                    return ep;
            }
            else {
                /* The compare did major nasty stuff to the
                 * dict:  start over.
                 * XXX A clever adversary could prevent this
                 * XXX from terminating.
                 */
                return lookdict(mp, key, hash);
            }
        }
        else if (ep-&gt;me_key == dummy &amp;&amp; freeslot == NULL)
            freeslot = ep;
    }
    assert(0);          /* NOT REACHED */
    return 0;
}
</code></pre>

<p>å­—å…¸åœ¨æ·»åŠ å…ƒç´ å’ŒæŸ¥è¯¢å…ƒç´ æ—¶ï¼Œéƒ½éœ€è¦ç”¨åˆ°å­—å…¸çš„æœç´¢ç­–ç•¥ï¼Œæœç´¢æ—¶ï¼Œå¦‚æœä¸å­˜åœ¨è¯¥keyï¼Œé‚£ä¹ˆè¿”å›UnusedçŠ¶æ€çš„entryï¼Œå¦‚æœå­˜åœ¨è¯¥keyï¼Œä½†æ˜¯keyæ˜¯ä¸€ä¸ªDummyå¯¹è±¡ï¼Œé‚£ä¹ˆè¿”å›DummyçŠ¶æ€çš„entryï¼Œå…¶ä»–æƒ…å†µå°±è¡¨ç¤ºå­˜åœ¨ActiveçŠ¶æ€çš„entryï¼Œé‚£ä¹ˆå¯¹äºå­—å…¸çš„æ’å…¥æ“ä½œï¼Œé’ˆå¯¹ä¸åŒçš„æƒ…å†µè¿›è¡Œæ“ä½œä¹Ÿä¸ä¸€æ ·ã€‚å¯¹äºActiveçš„entryï¼Œç›´æ¥æ›¿æ¢me_valueå€¼å³å¯ï¼›å¯¹äºUnusedæˆ–Dummyçš„entryï¼Œéœ€è¦åŒæ—¶è®¾ç½®me_keyï¼Œme_hashå’Œme_value</p>

<h4 id="pydictobjectå¯¹è±¡ç¼“å†²æ± ">PYDICTOBJECTå¯¹è±¡ç¼“å†²æ± </h4>

<p>PyDictObjectå¯¹è±¡ç¼“å†²æ± å’ŒPyListObjectå¯¹è±¡ç¼“å†²æ± çš„åŸç†æ˜¯ç±»ä¼¼çš„ï¼Œéƒ½æ˜¯åœ¨å¯¹è±¡è¢«é”€æ¯çš„æ—¶å€™æŠŠè¯¥å¯¹è±¡æ·»åŠ åˆ°ç¼“å†²æ± ä¸­å»ï¼Œè€Œä¸”å€¼ä¿ç•™PyDictObjectå¯¹è±¡æœ¬èº«ï¼Œå¦‚æœma_tableç»´æŠ¤çš„æ—¶ä»ç³»ç»Ÿå †ä¸­ç”³è¯·çš„ç©ºé—´ï¼Œé‚£ä¹ˆPythonä¼šé‡Šæ”¾è¿™å—å†…å­˜ï¼Œå¦‚æœma_tableç»´æŠ¤çš„æ˜¯ma_smalltableï¼Œé‚£ä¹ˆåªéœ€æŠŠsmalltableä¸­çš„å…ƒç´ çš„å¼•ç”¨è®¡æ•°å‡å°‘å³å¯ã€‚</p>

<pre><code class="language-txt">static void
dict_dealloc(register PyDictObject *mp)
{
    register PyDictEntry *ep;
    Py_ssize_t fill = mp-&gt;ma_fill;
    PyObject_GC_UnTrack(mp);
    Py_TRASHCAN_SAFE_BEGIN(mp)
    for (ep = mp-&gt;ma_table; fill &gt; 0; ep++) {
        if (ep-&gt;me_key) {
            --fill;
            Py_DECREF(ep-&gt;me_key);
            Py_XDECREF(ep-&gt;me_value);
        }
    }
    if (mp-&gt;ma_table != mp-&gt;ma_smalltable)
        PyMem_DEL(mp-&gt;ma_table);
    if (numfree &lt; PyDict_MAXFREELIST &amp;&amp; Py_TYPE(mp) == &amp;PyDict_Type)
        free_list[numfree++] = mp;
    else
        Py_TYPE(mp)-&gt;tp_free((PyObject *)mp);
    Py_TRASHCAN_SAFE_END(mp)
}
</code></pre>

<p><img src="http://walidream.com:9999/blogImage/python/python_68.png" alt="ssl" /></p>

<p>dictæ•°æ®ä½¿ç”¨hashè¡¨è¿›è¡Œå­˜å‚¨ï¼Œé€šè¿‡æŠŠkeyå’Œvalueæ˜ å°„åˆ°è¡¨ä¸­çš„ä¸€ä¸ªä½ç½®æ¥è®¿é—®è®°å½•ã€‚å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå°†dictä¸­çš„keyå’Œvalueå…¨éƒ¨æ˜ å°„åˆ°ä¸€å—è¿ç»­çš„å†…å­˜ç©ºé—´ä¸­ï¼Œæ˜ å°„çš„å‡½æ•°å«åšå“ˆå¸Œå‡½æ•°ï¼Œå­˜æ”¾å€¼çš„æ•°ç»„å«åšå“ˆå¸Œè¡¨ã€‚è¿™ç§æŸ¥è¯¢çš„æ–¹å¼é€Ÿåº¦ä¼šéå¸¸å¿«ï¼Œæ›´æ–°ä¹Ÿå¿«ã€‚è¿™ä¹Ÿå°±æ˜¯dictæ•°æ®ç»“æ„æ¯”listæ•°æ®ç»“æ„åœ¨åšæŸ¥è¯¢æ—¶å¿«çš„åŸå› ã€‚</p>

<p><img src="http://walidream.com:9999/blogImage/python/python_69.png" alt="ssl" /></p>

<p>é€šè¿‡å­¦ä¹ ä¸Šé¢çŸ¥è¯†ï¼Œæˆ‘ä»¬çŸ¥é“dictç‰¹ç‚¹ï¼š</p>
<ul>
  <li>dictçš„keyå¿…é¡»å¯ä»¥hashçš„å€¼(ä¸å¯æ”¹å˜å¯¹è±¡)ï¼Œä¹Ÿå°±è§£é‡Šäº†strã€fronzensetã€tupleæ•°æ®éƒ½å¯ä»¥ä½œä¸ºkeyæ¥ä½¿ç”¨ã€‚</li>
  <li>dictçš„å†…å­˜èŠ±é”€å¤§ï¼Œä½†æ˜¯æŸ¥è¯¢é€Ÿåº¦å¿«ã€‚listæŸ¥æ‰¾éœ€è¦éå†,è€ŒdictæŸ¥æ‰¾ç›´æ¥æ‰¾hashå€¼</li>
  <li>dictæ˜¯æ— åºçš„ï¼Œæ·»åŠ æ•°æ®æˆ–æ›´æ–°æ•°æ®æ˜¯ï¼Œå½“hashå‡½æ•°è®¡ç®—çš„åç§»é‡å‘ç”Ÿæ”¹å˜æ—¶ï¼Œå­˜å‚¨çš„æ•°æ®ä¹Ÿä¼šå‘ç”Ÿæ”¹å˜</li>
</ul>

:ET